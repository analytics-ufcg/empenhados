---
title: "Detalhes Sobre Fornecedores Careiros"
author: "Laboratório Analytics"
date: "March 15, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE, 
                      warning = FALSE)
```

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
library(DT)
```

```{r}
set.seed(123)

n_fornecedores_observados <- 20

fornecedor_ncm_compradores <- read_csv("../../analises-interativas/shinyapps/dados/fornecedor_ncm_compradores.csv", 
                                       locale=locale(encoding="latin1"), col_types = "c??????") %>%
  mutate(NCM_prod = ifelse(nchar(NCM_prod) == 8, NCM_prod, str_c("0",NCM_prod)))

fornecedores_ncms <- read_csv("../../analises-interativas/shinyapps/dados/fornecedores_ncms.csv", 
                              locale=locale(encoding="latin1"), col_types = "??c???") %>%
  mutate(NCM_prod = ifelse(nchar(NCM_prod) == 8, NCM_prod, str_c("0",NCM_prod)))

metrica_careiros <- read_csv("../../analises-interativas/shinyapps/dados/metrica_careiros.csv", 
                             locale=locale(encoding="latin1"))

metrica_careiros_comp <- read_csv("../../analises-interativas/shinyapps/dados/metrica_careiros_comp.csv", 
                                  locale=locale(encoding="latin1"))

ceis <- read.csv("../../utils/dados/20180312_CEIS.csv", sep = ";", encoding = "latin1", 
                 colClasses = c(CPF.ou.CNPJ.do.Sancionado = "character")) %>%
  select(CNPJ = CPF.ou.CNPJ.do.Sancionado)

notas <-  src_mysql('notas_fiscais', 
                    group='ministerio-publico',
                    user="empenhados", 
                    password=NULL)

ncm <- tbl(notas, "ncm") %>%
  collect(n = Inf) %>%
  mutate(NCM = ifelse(nchar(NCM) == 8, NCM, str_c("0",NCM)))

# Dados de CNPJ - Nome 
cnpj_nome <- tbl(notas, "nota_fiscal") %>% 
  distinct(CPF_CNPJ_emit, CPF_CNPJ_dest, Nome_razao_social_emit, Nome_razao_social_dest) %>% 
  collect(n = Inf) %>% 
  
  group_by(CPF_CNPJ_emit, CPF_CNPJ_dest) %>% 
  summarise(Nome_razao_social_emit = first(Nome_razao_social_emit), 
            Nome_razao_social_dest = first(Nome_razao_social_dest)) %>% 
  ungroup()

#NCMs onde os fornecedores mais atuam
compras_fornecedor_ncm <- tbl(notas, "nota_fiscal") %>%
  group_by(CPF_CNPJ_emit, NCM_prod) %>%
  
  summarise(Total_NCM = n()) %>%
  collect(n = Inf) %>%
  ungroup() %>% 
  
  left_join(ncm %>% select(NCM, Descricao_NCM = Descricao), by = c("NCM_prod" = "NCM")) %>%
  
  sample_n(nrow(.)) %>% 
  group_by(CPF_CNPJ_emit) %>% 
  top_n(3, Total_NCM) %>%
  ungroup() %>% 
  
  arrange(CPF_CNPJ_emit, desc(Total_NCM)) %>%
  group_by(CPF_CNPJ_emit) %>%
  slice(1) %>%
  select(-NCM_prod)

ncm_wide <- compras_fornecedor_ncm %>%
  select(-Total_NCM) %>%
  tibble::rowid_to_column() %>%
  mutate(Posicao = "NCM_Frequente") %>% 
  select(-rowid) %>% 
  spread(Posicao, Descricao_NCM) %>%
  ungroup() %>%
  rename(CNPJ = CPF_CNPJ_emit)

total_ncm_wide <- compras_fornecedor_ncm %>%
  select(-Descricao_NCM) %>%
  tibble::rowid_to_column() %>%
  mutate(Posicao = "Total_NCM_Frequente") %>% 
  select(-rowid) %>% 
  spread(Posicao, Total_NCM) %>%
  ungroup() %>%
  rename(CNPJ = CPF_CNPJ_emit)

#Total de NCMs onde o fornecedor atua
total_ncms <- tbl(notas, "nota_fiscal") %>%
  group_by(CPF_CNPJ_emit) %>%
  summarise(NCMs_Atuacao = n_distinct(NCM_prod)) %>%
  collect(n = Inf) %>%
  rename(CNPJ = CPF_CNPJ_emit)

#NCMs de maior atipicidade para os fornecedores
ncm_maior_atipicidade <- fornecedores_ncms %>%
  
  sample_n(nrow(.)) %>% 
  group_by(CNPJ) %>%
  top_n(1, Atipicidade) %>%
  select(CNPJ, NCM_Atipicidade_Maxima = NCM_prod) %>%
  ungroup() %>%
  
  group_by(CNPJ) %>% 
  slice(1) %>% 
  ungroup() %>% 
  
  left_join(
    ncm %>%
      select(NCM_Atipicidade_Maxima = NCM, 
             NCM_Atipicidade_Maxima_Desc = Descricao)
  ) 
```

```{r}
set.seed(123)

dados_fornecedores <- fornecedores_ncms %>%
  distinct(CNPJ, Razao_Social, Atipicidade_media)

dados_fornecedores <- dados_fornecedores %>%
  left_join(
    fornecedores_ncms %>%
    group_by(CNPJ) %>%
    summarise(Atipicidade_total = sum(Atipicidade))
  )

dados_fornecedores <- dados_fornecedores %>%
  left_join(
    fornecedores_ncms %>%
      group_by(CNPJ) %>%
      summarise(Atipicidade_maxima = max(Atipicidade))
  )

dados_fornecedores <- dados_fornecedores %>%
  left_join(total_ncms)

dados_fornecedores <- dados_fornecedores %>%
  mutate(CNPJ_temp = str_replace_all(CNPJ, "[-/.]", "")) %>%
  mutate(Presente_CEIS = ifelse(CNPJ_temp %in% ceis$CNPJ, 1, 0)) %>%
  mutate(Presente_CEIS = factor(Presente_CEIS, levels = c(0,1), labels = c("Não", "Sim")))

dados_fornecedores <- dados_fornecedores %>%
  left_join(ceis, by = c("CNPJ_temp" = "CNPJ"))

dados_fornecedores <- dados_fornecedores %>%
 left_join(ncm_maior_atipicidade)

dados_fornecedores <- dados_fornecedores %>%
  left_join(ncm_wide) %>%
  left_join(total_ncm_wide) %>%
  select(-CNPJ_temp) %>%
  rename(CPF_CNPJ_emit = CNPJ)

dados_fornecedores <- dados_fornecedores %>%
  arrange(desc(Atipicidade_media)) %>%
  head(n_fornecedores_observados)

dados_fornecedores <- dados_fornecedores %>%
  select(CPF_CNPJ_emit = CPF_CNPJ_emit, Razao_Social, NCMs_Atuacao, 
         NCM_Frequente, Total_NCM_Frequente,
         NCM_Atipicidade_Maxima, NCM_Atipicidade_Maxima_Desc, Presente_CEIS)
```

O índice de *atipicidade* é um valor calculado para cada NCM presente nos dados de notas fiscais. Ele indica quão distante dos valores que seriam considerados comuns para o NCM está o valor cobrado por um produto. Como uma forma de sumarizar esses valores para cada fornecedor, foi calculada a *atipicidade média* de um fornecedor, que diz respeito à média dos índices de atipicidade de todos os NCMs onde tal fornecedor atua.

Abaixo é possível observar a listagem com os `r n_fornecedores_observados` fornecedores que apresentaram o maior índice
de *atipicidade média* durante nossas análises.

As características presentes na listagem são:

- CPF_CNPJ_emit, o CPF ou CNPJ do fornecedor;
- Razao_Social, a razão social do fornecedor;
- NCMs_Atuacao, total de NCMs onde o fornecedor atua;
- NCM_Frequente, NCM onde o fornecedor mais atua;
- Total_NCM_Frequente, Total de produtos vendidos no NCM onde o fornecedor mais atua;
- NCM_Atipicidade_Maxima, o NCM onde foi encontrada a maior atipicidade parao fornecedor;
- Presente_CEIS, indica se o fornecedor encontra-se no Cadastro de Empresas Inidôneas e Suspeitas (CEIS)

Em casos de empates no NCMs mais frequente, o NCM exibido foi selecionado aleatoriamente entre os empatados.

```{r}
dados_fornecedores %>% 
  select(-NCM_Atipicidade_Maxima) %>%
  rename(NCM_Atipicidade_Maxima = NCM_Atipicidade_Maxima_Desc) %>%
  datatable(
          rownames = FALSE, class = 'cell-border stripe', filter = "top",
          options = list(scrollX = TRUE, pageLength = 10))
```

Sabendo o NCM onde encontra-se a maior atipicidade para os fornecedores selecionados, na tabela a seguir, é possível ver detalhes sobre a venda do produto (ou produtos, em caso de mais de uma venda ter ocorrido com o preço máximo) mais caro(s) vendido(s) pelo fornecedor naquele NCM.

```{r}
set.seed(123)

#Preço médio nos NCMs
preco_medio_ncms <- tbl(notas, "nota_fiscal") %>%
  group_by(NCM_prod) %>%
  summarise(Preco_Medio_NCM = mean(Valor_unit_prod)) %>%
  collect(n = Inf)

cnpj_fornecedores_selecionados <- dados_fornecedores %>% distinct(CPF_CNPJ_emit) %>% .[[1]]

notas_fornecedores_selecionados <- tbl(notas, "nota_fiscal") %>%
  filter(CPF_CNPJ_emit %in% cnpj_fornecedores_selecionados) %>%
  collect(n = Inf) %>%
  semi_join(dados_fornecedores %>% select(CPF_CNPJ_emit, NCM_prod = NCM_Atipicidade_Maxima)) 

#Notas onde são encontradas os valores máximos
notas_ncm_maior_atipicidade <- notas_fornecedores_selecionados %>%
  left_join(preco_medio_ncms) %>%
  left_join(ncm %>% select(NCM_prod = NCM, NCM_desc = Descricao)) %>%
  group_by(CPF_CNPJ_emit) %>%
  arrange(desc(Valor_unit_prod)) %>%
  top_n(1, Valor_unit_prod) %>%
  select(CPF_CNPJ_emit,
         Razao_social_emit = Nome_razao_social_emit,
         CPF_CNPJ_dest,
         Razao_social_dest = Nome_razao_social_dest, 
         NCM_prod = NCM_desc,
         Descricao_prod = Descricao_do_Produto_ou_servicos,
         Valor_venda_prod = Valor_unit_prod,
         Preco_Medio_NCM,
         Chave_nota = Chave_de_acesso, 
         Item_nota = Nr_item
         )
```


```{r}
notas_ncm_maior_atipicidade %>%
    datatable(
          rownames = FALSE, class = 'cell-border stripe', filter = "top",
          options = list(scrollX = TRUE, pageLength = 10))
```

Por fim, pode-se ver quem foram os compradores que mais firmaram negócio com os fornecedores selecionados.

```{r}
set.seed(123)

#Orgãos que mais compram nos fornecedores
dados_fornecedores_compradores <- tbl(notas, "nota_fiscal") %>%
  filter(CPF_CNPJ_emit %in% cnpj_fornecedores_selecionados) %>%
  group_by(CPF_CNPJ_emit, CPF_CNPJ_dest) %>%
  summarise(
    Total_Compras = n_distinct(Chave_de_acesso)) %>%
  collect(n = Inf) %>%
  ungroup() %>%
  
  sample_n(nrow(.)) %>% 
  group_by(CPF_CNPJ_emit) %>% 
  top_n(3, Total_Compras) %>%
  ungroup() %>% 
  
  arrange(CPF_CNPJ_emit, desc(Total_Compras)) %>% 
  group_by(CPF_CNPJ_emit) %>% 
  slice(1:3) %>% 
  ungroup() %>% 
  
  left_join(cnpj_nome) %>% 
  select(CPF_CNPJ_emit, Nome_razao_social_emit, CPF_CNPJ_dest, Nome_razao_social_dest, Total_Compras)
```

```{r}
dados_fornecedores_compradores %>% datatable(
          rownames = FALSE, class = 'cell-border stripe', filter = "top",
          options = list(scrollX = TRUE, pageLength = 10))
```