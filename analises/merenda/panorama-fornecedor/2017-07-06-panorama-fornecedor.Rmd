---
title: "Descrição dos fornecedores de merenda"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10)

options(scipen = 999)
```

```{r}
library(ggthemes)
library(corrplot)
library(plotly)

library(tidyr)
library(plyr)
library(dplyr)
library(ggplot2)
library(lubridate)

library(rsagrespb)
library(rgdal)
library(knitr)
source('../lib/load_licitantes_merenda.R')

```

```{r}
utils = src_mysql('utils', group='ministerio-publico', password=NULL)

municipios = tbl(utils, 'municipio') %>%
  collect()

sagres = src_mysql('SAGRES_MUNICIPAL', group='ministerio-publico-local', password=NULL)

tipos_licitacao = tbl(sagres, 'Tipo_Modalidade_Licitacao') %>%
  collect() %>%
  mutate(de_TipoLicitacao = as.character(de_TipoLicitacao))

licitacoes_merenda <- get_licitacoes(sagres, cd_funcao = 12, cd_subfuncao = 306, cd_subelemento = "02") %>%
  collect(n = Inf) %>%
  mutate(dt_Homologacao = ymd_hms(dt_Homologacao)) %>%
  filter(year(dt_Homologacao) >= 2012 & year(dt_Homologacao) <= 2016) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios %>% select(cd_Municipio, de_Municipio), 'cd_Municipio') %>%
  select(-cd_UnGestora)
```

```{r}
contratos <- tbl(sagres, 'Contratos') %>%
  collect(n = Inf) %>%
  semi_join(licitacoes_merenda, by = c('cd_UGestora', 'nu_Licitacao', 'tp_Licitacao'))

participantes <- tbl(sagres, 'Participantes') %>%
  collect(n = Inf) %>%
  semi_join(licitacoes_merenda, by = c('cd_UGestora', 'nu_Licitacao', 'tp_Licitacao'))

fornecedores <- tbl(sagres, 'Fornecedores') %>%
   collect(n = Inf) %>%
   semi_join(participantes, by = c('cd_UGestora', 'nu_CPFCNPJ'))
```

```{r}
get.fornecedor <- function(nu_CPFCNPJ){
  result <- data.frame(nu_CPFCNPJ) %>%
    join(fornecedores)
  return(select(result, nu_CPFCNPJ, no_Fornecedor))
}
```


```{r configuracao dos mapas, results='hide'}
# Encontrado em: http://www.aesa.pb.gov.br/geoprocessamento/geoportal/shapes.html
mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

# Atualizando nome de municípios que mudaram de nome nos últimos anos
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

# Join entre a tabela de licitações e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = licitacoes_merenda %>% inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

# Sumarização dos dados por município
paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n(),
            valor_medio_lic = mean(vl_Licitacao),
            valor_total_lic = sum(vl_Licitacao),
            total_num = n())

paraiba_sumarizado = paraiba_sumarizado %>%
  mutate(valor_medio_lic_original = valor_medio_lic) %>%
  mutate(valor_total_lic_original = valor_total_lic)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total,
                                breaks = c(0,3,5,7,10,15,25),
                               labels = c("de 1 a 3", "de 3 a 5", "de 5 a 7", "de 7 a 10", "de 10 a 15", "de 15 a 25"),
                                include.lowest = T)

paraiba_sumarizado$valor_medio_lic = cut(paraiba_sumarizado$valor_medio_lic,
                                         breaks = c(0, 50000, 100000, 200000, 300000, 500000, 1000000, 2000000, 21000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 200", "De 200 a 300",  "De 300 a 500",
                                                    "De 500 a 1000", "De 1000 a 2000",  "Acima de 2000"),
                                         include.lowest = T)

paraiba_sumarizado$valor_total_lic = cut(paraiba_sumarizado$valor_total_lic,
                                         breaks = c(0, 50000, 100000, 250000, 500000, 1000000, 5000000, 10000000,
                                                    25000000, 50000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 500", "De 500 a 1000",
                                                    "De 1000 a 2500", "De 1000 a 5000", "De 5000 a 10000", "De 10000 a 25000",
                                                    "De 25000 a 50000"),
                                         include.lowest = T
                                         )

```


No nosso [relatório anterior](https://analytics-ufcg.github.io/licitacoes-pb//2017/03/comprador-fornecedor.html) nós observamos o comportamento dos municípios da paraíba quanto aos gastos com merenda escolar, aqui vamos estudar a outra face dessa mesma moeda, __os fornecedores__. 

Um fornecedor é aquele que fornece mercadorias ou serviços a um consumidor, nesta análise em especial, considera-se como fornecedor toda empresa ou pessoa física que está ligado a algum empenho de merenda.

### 3.1 - Quantos são os fornecedores de merenda de cada município?
Através da análise dos dados dos fornecedores e sua participação nos contratos de merenda de cada município no período de 2011 a 2015, foi possível traçar um panorama da distribuição e diversidade de fornecedores no estado da Paraíba. A seguir, é possível visualizar qual o total de fornecedores de merenda em cada um dos municípios do estado.

```{r}
levels_mapa = mapa_paraiba@data$Nome_Munic

levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

get.municipio <- function(cd_UGestora) {
  result <- data.frame(
      cd_Municipio = str_sub(cd_UGestora, -3)) %>%
    join(municipios)
  return(result$de_Municipio)
}

merenda_pb <- fornecedores %>%
  mutate(de_Municipio = get.municipio(cd_UGestora))

#merenda_pb <- left_join(fornecedores, municipios, 'cd_Municipio')

# Join entre a tabela de fornecedores e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = merenda_pb %>% inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

# Sumarização dos dados por município
paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n())

quartis_pb <- quantile(paraiba_sumarizado$total)

# Imputação de dados (municípios que não tiveram licitações de merenda) e mais Sao Vicente do Serido que nao foi inserido no join
#data_temp = data.frame(de_Municipio =
#                c('Mato Grosso', 'Nova Floresta', 'Mamanguape', 'Sao Vicente do Serido', 'Mogeiro', 'Alagoa Grande'),
#                total = c(0, 0, 0, 9, 0, 0))

#paraiba_sumarizado = rbind(paraiba_sumarizado, data_temp)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total,
                                breaks = c(0,5,10,20,30,83),
                                include.lowest = F)

# Criando um data frame com os municípios na ordem do mapa
levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)
paraiba_municipios$levels_mapa <- as.character(paraiba_municipios$levels_mapa)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

colors = brewer.pal(5,                          "YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total
spplot(mapa_paraiba, 'Y',  col.regions = colors, main = "Número de fornecedores de merenda por município")
```

Observa-se que o número de fornecedores é, em geral, baixo, uma vez que 75% das cidades tem no máximo `r unname(quartis_pb)[4]` fornecedores e 48 das cidades não apresentaram nenhum fornecedor (demarcadas em branco no mapa).

A cidade de Monteiro apresentou valor extremo se comparada as demais, visto que esta cidade teve 83 fornecedores. A segunda cidade com mais fornecedores foi João Pessoa com um total de 35 fornecedores, cerca de 60% a menos que Monteiro.


### Quantos fornecedores, em média, competem nas licitações?
```{r}
n_propostas_group <- licitacoes_merenda %>%
  group_by(nu_Propostas) %>%
  summarise(n = n())
lic_sem_concorrentes <- subset(licitacoes_merenda, nu_Propostas <= 1)
```
A média de fornecedores por licitação de merenda é de __`r round(mean(licitacoes_merenda$nu_Propostas), 2)`__ enquanto a mediana é de `r median(licitacoes_merenda$nu_Propostas)` o que significa que existem licitações com valores extremos para o número de interessados que fazem a média subir, em geral, essas licitações são chamadas públicas para aquisição de gêneros alimentícios provenientes de agricultura familiar.

Percebe-se que em geral, as licitações contam com um número pequeno de competidores, indicando que existe baixa concorrência nas licitações de merenda; Notou-se ainda que `r length(lic_sem_concorrentes$cd_Municipio)` (`r round(length(lic_sem_concorrentes$cd_Municipio)/length(licitacoes_merenda$cd_Municipio)*100, 2)`%) licitações receberam nenhuma ou apenas uma proposta, ou seja, não tiveram concorrência.


### Existem fornecedores que dominam a distribuição de merenda?
Para responder essa questão foi calculado o número de contratos celebrados por cada fornecedor de merenda no período de 2012 a 2016, com o intuito de identificar uma possível existência de fornecedores que vençam muito mais licitações que os demais.

```{r}
fornecedores_groups <- group_by(contratos, nu_CPFCNPJ)
data_fornecedores_groups <- summarise(fornecedores_groups, n = n())
contratos_ordenados <- within(contratos,
                              nu_CPFCNPJ <- factor(nu_CPFCNPJ, levels = names(sort(table(nu_CPFCNPJ), decreasing = TRUE))))

quartis_fornc <- quantile(data_fornecedores_groups$n)
media <- mean(data_fornecedores_groups$n)

ggplot(aes(x = nu_CPFCNPJ), data = contratos_ordenados) +
  geom_histogram(stat = 'count', color = '#5CA171') +
  labs(title = 'Número de contratos celebrados por fornecedor', x = 'Fornecedores', y = 'Número de contratos') +
  geom_hline(yintercept = media, linetype = 'dashed', color = 'blue') +
  geom_text(aes(0, media, label = 'Média', vjust = -0.5, hjust = -0.1), size = 4) +
  scale_y_continuous(breaks = seq(0, 80, 5)) +
  theme(
      axis.text.x=element_blank(),
      axis.ticks.x=element_blank())

```

Observa-se uma média de `r round(mean(data_fornecedores_groups$n), 2)` contratos celebrados por fornecedor, com 75% dos fornecedores com até `r unname(quartis_fornc)[4]` contratos, o que justifica a média baixa. Apesar disso, um pequeno grupo de `r length(subset(data_fornecedores_groups, n > 5)$nu_CPFCNPJ)` fornecedores (`r round(length(subset(data_fornecedores_groups, n > 5)$nu_CPFCNPJ)/length(data_fornecedores_groups$nu_CPFCNPJ)*100, 2)`% do total) conseguiu fechar mais de 5 contratos durante o período estudado.

Abaixo, observaremos estes vencedores, divididos em alguns grupos.

```{r}
get.grandes.vencedores <- function(lower_bound, upper_bound){
  if(missing(upper_bound)){upper_bound <- max(data_fornecedores_groups$n)}
  if(missing(lower_bound)){lower_bound <- min(data_fornecedores_groups$n)}

  vencedores <- subset(data_fornecedores_groups, n > lower_bound & n <= upper_bound, c("nu_CPFCNPJ", "n"))
  nomes_vencedores <- get.fornecedor(vencedores)
  unique_nomes_vencedores <- subset(nomes_vencedores,
                                     !duplicated(nomes_vencedores$nu_CPFCNPJ))

  # Adiciona colunas adicionais para ajudar na identificação dos fornecedores
  unique_nomes_vencedores = merge(unique_nomes_vencedores, vencedores, by = "nu_CPFCNPJ")
  return(unique_nomes_vencedores)
}

vencedores1 <- get.grandes.vencedores(5,10)
kable(vencedores1[order(vencedores1$n),], caption = "Fornecedores que fecharam entre 6 e 10 contratos",
      col.names = c("CPF/CNPJ", "Nome", "Número de contratos"), row.names = FALSE)

vencedores2 <- get.grandes.vencedores(10,20)
kable(vencedores2[order(vencedores2$n),], caption = "Fornecedores que fecharam entre 11 e 20 contratos",
      col.names = c("CPF/CNPJ", "Nome", "Número de contratos"), row.names = FALSE)

```

Uma atenção especial para os seguintes fornecedores, todos eles fecharam __mais de 20 contratos__, um número muito superior à media.

```{r}
vencedores3 <- get.grandes.vencedores(20)
kable(vencedores3[order(vencedores3$n),], col.names = c("CPF/CNPJ", "Nome", "Número de contratos"), row.names = FALSE)
```


### Os contratos de licitações são bem distribuidos entre os fornecedores?

```{r}
participacoes <- participantes %>%
  group_by(nu_CPFCNPJ) %>%
  summarise(participou = n())
```

Os gráficos abaixo mostram que a maior parte dos fornecedores participaram do processo licitatório apenas uma vez. Note que a reta desenhada mostra os fornecedores que ganharam todas as vezes que participaram, o que significa que os pontos acima dessa reta são inconsistências nos dados. Também é importante destacar que o fornecedor com mais participações, mas nenhuma vitória, é um fornecedor genérico, entitulado "Folha de Pagamento (Fornecedor Padrão)". Ele participou `r max(participacoes$participou)` vezes e como distorceria a visualização não foi inserido no gráfico.

```{r}

vitorias <- contratos %>%
  group_by(nu_CPFCNPJ) %>%
  summarise(
    ganhou = n(),
    valor = sum(vl_TotalContrato))

lucros <- fornecedores %>%
  distinct(nu_CPFCNPJ) %>%
  merge(participacoes, all=T) %>%
  merge(vitorias, all=T) %>%
  filter(nu_CPFCNPJ != '00000000000000')

lucros[is.na(lucros)] <- 0

lucros <- lucros %>%
  mutate(perdeu = participou-ganhou)

p <- lucros %>%
  group_by(participou, ganhou) %>%
  summarise(freq = n()) %>%
  ggplot(aes(x=participou, y=ganhou, size=freq)) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point(color = '#1E90FF') +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Participações em licitações versus vitórias por fornecedor',
      x = 'Participações',
      y = 'Vitórias',
      size = 'Ocorrências') +
    theme_minimal()
ggplotly(p)
```

Como existem alguns valores extremos que tornam a escala difícil de visualizar, também pode ser vista abaixo uma versão do gráfico com apenas a parte que corresponde a maior parte dos fornecedores.

```{r}
p <- lucros %>%
  filter(participou < 30) %>%
  group_by(participou, ganhou) %>%
  summarise(freq = n()) %>%
  ggplot(aes(x=participou, y=ganhou, size=freq)) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point(color = '#1E90FF') +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Participações em licitações versus vitórias por fornecedor',
      x = 'Participações',
      y = 'Vitórias',
      size = 'Ocorrências') +
    theme_minimal()

ggplotly(p)
```

Outra coisa relevante a se observar é que o dinheiro recebido por meio de contratos de licitação se concentra em uma pequena parcela dos fornecedores, como pode ser visto no gráfico abaixo. Um dos motivos disso é que a maioria dos fornecedores só participou de uma ou duas licitações, mas isso não descarta a possibilidade de favoritismo ou contratos únicos de alto valor.

```{r}
 p <- lucros %>%
  arrange(-valor) %>%
  mutate(ordem=nrow(lucros) %>% seq) %>%
  head(400) %>%
  ggplot(aes(x=ordem, y=valor)) +
    geom_bar(width=1, stat='identity', color = "#1E90FF") +
    scale_y_continuous(
      breaks=pretty_breaks(5),
      label=comma) +
    labs(
      title = 'Distribuição de licitações por fornecedor',
      x = 'Fornecedor',
      y = 'Total ganho (reais)') +
  theme_minimal() +
  theme(axis.text.x=element_blank())

ggplotly(p)
```
