---
title: 'Realinhamento de Preços'
output: html_document
---

```{r setup, include=FALSE}
options(scipen = 999)

knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.height = 8,
  fig.width = 8)
```

```{r}
library(ggplot2)
library(scales)
library(GGally)

library(tidyr)
library(dplyr)
```

```{r instancia tabelas do bd}
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

query <- sql('
  SELECT *
  FROM licitacao
  WHERE de_Obs REGEXP "merenda"
  AND dt_Ano BETWEEN 2011 AND 2015
')

licitacoes <- tbl(sagres, query) %>%
  compute(name = 'lm') %>%
  collect()

query <- sql('
  SELECT c.*
  FROM contratos c
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

contratos <- tbl(sagres, query) %>%
  compute(name = 'cm') %>%
  collect()

query <- sql('
  SELECT a.*
  FROM aditivos a
  INNER JOIN cm
  USING (cd_UGestora, nu_Contrato)
')

aditivos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT e.*
  FROM empenhos e
  USE INDEX (licitacao)
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

empenhos <- tbl(sagres, query) %>%
  compute(name = 'em') %>%
  collect()

query <- sql('
  SELECT l.*
  FROM liquidacao l
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

liquidacoes <- tbl(sagres, query) %>%
  compute(name = 'lqm') %>%
  collect()

query <- sql('
  SELECT p.*
  FROM pagamentos p
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

pagamentos <- tbl(sagres, query) %>%
  compute(name = 'pm') %>%
  collect()

query <- sql('
  SELECT e.*
  FROM estorno e
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

estornos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT el.*
  FROM estornoliquidacao el
  INNER JOIN lqm
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, nu_Liquidacao)
')

estornos.liquidacoes <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT ep.*
  FROM estornopagamento ep
  INNER JOIN pm
  ON
    ep.cd_UGestora = pm.cd_UGestora AND
    ep.nu_EmpenhoEstorno = pm.nu_Empenho AND
    ep.cd_UnidOrcamentaria = pm.cd_UnidOrcamentaria AND
    ep.dt_Ano = pm.dt_Ano AND
    ep.nu_ParcelaEstorno = pm.nu_Parcela AND
    ep.tp_Lancamento = pm.tp_Lancamento
')

estornos.pagamentos <- tbl(sagres, query) %>%
  collect()
```

```{r}
empenhos.full <- empenhos %>%
  select(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, vl_Empenho, nu_Licitacao, tp_Licitacao)

empenhos.full <- liquidacoes %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Liquidacao = sum(vl_Liquidacao, na.rm=T)) %>%
  merge(empenhos.full, all=T)

empenhos.full <- pagamentos %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Pagamento = sum(vl_Pagamento, na.rm=T)) %>%
  merge(empenhos.full, all=T)

empenhos.full <- estornos %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Estorno = sum(vl_Estorno, na.rm=T)) %>%
  merge(empenhos.full, all=T)

empenhos.full <- estornos.liquidacoes %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_EstornoLiquidacao = sum(vl_EstornoLiquidacao, na.rm=T)) %>%
  merge(empenhos.full, all=T)

empenhos.full <- estornos.pagamentos %>%
  group_by(cd_UGestora, nu_Empenho = nu_EmpenhoEstorno, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_EstornoPagamento = sum(vl_Estorno, na.rm=T)) %>%
  merge(empenhos.full, all=T)

empenhos.full <- empenhos.full %>%
  select(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, nu_Licitacao, tp_Licitacao,
         vl_Empenho, vl_Estorno, vl_Liquidacao, vl_EstornoLiquidacao, vl_Pagamento, vl_EstornoPagamento)

empenhos.full[is.na(empenhos.full)] <- 0
```

```{r}
licitacoes.full <- licitacoes %>%
  select(cd_UGestora, nu_Licitacao, tp_Licitacao, vl_Licitacao)

licitacoes.full <- aditivos %>%
  group_by(cd_UGestora, nu_Contrato) %>%
  summarise(vl_Aditivo = sum(vl_Aditivo, na.rm=T)) %>%
  merge(contratos, all=T) %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise(
    vl_Contrato = sum(vl_TotalContrato, na.rm=T),
    vl_Aditivo = sum(vl_Aditivo, na.rm=T)) %>%
  merge(licitacoes.full, all=T)

licitacoes.full <- empenhos.full %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise_each(funs(sum(., na.rm=T)), -nu_Empenho, -cd_UnidOrcamentaria, -dt_Ano) %>%
  merge(licitacoes.full, all=T)

licitacoes.full <- licitacoes.full %>%
  select(cd_UGestora, nu_Licitacao, tp_Licitacao,
         vl_Licitacao, vl_Empenho, vl_Estorno, vl_Contrato, vl_Aditivo,
         vl_Liquidacao, vl_EstornoLiquidacao, vl_Pagamento, vl_EstornoPagamento)

licitacoes.full[is.na(licitacoes.full)] <- 0
```

```{r}
licitacoes.alt <- licitacoes.full %>%
  mutate(
    vl_Contrato = vl_Contrato + vl_Aditivo,
    vl_Empenho = vl_Empenho - vl_Estorno,
    vl_Liquidacao = vl_Liquidacao - vl_EstornoLiquidacao,
    vl_Pagamento = vl_Pagamento - vl_EstornoPagamento) %>%
  select(-vl_Aditivo, -vl_Estorno, -vl_EstornoLiquidacao, -vl_EstornoPagamento)
```

```{r licitacao vs. contratos}
ggplot(aes(x=log(vl_Licitacao+1), y=log(vl_Contrato+1)), data = licitacoes.alt) +
  geom_abline(slope=1, intercept=0, color='grey') +
  geom_point() +
  scale_x_continuous(breaks=pretty_breaks(10)) +
  scale_y_continuous(breaks=pretty_breaks(10)) +
  labs(
    title = 'Valor da licitação versus valor do contrato',
    x = 'Valor da licitação',
    y = 'Valor do contrato') +
  theme_minimal()
```

```{r contratos vs. empenhos}
ggplot(aes(x=log(vl_Contrato+1), y=log(vl_Empenho+1)), data = licitacoes.alt) +
  geom_abline(slope=1, intercept=0, color='grey') +
  geom_point() +
  scale_x_continuous(breaks=pretty_breaks(10)) +
  scale_y_continuous(breaks=pretty_breaks(10)) +
  labs(
    title = 'Valor do contrato versus valor do empenho',
    x = 'Valor do contrato',
    y = 'Valor do empenho') +
  theme_minimal()
```

```{r empenhos vs. liquidações}
ggplot(aes(x=log(vl_Empenho+1), y=log(vl_Liquidacao+1)), data = licitacoes.alt) +
  geom_abline(slope=1, intercept=0, color='grey') +
  geom_point() +
  scale_x_continuous(breaks=pretty_breaks(10)) +
  scale_y_continuous(breaks=pretty_breaks(10)) +
  labs(
    title = 'Valor do empenho versus valor da liquidação',
    x = 'Valor do empenho',
    y = 'Valor da liquidação') +
  theme_minimal()
```

```{r liquidacões vs. pagamentos}
ggplot(aes(x=log(vl_Liquidacao+1), y=log(vl_Pagamento+1)), data = licitacoes.alt) +
  geom_abline(slope=1, intercept=0, color='grey') +
  geom_point() +
  scale_x_continuous(breaks=pretty_breaks(10)) +
  scale_y_continuous(breaks=pretty_breaks(10)) +
  labs(
    title = 'Valor da liquidação versus valor do pagamento',
    x = 'Valor da liquidação',
    y = 'Valor do pagamento') +
  theme_minimal()
```

```{r}
licitacoes.alt %>%
  select(vl_Licitacao, vl_Contrato, vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  mutate_each(funs(log(.+1))) %>% 
  ggpairs()
```

```{r coordenadas paralelas}
licitacoes.alt.long <- licitacoes.alt %>%
  select(vl_Licitacao, vl_Empenho, vl_Contrato, vl_Liquidacao, vl_Pagamento) %>%
  mutate(id = 1:nrow(licitacoes.alt)) %>%
  gather('atributo', 'valor', -id, factor_key = T) %>%
  mutate(valor = log(valor+1)) %>%
  group_by(id) %>%
  filter(all(valor > 0))

ggplot(aes(x=atributo, y=valor, group=id, color=id), data = licitacoes.alt.long) + 
  geom_line(alpha = 0.3) +
  guides(color = F) +
  theme_minimal()
```
