---
title: "Realinhamento de Preços"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 8,
  fig.height = 8
)
```

```{r}
library(ggthemes)
library(corrplot)
library(ggplot2)
library(GGally)

library(tidyr)
library(plyr)
library(dplyr)
library(plotly)

library(rgdal)
library(scales)

library(knitr)
library(reshape2)
```

```{r instancia tabelas do bd}
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

query <- sql('
  SELECT *
  FROM licitacao
  WHERE de_Obs REGEXP "merenda"
  AND dt_Ano BETWEEN 2011 AND 2015
')

licitacoes <- tbl(sagres, query) %>%
  compute(name = 'lm') %>%
  collect()

query <- sql('
  SELECT c.*
  FROM contratos c
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

contratos <- tbl(sagres, query) %>%
  compute(name = 'cm') %>%
  collect()

query <- sql('
  SELECT a.*
  FROM aditivos a
  INNER JOIN cm
  USING (cd_UGestora, nu_Contrato)
')

aditivos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT e.*
  FROM empenhos e
  USE INDEX (licitacao)
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

empenhos <- tbl(sagres, query) %>%
  compute(name = 'em') %>%
  collect()

query <- sql('
  SELECT l.*
  FROM liquidacao l
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

liquidacoes <- tbl(sagres, query) %>%
  compute(name = 'lqm') %>%
  collect()

query <- sql('
  SELECT p.*
  FROM pagamentos p
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

pagamentos <- tbl(sagres, query) %>%
  compute(name = 'pm') %>%
  collect()

query <- sql('
  SELECT e.*
  FROM estorno e
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

estornos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT el.*
  FROM estornoliquidacao el
  INNER JOIN lqm
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, nu_Liquidacao)
')

estornos.liquidacoes <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT ep.*
  FROM estornopagamento ep
  INNER JOIN pm
  ON
    ep.cd_UGestora = pm.cd_UGestora AND
    ep.nu_EmpenhoEstorno = pm.nu_Empenho AND
    ep.cd_UnidOrcamentaria = pm.cd_UnidOrcamentaria AND
    ep.dt_Ano = pm.dt_Ano AND
    ep.nu_ParcelaEstorno = pm.nu_Parcela AND
    ep.tp_Lancamento = pm.tp_Lancamento
')

estornos.pagamentos <- tbl(sagres, query) %>%
  collect()
```

```{r}
empenhos.alt <- empenhos %>%
  select(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, vl_Empenho, nu_Licitacao, tp_Licitacao)

empenhos.alt <- liquidacoes %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Liquidacao = sum(vl_Liquidacao, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt <- pagamentos %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Pagamento = sum(vl_Pagamento, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt <- estornos %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Estorno = sum(vl_Estorno, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt <- estornos.liquidacoes %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_EstornoLiquidacao = sum(vl_EstornoLiquidacao, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt <- estornos.pagamentos %>%
  group_by(cd_UGestora, nu_Empenho = nu_EmpenhoEstorno, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_EstornoPagamento = sum(vl_Estorno, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt[is.na(empenhos.alt)] <- 0

empenhos.alt <- empenhos.alt %>%
  mutate(
    vl_Empenho = vl_Empenho - vl_Estorno,
    vl_Liquidacao = vl_Liquidacao - vl_EstornoLiquidacao,
    vl_Pagamento = vl_Pagamento - vl_EstornoPagamento) %>%
  select(-vl_Estorno, -vl_EstornoLiquidacao, -vl_EstornoPagamento)
```

```{r}
licitacoes.alt <- licitacoes %>%
  select(cd_UGestora, nu_Licitacao, tp_Licitacao, vl_Licitacao)

licitacoes.alt <- aditivos %>%
  group_by(cd_UGestora, nu_Contrato) %>%
  summarise(vl_Aditivo = sum(vl_Aditivo, na.rm=T)) %>%
  merge(contratos, all=T) %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise(
    vl_Contrato = sum(vl_TotalContrato, na.rm=T),
    vl_Aditivo = sum(vl_Aditivo, na.rm=T)) %>%
  merge(licitacoes.alt, all=T)

licitacoes.alt <- empenhos.alt %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise_each(funs(sum(., na.rm=T)), vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  merge(licitacoes.alt, all=T)

licitacoes.alt[is.na(licitacoes.alt)] <- 0

licitacoes.alt <- licitacoes.alt %>%
  mutate(vl_Contrato = vl_Contrato + vl_Aditivo) %>%
  select(-vl_Aditivo)
```

# Introdução
O gasto do dinheiro público, para a maioria dos cidadãos é um processo obscuro e complexo, no entanto compreender como se desenrrola este método pode ser fundamental para identificarmos peculiaridades nos gastos públicos.

Este relátório busca compreender o processo de gasto do dinheiro público, a execução orçamentária, e responder a questões como: Qual a variação entre o valor licitado e o valor efetivamente pago ao fornecedor de merenda? O quanto variam os valores entre os estágios consecutivos do processo de execução orçamentária?

Para tal, decidimos estudar as compras de merenda na Paraíba no período de 2011 à 2015, foram analisados dados de 872 licitações, adicionando a estas os dados de interesse de seus respectivos empenhos, contratos, liquidações, pagamentos, foram considerados ainda os valores de aditivos e de estorno de cada um dos estágios citados.

# Execução Orçamentária
De acordo com o site do Tesouro Nacional [[1](http://www.tesouro.fazenda.gov.br/execucao-orcamentaria)] a execução orçamerntária ocorre paralelamente à execução financeira e compreende na utilização dos créditos consignados na Lei Orçamentária Anual (LOA). Executar o orçamento é, portanto, realizar as despesas públicas nele previstas, seguindo à risca os três estágios da execução de despesas previstos na Lei nº 4320/64 : empenho, liquidação e pagamento.

## Empenho
O empenho é o primeiro estágio da despesa e pode ser conceituado como sendo o ato emanado de autoridade competente que cria para o Estado a obrigação de pagamento, pendente ou não, de implemento de condição, ou seja, é a garantia de que foi feita a reserva orçamentária necessária para o pagamento do que esta sendo contratado. [[1](http://www.tesouro.fazenda.gov.br/execucao-orcamentaria)], [[2](https://www.pjf.mg.gov.br/subsecretarias/controle_interno/documentos/treinamento/05_execucao_ABRIL_2013.pdf)]

O empenho deve sempre anteceder a realização de qualquer despesa, o que implica que este deve ser feito antes ou contemporâneo à assinatura do contrato. [[3](http://www.zenite.blog.br/quando-deve-ser-realizado-o-empenho/)]

## Liquidação
O segundo estágio da despesa pública é a liquidação, que consiste na verificação do direito adquirido pelo credor, tendo por base os títulos e documentos comprobatórios do respectivo crédito ou seja, é a comprovação de que o credor cumpriu todas as obrigações constantes do empenho. A finalidade é reconhecer ou apurar a origem e o objeto do que se deve pagar, a importância exata a pagar e a quem se deve pagar para extinguir a obrigação. [[1](http://www.tesouro.fazenda.gov.br/execucao-orcamentaria)]

## Pagamento
O último estágio da despesa é o pagamento e consiste na entrega de numerário ao credor do Estado, extinguindo dessa forma o débito ou obrigação. [[1](http://www.tesouro.fazenda.gov.br/execucao-orcamentaria)]


## Comparando os valores entre os estágios da execução orçamentária
A seguir serão estudados os valores descritos em cada fase do processo de execução orçamentária, para facilitar a visualização dos dados foi aplicado a função log em todos os valores. Nos gráficos de dispersão cada ponto representa uma das 872 licitações estudadas.

### Contratos vs. Empenhos
O gráfico abaixo confronta os valores de contratos e empenhos.

```{r contratos vs. empenhos}
g <- ggplot(aes(x=log(vl_Contrato+1), y=log(vl_Empenho+1)), data = licitacoes.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do contrato versus valor do empenho',
      x = 'Valor do contrato',
      y = 'Valor do empenho') +
    theme_minimal()
ggplotly(g)
```

Podemos perceber que na maioria dos casos o valor contratado é superior ao valor empenhado, isso indica que está sendo reservado menos dinheiro do que seria, a príncípio necessário para fazer face à despesa contratada.

### Empenhos vs. Liquidações
Outra relação importante é a existente este o empenho e a liquidação de uma licitação, apresentada no gráfico seguinte.

```{r empenhos vs. liquidações}
g <- ggplot(aes(x=log(vl_Empenho+1), y=log(vl_Liquidacao+1)), data = empenhos.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do empenho versus valor da liquidação',
      x = 'Valor do empenho',
      y = 'Valor da liquidação') +
    theme_minimal()
ggplotly(g)
```

Esta relação apresenta mais dados de acordo com o esperado do que que a relação estudada anteriormente (empenhos vs. contratos) uma vez que existem muito mais valores exatamente sobre a reta traçada que identifica os casos em que o valor do empenho é igual ao valor da liquidação.
Esistem ainda assim valores que não estão sobre a reta, quer seja abaixo dela implicando que o valor empenhado foi maior que o liquidado  quer seja acima significando exatamente o oposto; no entanto existem poucas observações com este comportamento e as que assim apresentam estão próximas à reta, pessupondo que as diferenças são baixas.

### Liquidações vs. Pagamentos

```{r liquidacões vs. pagamentos}
g <- ggplot(aes(x=log(vl_Liquidacao+1), y=log(vl_Pagamento+1)), data = empenhos.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor da liquidacao versus valor do pagamento',
      x = 'Valor da liquidação',
      y = 'Valor do pagamento') +
    theme_minimal()
ggplotly(g)
```


Verificamos aqui que os valores de liquidação e pagamento são, na maioria das vezes, o mesmo. Mas neste caso, ao contrário do anterior, é muito mais comum que o valor do pagamento seja menor que o da liquidação do que o inverso, isto quer dizer que na grande maioria das vezes está sendo liquidado exatamente o necessário para realizar o pagamento ao fornecedor e quando isso não é verdade o que ocorre é que é liquidado um valor maior que o que é verdadeiramente pago.


```{r}
empenhos.alt %>%
  select(vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  mutate_each(funs(log(.+1))) %>% 
  ggpairs()
```

```{r}
licitacoes.alt %>%
  select(vl_Licitacao, vl_Contrato, vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  mutate_each(funs(log(.+1))) %>% 
  ggpairs()
```


## Visão geral
O gráfico abaixo apresenta um panorama de como se comportam as licitações ao longo de todo o processo de execução da despesa adicionado também o valor licitado e o valor contratado.
```{r coordenadas paralelas}

licitacoes.alt <- licitacoes.alt %>%
  select(cd_UGestora, nu_Licitacao, tp_Licitacao, vl_Licitacao, vl_Empenho, vl_Contrato, vl_Liquidacao, vl_Pagamento)

licitacoes.alt.long <- melt(licitacoes.alt, id.vars = c('cd_UGestora', 'nu_Licitacao', 'tp_Licitacao'))

licitacoes.alt.long$value <- log(licitacoes.alt.long$value + 1)

licitacoes.alt.long$id <- paste(licitacoes.alt.long$cd_UGestora, licitacoes.alt.long$nu_Licitacao, licitacoes.alt.long$tp_Licitacao, sep = "-")


g <- ggplot(data = subset(licitacoes.alt.long, value > 0), aes(x = variable, y = value, group = id)) + 
  geom_line(alpha = 0.1) +
  geom_point(alpha = 0.1) +
  geom_vline(xintercept = 'vl_Licitacao')
ggplotly(g)
```

A visualização nos permite observar variações constantes entre as fases do processo em análise, tanto de aumento quanto de redução de valor.

Para compreendermos melhor o resultado deste "sobe e desçe" de valores decidimos comparamos o valor de empenhos, que representa o valor que o governo pretendia e estava preparado para gastar, com o valor dos pagamentos, que refletem o valor efetivamente pago ao fornecedor.
```{r empenho vs. pagamento}
g <- ggplot(aes(x=log(vl_Empenho+1), y=log(vl_Pagamento+1)), data = licitacoes.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do empenho versus valor da pagamento',
      x = 'Valor da Empenho',
      y = 'Valor do Pagamento') +
    theme_minimal()

ggplotly(g)
```
Nota-se que todos os valores estão sobre ou abaixo da reta, ou seja, apesar das variações observadas no processo o valor empenhado é o mesmo ou pouco menor que o valor pago para as licitações de merenda.
Uma variável que influencia essa variação é o valor do contrato, pois ao contrário do esperado ele é bem diferente do valor empenhado.

# Conclusão

Observou-se que no fim das contas o valor pago ao fornecedor é menor ou igual ao valor empenhado para a execução da respectiva despesa, ou seja, é uma diminuição do gasto de dinheiro público.
Foram encontradas ainda variações de preços entre os estágios intermediários da execução orçamentária, variações estas que carecem de informações para que sejam devidamente compreendidas e justificadas.
