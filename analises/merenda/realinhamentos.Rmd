---
title: "Realinhamento de Preços"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggthemes)
library(corrplot)
library(ggplot2)
library(GGally)

library(tidyr)
library(plyr)
library(dplyr)

library(rgdal)
library(scales)

library(knitr)
```

```{r instancia tabelas do bd}
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

query <- sql('
  SELECT *
  FROM licitacao
  WHERE de_Obs REGEXP "merenda"
  AND dt_Ano BETWEEN 2011 AND 2015
')

licitacoes <- tbl(sagres, query) %>%
  compute(name = 'lm') %>%
  collect()

query <- sql('
  SELECT c.*
  FROM contratos c
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

contratos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT e.*
  FROM empenhos e
  USE INDEX (licitacao)
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

empenhos <- tbl(sagres, query) %>%
  compute(name = 'em') %>%
  collect()

query <- sql('
  SELECT l.*
  FROM liquidacao l
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

liquidacoes <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT p.*
  FROM pagamentos p
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

pagamentos <- tbl(sagres, query) %>%
  collect()
```

```{r}
empenhos.alt <- empenhos %>%
  select(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano, vl_Empenho, nu_Licitacao, tp_Licitacao)

empenhos.alt <- liquidacoes %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Liquidacao = sum(vl_Liquidacao, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt <- pagamentos %>%
  group_by(cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano) %>%
  summarise(vl_Pagamento = sum(vl_Pagamento, na.rm=T)) %>%
  merge(empenhos.alt, all=T)

empenhos.alt[is.na(empenhos.alt)] <- 0
```

```{r}
licitacoes.alt <- licitacoes %>%
  select(cd_UGestora, nu_Licitacao, tp_Licitacao, vl_Licitacao)

licitacoes.alt <- contratos %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise(vl_Contrato = sum(vl_TotalContrato, na.rm=T)) %>%
  merge(licitacoes.alt, all=T)

licitacoes.alt <- empenhos.alt %>%
  select(-nu_Empenho, -cd_UnidOrcamentaria, -dt_Ano) %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise_each(funs(sum(., na.rm=T))) %>%
  merge(licitacoes.alt, all=T)

licitacoes.alt[is.na(licitacoes.alt)] <- 0
```

```{r contratos vs. empenhos}
ggplot(aes(x=log(vl_Contrato+1), y=log(vl_Empenho+1)), data = licitacoes.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do contrato versus valor do empenho',
      x = 'Valor do contrato',
      y = 'Valor do empenho') +
    theme_minimal()
```

```{r empenhos vs. liquidações}
ggplot(aes(x=log(vl_Empenho+1), y=log(vl_Liquidacao+1)), data = empenhos.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do empenho versus valor da liquidação',
      x = 'Valor do empenho',
      y = 'Valor da liquidação') +
    theme_minimal()
```

```{r liquidacões vs. pagamentos}
ggplot(aes(x=log(vl_Liquidacao+1), y=log(vl_Pagamento+1)), data = empenhos.alt) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Valor do empenho versus valor da liquidação',
      x = 'Valor da liquidação',
      y = 'Valor do pagamento') +
    theme_minimal()
```

```{r}
empenhos.alt %>%
  select(vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  mutate_each(funs(log(.+1))) %>% 
  ggpairs()
```

```{r}
licitacoes.alt %>%
  select(vl_Licitacao, vl_Contrato, vl_Empenho, vl_Liquidacao, vl_Pagamento) %>%
  mutate_each(funs(log(.+1))) %>% 
  ggpairs()
```

