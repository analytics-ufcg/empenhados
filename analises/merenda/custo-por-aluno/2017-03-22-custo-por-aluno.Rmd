---
title: "Custo de alimentação por aluno"
author: "Laboratório Analytics"
date: "27 de abril de 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r}
library(stringr)
library(maps)
library(ggmap)
library(rgdal)
library(htmltools)
library(leaflet)
library(plotly)

library(dplyr)

source('load-matriculas-lib.R')
```

```{r}
dados_escolares <- load_dados_escolares()
```

# Introdução

Quanto cada município gasta por aluno em média? Interessados na resposta, o relatório a seguir busca identificar quais os municípios que mais gastam com merenda por aluno e como ocorre a distribuição de municípios no estado com relação a esse gasto por aluno. Os dados relacionados à quantidade de alunos matriculados em cada município no ano de 2015 foram obtidos do site [Cidades](http://cidades.ibge.gov.br/xtras/uf.php?lang=&coduf=25&search=paraiba) do IBGE. Foram analisados 116 municípios do estado da Paraíba que lançaram licitação de merenda no ano 2015.

```{r}
sagres <- src_mysql('sagres', group='ministerio-publico', password=NULL)
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

query <- sql('
  SELECT *
  FROM licitacao
  WHERE de_Obs REGEXP "merenda"
  AND dt_Ano = 2015
')

licitacoes <- tbl(sagres, query) %>%
  compute(name = 'lm') %>%
  collect()

municipios <- tbl(utils, 'municipio') %>%
  collect()

query <- sql('
  SELECT e.*
  FROM empenhos e
  USE INDEX (licitacao)
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

empenhos <- tbl(sagres, query) %>%
  compute(name = 'em') %>%
  collect()

query <- sql('
  SELECT p.*
  FROM pagamentos p
  INNER JOIN em
  USING (cd_UGestora, nu_Empenho, cd_UnidOrcamentaria, dt_Ano)
')

pagamentos <- tbl(sagres, query) %>%
  collect()

```

```{r}
get.municipio <- function(cd_UGestora) {
  result <- data.frame(
      cd_Municipio = str_sub(cd_UGestora, -3)) %>%
    left_join(municipios)
  return(result$de_Municipio)
}
```

```{r}
gasto_municipios <- pagamentos %>%
  select(cd_UGestora, vl_Pagamento) %>%
  group_by(cd_UGestora) %>%
  summarise(Total_Pagamentos = sum(vl_Pagamento)) %>%
  mutate(de_Municipio = get.municipio(cd_UGestora)) %>%
  right_join(dados_escolares, by = c('de_Municipio' = 'cidade')) %>%
  mutate(Valor_Aluno = round(Total_Pagamentos / matritotal, 2)) %>%
  select(c(de_Municipio, Total_Pagamentos, Valor_Aluno))

gasto_municipios$Valor_Aluno_Lvl <- cut(gasto_municipios$Valor_Aluno, 
                                              breaks = c(0, 50, 100, 150, 200, 250, 500),
                                              labels = c('0 a 49', '50 a 99', '100 a 149', '150 a 199', '200 a 249', '250 ou mais'),
                                              include.lowest = TRUE,
                                              ordered_result = TRUE)

```

## Distribuição do valor gasto em merenda por aluno
```{r}
plot_ly(data = gasto_municipios) %>%
  add_histogram(x = ~Valor_Aluno) %>%
  layout(
    title = 'Distribuição do valor por aluno',
    xaxis = list(title = 'Valor por Aluno', dtick = 100),
    yaxis = list(title = 'Total de Ocorrências', fixedrange = TRUE)
  )
```


```{r}
#Está fora de ordem
#gasto_municipios tem 224 observações, o máximo seria 223
mapa_paraiba <- readOGR("./mapa/Municipios.shp")

mapa_paraiba@data <- mapa_paraiba@data %>%
  left_join(gasto_municipios, by = c('Nome_Munic' = 'de_Municipio'))

colors <- colorFactor('OrRd', mapa_paraiba@data$Valor_Aluno_Lvl)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5, 
              weight = 1, 
              fillColor = colors(mapa_paraiba@data$Valor_Aluno_Lvl),
              color = 'black', 
              label = mapa_paraiba@data$Nome_Munic,
              popup = paste('Município: ', mapa_paraiba@data$Nome_Munic, '</br>Custo anual por aluno: R$ ', mapa_paraiba@data$Valor_Aluno),
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Valor_Aluno_Lvl,
            title = "Custo médio por aluno no ano 2015</br>(Em Reais)</span>",
            opacity = 1
  )

```

## Os municípios que mais gastaram no período
```{r}
valores_grandes <- gasto_municipios %>% 
  filter(Valor_Aluno >= quantile(gasto_municipios$Valor_Aluno, .9, na.rm = TRUE)) %>%
  arrange(desc(Valor_Aluno)) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = valores_grandes) %>%
  add_bars(x = ~de_Municipio, y = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que mais gastaram por aluno',
         xaxis = list(title = 'Município'),
         yaxis = list(title = 'Custo por Aluno (Em Reais)', fixedrange = TRUE))
```

## Os municípios que menos gastaram no período
```{r}
valores_pequenos <- gasto_municipios %>% 
  filter(Valor_Aluno <= quantile(gasto_municipios$Valor_Aluno, .1, na.rm = TRUE)) %>%
  arrange(Valor_Aluno) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = valores_pequenos) %>%
  add_bars(x = ~de_Municipio, y = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que menos gastaram por aluno',
         xaxis = list(title = 'Município'),
         yaxis = list(title = 'Custo por Aluno (Em Reais)', fixedrange = TRUE))
```



