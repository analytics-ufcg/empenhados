---
title: "Custo de alimentação por aluno"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r}
library(stringr)
library(maps)
library(ggmap)
library(rgdal)
library(htmltools)
library(leaflet)
library(plotly)
library(knitr)
library(rsagrespb)

library(dplyr)
options(scipen = 999)

```

```{r}
dados_escolares <- load_dados_escolares("../dados/dados_escolares_2015")
```

Você já se perguntou quanto o seu município gasta com a merenda de cada aluno de uma escola pública? Será que o seu município estpa na lista dos que mais gastam? Ou dos que menos gastam? Essas são algumas perguntas que essa análise busca responder. Os dados sobre a quantidade de alunos matriculados em cada município no ano de 2015 foram obtidos do site [Cidades](http://cidades.ibge.gov.br/xtras/uf.php?lang=&coduf=25&search=paraiba) do IBGE. 

```{r}
sagres <- src_mysql('SAGRES_MUNICIPAL', group='ministerio-publico', password=NULL)
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

pagamentos <- get_pagamentos_filtrados(sagres, cd_funcao = 12, cd_subfuncao = 306, cd_subelemento = "02") %>%
    collect(n = Inf)

municipios <- tbl(utils, 'municipio') %>%
  collect()

```

```{r}
get.municipio <- function(cd_UGestora) {
  result <- data.frame(
      cd_Municipio = str_sub(cd_UGestora, -3)) %>%
    left_join(municipios)
  return(result$de_Municipio)
}
```

```{r}
municipios <- municipios %>%
  mutate(matritotal = vl_Matriculas_Fundamental + vl_Matriculas_Medio + vl_Matriculas_Pre_Escolar) %>%
  select(cd_IBGE, cd_Municipio, de_Municipio, vl_IDEB_Anos_Finais, vl_IDEB_Anos_Iniciais, matritotal)
```

```{r}
gasto_municipios <- pagamentos %>%
  filter(dt_Ano == 2015) %>%
  select(cd_UGestora, vl_Pagamento) %>%
  mutate(de_Municipio = get.municipio(cd_UGestora)) %>%
  group_by(de_Municipio) %>%
  summarise(Total_Pagamentos = sum(vl_Pagamento)) %>%
  right_join(municipios, by = c('de_Municipio')) %>%
  mutate(Valor_Aluno = round(Total_Pagamentos / matritotal, 2)) %>%
  select(c(de_Municipio, Total_Pagamentos, Valor_Aluno, matritotal))
```

```{r}
gasto_municipios$Valor_Aluno_Lvl <- cut(gasto_municipios$Valor_Aluno, 
                                              breaks = c(0, 50, 100, 150, 200, 250, 400, 600),
                                              labels = c('R$ 0 a R$ 49', 'R$ 50 a R$ 99', 'R$ 100 a R$ 149', 'R$ 150 a R$ 199', 'R$ 200 a R$ 249', 'R$ 250 a R$ 399', 'R$ 400 ou mais'),
                                              include.lowest = TRUE,
                                              ordered_result = TRUE)
```


## Distribuição do valor gasto em merenda por aluno
Os dados escolares que coletamos são referentes ao ano de 2015, então por meio dos dados obtidos a partir da plataforma [SAGRES](https://sagres.tce.pb.gov.br/) do [Tribunal de Contas do Estado da Paraíba](https://portal.tce.pb.gov.br/) coletamos os pagamentos realizados pelos municípios da Paraíba nesse mesmo ano. 

Esclarecimento: Caso seu município tenha realizado algum pagamento em 2015 referente a um empenho que aponta para a alimentação escolar então o mesmo aparecerá nesse relatório. Caso você queira saber mais sobre o processo de execução orçamentária, o processo de despesa pública e o vocabulário utilizado na área, consulte nosso [post](https://analytics-ufcg.github.io/licitacoes-pb//2017/05/execucaoorcamentaria.html) sobre o assunto.


```{r}
plot_ly(data = gasto_municipios) %>%
  add_histogram(x = ~Valor_Aluno) %>%
  layout(
    title = 'Distribuição do valor por aluno',
    xaxis = list(title = 'Valor por Aluno', dtick = 100),
    yaxis = list(title = 'Total de Ocorrências', fixedrange = TRUE)
  )
```

A média do gasto por aluno, no ano de 2015, é de R\$ `r round(mean(gasto_municipios$Valor_Aluno, na.rm = TRUE), digits = 2)` reais. Esse é o valor gasto pelo município com um aluno durante todo o ano! Se levarmos em consideração que o ano tem 200 dias letivos, temos então que menos de um real é gasto em média por aluno por dia.

A mediana obtida para esse tipo de gasto foi de R\$ `r round(median(gasto_municipios$Valor_Aluno, na.rm = TRUE), digits = 2)` reais. Valor ainda mais baixo que a média, pois esse tipo de medida não é tão afetada por aqueles municípios que gastam muito mais que a maioria.

No mapa abaixo podemos observar quanto cada um dos municípios da Paraíba gastou com merenda no ano de 2015. Os municípios na cor cinza são aqueles que não tiveram pagamentos realizados em 2015 que se encaixassem no filtro utilizado para captar os pagamentos referentes a alimentação escolar.

```{r results = 'hide'}
mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

# Municípios que mudaram de nome ou que estão com o nome errado
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[173] = "Joca Claudino"
levels_mapa[200] = "São Vicente do Seridó"

# Alterações na acentuação dos nomes dos municípios
gasto_municipios$de_Municipio[156] = "Quixabá"
gasto_municipios$de_Municipio[109] = "Mãe d'Água"
gasto_municipios$de_Municipio[131] = "Olho d'Água"
gasto_municipios$de_Municipio[197] = "São Sebastião de Lagoa de Roça"

levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

mapa_paraiba@data <- mapa_paraiba@data %>%
  left_join(gasto_municipios, by = c('Nome_Munic' = 'de_Municipio'))
```

```{r}
colors <- colorFactor('OrRd', mapa_paraiba@data$Valor_Aluno_Lvl)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5, 
              weight = 1, 
              fillColor = colors(mapa_paraiba@data$Valor_Aluno_Lvl),
              color = 'black', 
              label = mapa_paraiba@data$Nome_Munic,
              popup = paste('Município: ', mapa_paraiba@data$Nome_Munic, '</br>Custo anual por aluno: R$ ', mapa_paraiba@data$Valor_Aluno, '</br>Número de alunos matriculados: ', mapa_paraiba@data$matritotal),
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Valor_Aluno_Lvl,
            title = "Custo com alimentação por aluno no ano 2015",
            opacity = 1
  )

```

Já encontrou seu município no mapa? Clique sobre ele e veja o quanto exatamento ele gastou por aluno durante o ano de 2015 e quantos alunos estão matriculados na rede municipal de ensino. Comente no final desse post o que você sabe sobre a merenda do seu município.

### Os municípios que mais gastaram no período
Realizada a análise geral, resta agora observar com mais detalhes os munícipios que apresentam valores extremos. O gráfico a seguir apresenta os 10% dos municípios que mais gastaram com merenda por aluno no estado da Paraíba.

```{r}
valores_grandes <- gasto_municipios %>% 
  filter(Valor_Aluno >= quantile(gasto_municipios$Valor_Aluno, .9, na.rm = TRUE)) %>%
  arrange(desc(Valor_Aluno)) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = valores_grandes) %>%
  add_bars(x = ~de_Municipio, y = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que mais gastaram por aluno',
         xaxis = list(title = 'Município', tickangle = 45),
         yaxis = list(title = 'Custo por Aluno (Em Reais)', fixedrange = TRUE), 
         margin = list(b = 150))
```

Observa-se que Santa Inês e Curral Velho são os dois municípios que mais gastaram com merenda e são os que mais se diferem com relação aos demais. Foi notada a falta nessa lista dos dois munícipios mais populosos da Paraíba: Campina Grande (`r subset(gasto_municipios, gasto_municipios$de_Municipio == 'Campina Grande')$Valor_Aluno` reais) e João Pessoa (`r subset(gasto_municipios, gasto_municipios$de_Municipio == 'João Pessoa')$Valor_Aluno` reais).

### Os municípios que menos gastaram no período
Detalhando o outro extremo, o gráfico a seguir apresenta os 10% dos municípios que menos gastaram com merenda por aluno.

```{r}
valores_pequenos <- gasto_municipios %>% 
  filter(Valor_Aluno <= quantile(gasto_municipios$Valor_Aluno, .1, na.rm = TRUE)) %>%
  arrange(Valor_Aluno) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = valores_pequenos) %>%
  add_bars(x = ~de_Municipio, y = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que menos gastaram por aluno',
         xaxis = list(title = 'Município', tickangle = 45),
         yaxis = list(title = 'Custo por Aluno (Em Reais)', fixedrange = TRUE), 
         margin = list(b = 150))
```

Observa-se alguns valores bem abaixo do que se espera no gasto por aluno anual. Por exemplo, 3 municípios gastaram abaixo de 10 reais por aluno em 2015, são eles Aroeiras, Rio Tinto e Belém. A presença de Campina Grande nessa lista é passível de observação uma vez que ela possuem características bem diferentes das demais desse grupo, por possuir a segunda maior população da paraíba e também um alto número de alunos matriculados na rede municipal de ensino.

### Características de Boa Ventura

A seguir, são apresentados alguns detalhes sobre as licitações e dados escolares referentes ao município de Boa Ventura. Localizado no Sertão da Paraíba, Boa Ventura possui `r subset(municipios, municipios$de_Municipio == 'Boa Ventura')$vl_Populacao` habitantes.

Os dados escolares de Boa Ventura são:

```{r}
  kable(
    x = subset(dados_escolares, dados_escolares$cidade == 'Boa Ventura') %>% select(cidade, doctotal, esctotal, matritotal),
    col.names = c('Município', 'Número de Docentes', 'Número de escolas', 'Número de Matrículas'),
    align = c('c'),
    row.names = FALSE
    )
```

Sabendo algumas características sobre Boa Ventura nota-se que é uma cidade relativamente pequena, com número de matrículas totais de `r subset(dados_escolares, dados_escolares$cidade == 'Boa Ventura')$matritotal` alunos, inferior a média da Paraíba por município que é de `r round(mean(dados_escolares$matritotal), 2)` alunos e a mediana de `r round(median(dados_escolares$matritotal), 2)` alunos.

Boa Ventura, como citado acima foi uma das cidades que menos gastaram por aluno em 2015. Olhando mais a fundo as licitações que envolvem a palavra merenda realizadas por essa cidade em 2015 chega-se a seguinte lista.

```{r}
licitacoes <- licitacoes %>%
   mutate(de_Municipio = get.municipio(cd_UGestora))
```

```{r}
  kable(
    x = subset(licitacoes, licitacoes$de_Municipio == 'Boa Ventura') %>% select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

O valor da licitação mostrado não corresponde necessariamente ao valor empenhado e pago pela Administração Pública. A descrição da licitação está incompleta pois o SAGRES determina um limite de 120 caracteres e alguns municípios ultrapassam indevidamente esse limite, mesmo assim é possível identificar que a mesma se refere a agricultura familiar enquanto complemento para a merenda. Ou seja, talvez outras licitações para alimentação escolar tenham sido feitas nesse município mas não foram coletadas no filtro de merenda.

```{r}
sagres <- src_mysql('sagres', group='ministerio-publico', password=NULL)

query <- sql('
  SELECT *
  FROM licitacao
  WHERE dt_Ano = 2015
')

licitacoes_2015 <- tbl(sagres, query) %>%
  compute(name = 'lm15') %>%
  collect() %>%
   mutate(de_Municipio = get.municipio(cd_UGestora))
```

```{r}
  kable(
    x = subset(licitacoes_2015, licitacoes_2015$de_Municipio == 'Boa Ventura') %>% 
                                  filter(grepl('GENEROS ALIMENTICIOS', de_Obs)) %>%
                                  select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

Caso alteremos o filtro para que todas as licitações que tem em sua descrição a aquisição de gêneros alimentícios, outras duas licitações aparecem como observado acima. Ou seja, as descrições das licitações são genéricas e por vezes o objeto licitado é destinado a diferentes secretarias do município e não exclusivamente a secretaria de educação.

### Características de Rio Tinto

De forma análoga a Boa Ventura, Rio Tinto encontra-se entre as cidades que menos gastam por aluno em 2015. Com `r subset(municipios, municipios$de_Municipio == 'Rio Tinto')$vl_Populacao` habitantes, Rio Tinto possui os seguintes dados escolares.

```{r}
  kable(
    x = subset(dados_escolares, dados_escolares$cidade == 'Rio Tinto') %>% select(cidade, doctotal, esctotal, matritotal),
    col.names = c('Município', 'Número de Docentes', 'Número de escolas', 'Número de Matrículas'),
    align = c('c'),
    row.names = FALSE
    )
```

As licitações que ocorreram em 2015 de Rio Tinto são:

```{r}
  kable(
    x = subset(licitacoes, licitacoes$de_Municipio == 'Rio Tinto') %>% select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

No entanto, talvez existam mais licitações que envolvem merenda e que não foram captadas pelo filtro, como pode ser visto a seguir.

```{r}
## Esse filtro utilizado foi obtido após uma leitura de TODAS as licitações de Rio Tinto em 2015 e intepretação do que parece envolver merenda escolar.

  kable(
    x = subset(licitacoes_2015, licitacoes_2015$de_Municipio == 'Rio Tinto') %>%
                                  filter(grepl('CARNES, FRANGO E FRIOS DIVERSOS DESTINADO A ESTA PREFEITURA|PAES E BOLOS DIVERSOS, PARA ATENDER AS NECESSIDADES DAS SECRETARIAS|GENEROS ALIMENTICIOS DIVERSOS|RUTAS E VERDURAS DIVERSOS|AQUISICAO DE FRUTAS E VERDURAS DIVERSAS, DESTINADO A SECRETARIA DE EDUCACAO', de_Obs)) %>%
                                  select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

Como aconteceu com Boa Ventura, Rio Tinto também possui licitações que parecem envolver merenda mas que não especificam suas descrições e não são capturadas pelo filtro inicial.

### Características de Santa Helena

Ao contrário dos dois últimos municípios apresentados acima, Santa Helena, com `r subset(municipios, municipios$de_Municipio == 'Santa Helena')$vl_Populacao` habitantes,  encontra-se na lista de municípios que mais gastaram por aluno em 2015. Os dados escolares desse município são:

```{r}
 kable(
    x = subset(dados_escolares, dados_escolares$cidade == 'Santa Helena') %>% select(cidade, doctotal, esctotal, matritotal),
    col.names = c('Município', 'Número de Docentes', 'Número de escolas', 'Número de Matrículas'),
    align = c('c'),
    row.names = FALSE
    )
```

As licitações realizadas pelo município em 2015 e que foram caputradas pelo filtro são:

```{r}
  kable(
    x = subset(licitacoes, licitacoes$de_Municipio == 'Santa Helena') %>% select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

Tal licitação fez com que o município de Santa Helena gastasse em 2015 cerca de `r subset(gasto_municipios, gasto_municipios$de_Municipio == 'Santa Helena')$Total_Pagamentos` com merenda escolar. Dentre todas a licitações realizadas em 2015 essa foi a única que trata do fornecimento de merenda à rede municipal de ensino.

### Características de Santa Inês

Santa Inês com `r subset(municipios, municipios$de_Municipio == 'Santa Inês')$vl_Populacao` habitantes foi o município que mais gastou por aluno em 2015, seus dados escolares são:

```{r}
 kable(
    x = subset(dados_escolares, dados_escolares$cidade == 'Santa Inês') %>% select(cidade, doctotal, esctotal, matritotal),
    col.names = c('Município', 'Número de Docentes', 'Número de escolas', 'Número de Matrículas'),
    align = c('c'),
    row.names = FALSE
    )
```

A única licitação que foi capturada pelo filtro de merenda é descrita a seguir. 

```{r}
  kable(
    x = subset(licitacoes, licitacoes$de_Municipio == 'Santa Inês') %>% select(de_Municipio, vl_Licitacao, de_Obs),
    col.names = c('Município', 'Valor da licitação', "Descrição"),
    align = c('c'),
    row.names = FALSE
    )
```

Esse valor da licitação não significa necessariamente o que o município gastou no total. As análises foram feitas seguindo a execução orçamentária dos empenhos e pagamentos associados a respectiva licitação. De todas as licitações em 2015 a única que faz referência a aquisição de gêneros alimentícios destinados a merenda é a apresentada acima, ou seja, nesse caso o filtro conseguiu capturar todas as licitações de merenda.

## Considerações

De acordo com as histórias acima é possível dizer que o filtro utilizado até então, que captura todas as licitações que possuem merenda em sua descrição, fez sentido e obteve sucesso em algumas cidades que mais gastaram por aluno em 2015, uma vez que tais cidades geralmente realizaram apenas uma licitação de merenda para todo o ano. Em geral, as cidades que menos gastaram por aluno em 2015 não tiveram todas as suas licitações capturadas pelo filtro. 

As descrições dessas cidades são genéricas e não tratam especificamente da palavra merenda, embora possivelmente sejam sobre merenda, como por exemplo "AQUISICAO DE GENEROS ALIMENTICIOS DIVERSOS, DESTINADO A SECRETARIA DE EDUCACAO DESTE MUNICIPIO". Outras licitações possuem descrições como: "AQUISICAO PARCELADA E DIARIA DE GENEROS ALIMENTICIOS, DESTINADOS A MERENDA ESCOLAR E DIVERSAS SECRETARIA DESTE MUNICIPIO" - a descrição fala sobre a aquisição de merenda escolar, mas também sobre aquisição de gêneros alimentícios para **diversas** secretarias do munícipio (a licitação tem muitos propósitos), para a análise isso é ruim pois não se consegue identificar com clareza o que foi investido em merenda escolar.

Ou seja, a análise de custo por aluno é válida, no entanto o filtro que captura as licitações de merenda não consegue ser suficientemente preciso ao ponto de capturar a maioria das licitações de alimentação escolar ou merenda. Portanto, algumas cidades tem seus índices de gasto por aluno alterados devido a essa limitação do filtro.

