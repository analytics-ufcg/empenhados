---
title: "Custo de alimentação por aluno"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r}
library(stringr)
library(maps)
library(ggmap)
library(rgdal)
library(htmltools)
library(leaflet)
library(plotly)
library(knitr)
library(rsagrespb)

library(dplyr)
options(scipen = 999)

```

Você já se perguntou quanto o seu município gasta com a merenda de cada aluno de uma escola pública? Será que o seu município estpa na lista dos que mais gastam? Ou dos que menos gastam? Essas são algumas perguntas que essa análise busca responder. Os dados sobre a quantidade de alunos matriculados em cada município no ano de 2015 foram obtidos do site [Cidades](http://cidades.ibge.gov.br/xtras/uf.php?lang=&coduf=25&search=paraiba) do IBGE. 

```{r}
sagres <- src_mysql('SAGRES_MUNICIPAL', group='ministerio-publico', password=NULL)

pagamentos <- get_pagamentos_filtrados(sagres, cd_funcao = 12, cd_subfuncao = 306, cd_subelemento = "02") %>%
    collect(n = Inf)

utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

municipios <- tbl(utils, 'municipio') %>%
  collect()

```

```{r}
get.municipio <- function(cd_UGestora) {
  result <- data.frame(
      cd_Municipio = str_sub(cd_UGestora, -3)) %>%
    left_join(municipios)
  return(result$de_Municipio)
}
```

```{r}
municipios <- municipios %>%
  mutate(matritotal = vl_Matriculas_Fundamental + vl_Matriculas_Medio + vl_Matriculas_Pre_Escolar) %>%
  mutate(esctotal = vl_Escolas_Fundamental + vl_Escolas_Medio, vl_Matriculas_Pre_Escolar) %>%
  select(cd_IBGE, cd_Municipio, de_Municipio, vl_IDEB_Anos_Finais, vl_IDEB_Anos_Iniciais, matritotal, esctotal, vl_Populacao)
```

```{r}
gasto_municipios <- pagamentos %>%
  filter(dt_Ano == 2015) %>%
  select(cd_UGestora, vl_Pagamento) %>%
  mutate(de_Municipio = get.municipio(cd_UGestora)) %>%
  group_by(de_Municipio) %>%
  summarise(Total_Pagamentos = sum(vl_Pagamento)) %>%
  right_join(municipios, by = c('de_Municipio')) %>%
  mutate(Valor_Aluno = round(Total_Pagamentos / matritotal, 2)) %>%
  select(c(de_Municipio, Total_Pagamentos, Valor_Aluno, matritotal))
```

```{r}
gasto_municipios$Valor_Aluno_Lvl <- cut(gasto_municipios$Valor_Aluno, 
                                              breaks = c(0, 50, 100, 150, 200, 250, 400, 600),
                                              labels = c('R$ 0 a R$ 49', 'R$ 50 a R$ 99', 'R$ 100 a R$ 149', 'R$ 150 a R$ 199', 'R$ 200 a R$ 249', 'R$ 250 a R$ 399', 'R$ 400 ou mais'),
                                              include.lowest = TRUE,
                                              ordered_result = TRUE)
```


## Distribuição do valor gasto em merenda por aluno
Os dados escolares que coletamos são referentes ao ano de 2015, então por meio dos dados obtidos a partir da plataforma [SAGRES](https://sagres.tce.pb.gov.br/) do [Tribunal de Contas do Estado da Paraíba](https://portal.tce.pb.gov.br/) coletamos os pagamentos realizados pelos municípios da Paraíba nesse mesmo ano. 

Esclarecimento: Caso seu município tenha realizado algum pagamento em 2015 referente a um empenho que aponta para a alimentação escolar então o mesmo aparecerá nesse relatório. Caso você queira saber mais sobre o processo de execução orçamentária, o processo de despesa pública e o vocabulário utilizado na área, consulte nosso [post](https://analytics-ufcg.github.io/licitacoes-pb//2017/05/execucaoorcamentaria.html) sobre o assunto.


```{r}
plot_ly(data = gasto_municipios) %>%
  add_histogram(x = ~Valor_Aluno) %>%
  layout(
    title = 'Distribuição do valor por aluno',
    xaxis = list(title = 'Valor por Aluno', dtick = 100),
    yaxis = list(title = 'Total de Ocorrências', fixedrange = TRUE)
  )
```

A média do gasto por aluno, no ano de 2015, é de R\$ `r round(mean(gasto_municipios$Valor_Aluno, na.rm = TRUE), digits = 2)` reais. Esse é o valor gasto pelo município com um aluno durante todo o ano! Se levarmos em consideração que o ano tem 200 dias letivos, temos então que menos de um real é gasto em média por aluno por dia.

A mediana obtida para esse tipo de gasto foi de R\$ `r round(median(gasto_municipios$Valor_Aluno, na.rm = TRUE), digits = 2)` reais. Valor ainda mais baixo que a média, pois esse tipo de medida não é tão afetada por aqueles municípios que gastam muito mais que a maioria.

No mapa abaixo podemos observar quanto cada um dos municípios da Paraíba gastou com merenda no ano de 2015. Os municípios na cor cinza são aqueles que não tiveram pagamentos realizados em 2015 que se encaixassem no filtro utilizado para captar os pagamentos referentes a alimentação escolar.

```{r results = 'hide'}
mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

# Municípios que mudaram de nome ou que estão com o nome errado
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[173] = "Joca Claudino"
levels_mapa[200] = "São Vicente do Seridó"

# Alterações na acentuação dos nomes dos municípios
gasto_municipios$de_Municipio[156] = "Quixabá"
gasto_municipios$de_Municipio[109] = "Mãe d'Água"
gasto_municipios$de_Municipio[131] = "Olho d'Água"
gasto_municipios$de_Municipio[197] = "São Sebastião de Lagoa de Roça"

levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

mapa_paraiba@data <- mapa_paraiba@data %>%
  left_join(gasto_municipios, by = c('Nome_Munic' = 'de_Municipio'))
```

```{r}
colors <- colorFactor('OrRd', mapa_paraiba@data$Valor_Aluno_Lvl)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5, 
              weight = 1, 
              fillColor = colors(mapa_paraiba@data$Valor_Aluno_Lvl),
              color = 'black', 
              label = mapa_paraiba@data$Nome_Munic,
              popup = paste('Município: ', mapa_paraiba@data$Nome_Munic, '</br>Custo anual por aluno: R$ ', mapa_paraiba@data$Valor_Aluno, '</br>Número de alunos matriculados: ', mapa_paraiba@data$matritotal),
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Valor_Aluno_Lvl,
            title = "Custo com alimentação por aluno no ano 2015",
            opacity = 1
  )

```

Já encontrou seu município no mapa? Clique sobre ele e veja o quanto exatamento ele gastou por aluno durante o ano de 2015 e quantos alunos estão matriculados na rede municipal de ensino. Comente no final desse post o que você sabe sobre a merenda do seu município.

### Os municípios que mais gastaram no período
Deu pra perceber no mapa que alguns municípios são bem escuros, ou seja gastaram 400 reais ou mais por aluno em 2015. Abaixo listamos os 6 municípios que mais gastaram por aluno.

```{r}
valores_grandes <- gasto_municipios %>% 
  arrange(desc(Valor_Aluno)) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = head(valores_grandes, 6), orientation = 'h') %>%
  add_bars(y = ~reorder(de_Municipio, Valor_Aluno), x = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que mais gastaram por aluno',
         xaxis = list(title = 'Custo por Aluno (Em Reais)'),
         yaxis = list(title = '', fixedrange = TRUE), 
         margin = list(b = 100, l = 175))
```

São José do Brejo do Cruz realizou pagamentos referentes a empenhos de merenda em 2015 que totalizaram quase 600 reais por aluno. Ao considerarmos um ano letivo com 200 dias, cerca de 3 reais por aluno por dia foi gasto nesse município. Na segunda colocação dos que mais gastam por aluno, temos São José da Lagoa Tapada com pouco mais de 500 reais por aluno ao ano. Vamos entender mais um pouco sobre o município de São José do Brejo do Cruz.

Localizado no Sertão da Paraíba, São José do Brejo do Cruz possui `r subset(municipios, municipios$de_Municipio == 'São José do Brejo do Cruz')$vl_Populacao` habitantes. Algumas informações sobre esse município são apresentadas a seguir:

```{r}
  kable(
    x = subset(municipios, municipios$de_Municipio == 'São José do Brejo do Cruz') %>% select(de_Municipio, vl_Populacao, esctotal, matritotal, vl_IDEB_Anos_Iniciais, vl_IDEB_Anos_Finais),
    col.names = c('Município', 'População', 'Número de escolas', 'Número de Matrículas', 'IDEB (Anos Iniciais)', 'IDEB (Anos Finais)'),
    align = c('c'),
    row.names = FALSE
    )
```

Os dados do IDEB apresentados acima estão disponíveis [aqui](http://www.qedu.org.br/estado/115-paraiba/ideb/ideb-por-municipios) e se referem ao Índice de Desenvolvimento da Educação Básica das escolas públicas do município (municipais e estaduais). São josé do Brejo do Cruz possui índices no IDEB nas séries iniciais maior que a mediana do restante dos municípios (`r median(municipios$vl_IDEB_Anos_Iniciais)`), o mesmo é observado com o IDEB das séries finais (`r median(municipios$vl_IDEB_Anos_Finais)`). 

### Os municípios que menos gastaram no período
Sobre os municípios que menos gastaram por aluno em 2015, temos 5 municípios que realizaram pagamentos que totalizaram menos de 10 reais por aluno por ano. Valor este bem baixo se comparado a mediana do gasto nos municípios da Paraíba que é de `r median(gasto_municipios$Valor_Aluno, na.rm = TRUE)` reais.

```{r}
valores_pequenos <- gasto_municipios %>% 
  arrange(Valor_Aluno) %>%
  mutate(de_Municipio = factor(de_Municipio, levels = de_Municipio))

plot_ly(data = head(valores_pequenos,6)) %>%
  add_bars(y = ~reorder(de_Municipio, Valor_Aluno), x = ~Valor_Aluno) %>%
  layout(title = 'Os municípios que menos gastaram por aluno',
         xaxis = list(title = 'Custo por Aluno (Em Reais)'),
         yaxis = list(title = '', fixedrange = TRUE), 
         margin = list(b = 100, l = 175))
```

Serra Branca gastou menos de 1 real por aluno durante todo o ano de 2015 em pagamentos que são de empenhos de alimentação escolar. Ao olharmos mais a fundo sobre as características de educação do município temos que:

```{r}
  kable(
    x = subset(municipios, municipios$de_Municipio == 'Serra Branca') %>% select(de_Municipio, vl_Populacao, esctotal, matritotal, vl_IDEB_Anos_Iniciais, vl_IDEB_Anos_Finais),
    col.names = c('Município', 'População', 'Número de escolas', 'Número de Matrículas', 'IDEB (Anos Iniciais)', 'IDEB (Anos Finais)'),
    align = c('c'),
    row.names = FALSE
    )
```

Não é comum que um município com 1359 alunos matriculados tenha gasto menos de 1 real por aluno durante todo o ano. Uma das causas possíveis é de que esse município não possui dados corretamente preenchidos no SAGRES - TCE o que faz com que o mesmo não seja capturado pelo filtro. Tal prática pode ser um indício de que algo de errado ocorreu no momento de inserir as informações referentes aos empenhos.

### Os municípios que não realizaram pagamentos
Como falado anteriormente alguns municípios que estão em cinza no mapa são aqueles que não possuem pagamentos atrelados a empenhos que são filtrados como Alimentação Escolar. Não cabe a essa análise afirmar que esses municípios não gastaram com merenda em 2015, apenas que não existem empenhos classificados como Alimentação Escolar ligados a esse município, o que não deixa de ser estranho.

```{r}
  kable(
    x = subset(municipios, municipios$de_Municipio %in% subset(gasto_municipios, is.na(gasto_municipios$Valor_Aluno))$de_Municipio) %>% select(de_Municipio, vl_Populacao, esctotal, matritotal, vl_IDEB_Anos_Iniciais, vl_IDEB_Anos_Finais),
    col.names = c('Município', 'População', 'Número de escolas', 'Número de Matrículas', 'IDEB (Anos Iniciais)', 'IDEB (Anos Finais)'),
    align = c('c'),
    row.names = FALSE
    )
```

Conforme mostrado acima existem alunos matriculados nesses municípios e provavelmente os mesmos gastaram com merenda em 2015 mas não preencheram corretamente os dados dos empenhos referentes a alimentação escolar.

