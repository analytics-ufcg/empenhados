---
title: "Descrição dos compradores e fornecedores de merenda"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: false
comments: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10)

options(scipen = 999)
```

```{r adicao de bibliotecas}
library(ggthemes)
library(corrplot)
library(ggplot2)
library(plotly)

library(RColorBrewer)
library(scales)

library(tidyr)
library(plyr)
library(dplyr)

library(tm)
library(wordcloud)
library(stringr)

library(maps)   # mapas simples, eixos, escala, cidades
library(ggmap)  # Gmaps, OSM + mapas baseados em ggplot2
library(rgdal)
library(leaflet)
library(htmltools)

library(knitr)
library(methods)

library(rsagrespb)

library(lubridate)
```

```{r}
utils = src_mysql('utils', group='ministerio-publico', password=NULL)
municipios = tbl(utils, 'municipio') %>%
  collect()

sagres = src_mysql('SAGRES_MUNICIPAL', group='ministerio-publico', password=NULL)

empenhos_merenda <- get_empenhos_filtrados(dbcon = sagres, cd_funcao = 12, cd_subfuncao = 306, cd_subelemento = "02") %>%
  collect(n = Inf) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios %>% select(cd_Municipio, de_Municipio), 'cd_Municipio') %>%
  mutate(cd_Municipio = as.integer(cd_Municipio)) %>%
  select(-cd_UnGestora)

licitacoes <- tbl(sagres, 'Licitacao') %>%
  filter(year(dt_Homologacao) >= 2003 & year(dt_Homologacao) <= 2016) %>%
  collect(n = Inf) %>%
  mutate(dt_Homologacao = ymd_hms(dt_Homologacao))

## Adicionando código do município a tabela de licitações
licitacoes <- licitacoes %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios %>% select(cd_Municipio, de_Municipio), 'cd_Municipio') %>%
  select(-cd_UnGestora)

empenhos_merenda_group <- empenhos_merenda %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise(valor_merenda = sum(vl_Empenho))

empenhos <- tbl(sagres, 'Empenhos') %>%
  select(c(cd_UGestora, dt_Ano, cd_UnidOrcamentaria, nu_Empenho, vl_Empenho, dt_Empenho)) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  collect(n = Inf) %>%
  mutate(dt_Empenho = ymd_hms(dt_Empenho)) %>%
  filter(year(dt_Empenho) >= 2003 & year(dt_Empenho) <= 2016) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios %>% select(cd_Municipio, de_Municipio), 'cd_Municipio') %>%
  select(-cd_UnGestora) 

licitacoes_merenda <- licitacoes %>% 
  right_join(empenhos_merenda_group, by = c('cd_UGestora', 'nu_Licitacao', 'tp_Licitacao'))
```

Alguma vez você já se perguntou como os gestores de seu município empregam o dinheiro que recebem? 
Se sua resposta para a pergunta anterior foi sim, é possível que você tenha sentido dificuldades para reunir informações relevantes, que ajudassem a chegar numa conclusão bem fundamentada, ou que tenha até mesmo coletado tais informações, mas acabou por não saber o que fazer com elas. Problemas como esses são bem comuns ao se lidar com dados relacionados ao orçamento dos municípios e, muitas vezes, afastam o cidadão de seu papel de fiscalizador das ações do estado. Tentando trazer o cidadão de volta a esse papel, foi elaborado esse relatório, onde esperamos facilitar o entendimento sobre os gastos dos municípios da Paraíba, até mesmo se você tenha respondido não à questão anterior :)  

Antes de iniciarmos, alguns pontos importantes precisam ser esclarecidos. Uma etapa muito importante no processo de gastos públicos é a licitação. É por meio dela que a administração pública contrata serviços, realiza obras e compra produtos, por exemplo. Ela é o ponto de inicial de quase todo processo de investimento de receitas públicas, salvo algumas exceções onde podem ser dispensadas ou não são aplicáveis. Para obter mais detalhes sobre tais exceções, é possível acessar as leis [8666/1993](http://www.planalto.gov.br/ccivil_03/leis/L8666cons.htm) e [10520/2002](http://www.planalto.gov.br/ccivil_03/leis/2002/l10520.htm), onde estão definidas as regras para o processo licitatório.  

Os dados utilizados nesse relatório foram obtidos a partir da plataforma [SAGRES](https://sagres.tce.pb.gov.br/) do [Tribunal de Contas do Estado da Paraíba](https://portal.tce.pb.gov.br/) e a parcela deles utilizada compreende informações sobre o processo de gastos públicos dos municípios do estado entre os anos de 2003 e 2016. Uma das principais limitações encontradas ao se trabalhar com os dados dessa fonte surge da possibilidade das prefeituras contratarem vários serviços ou adquirirem produtos com finalidades distintas em um único processo licitatório. Os itens que compreendem essas licitações não estão descritos nos dados obtidos, o que dificulta bastante a obtenção de informações como o valor, total ou fornecedor de cada um deles. 

## Panorama
### Qual o número de licitações realizadas em cada ano do período analisado?
Uma boa forma de obtermos uma visão geral de nossos dados, é verificar quantas licitações foram realizadas a cada ano durante o período analisado. Fazendo isso, uma coisa bastante interessante pode ser vista: há três 'saltos' no total de licitações realizadas. O primeiro desses saltos ocorre em 2005, quando há um aumento de 66% no número de licitações realizadas. Em seguida, há um novo salto em 2009, sendo de 33% o aumento no número de licitações. O último salto ocorre em 2013 e o aumento é de 52%. O que esses anos teriam em comum? Os três marcam o início dos mandatos municipais.


```{r}
licitacoes %>%
  plot_ly() %>%
    add_histogram(x = ~as.factor(year(dt_Homologacao))) %>%
    layout(title = "Total de licitações por ano",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Ano')) 
```


## Como costuma ser o processo licitatório dos municípios do estado?
Outra coisa interessante de ser analisada é o padrão de licitação dos municípios. Por meio disso, podemos descobrir quais são os municípios que mais realizam licitações de merenda e quantos itens, em média, há nas licitações desses municípios.
Feita essa análise, descobrimos que dos cinco municípios que mais realizam licitações, quatro também estão presentes na lista dos mais populosos do estado. São eles: João Pessoa, Campina Grande, Santa Rita e Patos. A exceção aqui fica por conta do município de Pombal, que não está entre os quinze municípios mais populosos do estado e é o quinto maior realizador de licitações.


```{r}
cinco_mais <- licitacoes %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  arrange(desc(total_licitacoes)) %>%
  head(5) %>%
  select(de_Municipio)

licitacoes %>%
  inner_join(cinco_mais, by = "de_Municipio") %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  plot_ly() %>%
    add_bars(x = ~de_Municipio, y=~total_licitacoes) %>%
    layout(title = "Municipios que mais licitaram",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Município')) 
```


Aprofundando essa mesma ideia, buscamos verificar como o total de licitações realizados nesses municípios variou durante os anos observados. Dessa vez, chama atenção o caso de João Pessoa, que apresentou uma queda drástica no número de licitações realizadas entre os anos de 2013 e 2016. 


```{r}
licitacoes %>%
  inner_join(cinco_mais, by = "de_Municipio") %>%
  mutate(dt_Ano_Homologacao = as.numeric(year(dt_Homologacao))) %>%
  group_by(de_Municipio, dt_Ano_Homologacao) %>%
  summarise(total_por_ano = n()) %>%
  plot_ly() %>%
    add_trace(x=~dt_Ano_Homologacao, y=~total_por_ano, color=~de_Municipio, type = "scatter", mode="lines+markers") %>%
    layout(title = "Total anual de licitações nos 5 municípios que mais licitaram",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Ano')) 
```


Aqui cabe uma explicação: Uma diminuição ou aumento no total de licitações realizadas, não necessariamente implica que houve menos ou mais compras ou contratações. Precisamos lembrar que uma única licitação pode compreender vários itens, e, por isso, análise do total de licitações serve principalmente como uma verificação dos hábitos licitatórios de cada prefeitura. A verificação do total de materiais adquiridos e serviços contratados pode ser *aproximada* utilizando as diferentes compensações financeiras geradas pela licitação, representadas geralmente na forma de **empenhos**. Esse é o próximo passo que vamos tomar.


```{r}
empenhos %>%
  inner_join(cinco_mais, by = "de_Municipio") %>%
  mutate(dt_Ano) %>%
  group_by(de_Municipio, dt_Ano) %>%
  summarise(total_por_ano = n()) %>%
  plot_ly() %>%
     add_trace(x=~dt_Ano, y=~total_por_ano, color=~de_Municipio, type = "scatter", mode="lines+markers") %>%
    layout(title = "Total anual de empenhos nos 5 municípios que mais licitaram",
           yaxis = list(title = 'Número total de empenhos', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Ano')) 
```


Um ponto que ilustra bem a diferença que pode ocorrer entre o número de licitações realizadas e o número de empenhos gerados é a situação de Campina Grande entre os anos de 2006 e 2008. Nesse período, o total de licitações realizados no município se manteve estável, mas a quantidade de empenhos realizados variou bastante, subindo quase 100% em 2007 e caindo cerca de 50% no ano seguinte.

A partir do gráfico acima, podemos observar que, assim como a quantidade de licitações, a quantidade de empenhos realizados na cidade de João Pessoa diminuiu entre os anos de 2013 e 2016. Outro ponto que podemos observar é o crescimento constante no número de empenhos realizados no município de Pombal entre os anos 2009 e 2015, apesar da flutuação no número de licitações realizadas, principalmente nos últimos anos do período.


## 2 - Análise de Licitações
Agora que entendemos melhor nossos dados e variáveis, podemos ir mais a fundo! Escolhemos trabalhar com dados relacionados com a __merenda escolar dos municípios da paraíba entre 2012 e 2016__.
Você sabe quanto o seu município gastou com merenda nos últimos anos? Será que ele está dentro da média da Paraíba? Quantas licitações são feitas para alimentação escolar? Quem gasta mais? Quem gasta menos? Essas e muitas outras perguntas podem ser respondidas pela análise abaixo.  
### Quantas licitações de merenda são feitas por ano?

```{r}
licitacoes_merenda <- licitacoes_merenda %>%
  filter(year(dt_Homologacao) >= 2012 & year(dt_Homologacao) <= 2016)

plot_ly(data = licitacoes 
        %>% filter(year(dt_Homologacao) >= 2012 & year(dt_Homologacao) <= 2016)) %>%
  add_histogram(x = ~as.factor(year(dt_Homologacao)), name = "Outras as licitações") %>%
  add_histogram(data = licitacoes_merenda, ~as.factor(year(dt_Homologacao)), name = "Merenda Escolar") %>%
  layout(title = "Total de licitações de merenda em relação ao total de licitações",
         yaxis = list(title = 'Número de licitações', hoverformat= '.0f'),
         xaxis = list(title = 'Ano'),
         barmode = 'overlay')
```

Temos uma grande quantidade de licitações, envolvendo os mais diversos itens, mas neste trabalho estamos interessados nos dados que dizem respeito a merenda escolar, então a partir daqui nosso foco será sobre este subconjunto de informação, assim os dados que vamos estudar estão dispostos nos gráfico abaixo.

```{r}
plot_ly(data = licitacoes_merenda, x = ~as.factor(year(dt_Homologacao)), type='histogram') %>%
  layout(
    xaxis = list(title = "Ano"),
    yaxis = list(title = "Número total de licitações"),
    title = "Total de licitações de merenda por ano")
```


Podemos perceber que houve um "salto" no número de licitações entre 2012 e 2013, o que indica que os municípios passaram fazer mais licitações envolvendo merenda.
 
### Quem faz mais licitações?


```{r results='hide'}
mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

# Atualizando nome de municípios que mudaram de nome nos últimos anos
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "São Vicente do Seridó"
levels_mapa[173] = "Joca Claudino"
levels_mapa[156] = "Quixaba"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

# Join entre a tabela de licitações e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = licitacoes_merenda %>% 
  inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n(),
            valor_medio_emp = mean(valor_merenda),
            valor_total_emp = sum(valor_merenda),
            total_num = n(),
            valor_total_emp_num = sum(valor_merenda))

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total,
                                breaks = c(1,5,7,10,15,25,50, 120),
                               labels = c("de 1 a 5", "de 5 a 7", "de 7 a 10", "de 10 a 15", "de 15 a 25", "de 25 a 50", "Acima de 50"),
                                include.lowest = F)

paraiba_sumarizado$valor_total_emp <- cut(paraiba_sumarizado$valor_total_emp,
                                         breaks = c(1, 250000, 500000, 750000, 1000000, 2000000, 4000000,1000000000),
                                         labels = c("De 1 a 250", "De 250 a 500", "De 500 a 750", "De 750 a 1000", "De 1000 a 2000", "De 2000 a 4000", "Acima de 4000"))

levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

```

```{r}
colors = brewer.pal(6,"YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total
mapa_paraiba@data$X <- paraiba_municipios$total_num
colors = colorFactor('OrRd', mapa_paraiba@data$Y)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa_paraiba@data$Y),
              color = 'black',
              label = paste(mapa_paraiba@data$Nome_Munic),
              popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                            "Número de Licitações: ", mapa_paraiba@data$X),
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Y,
            title = "Licitações por município",
            opacity = 1, na.label = "0"
  )
```

Os municípios que mais fizeram licitações envolevendo merenda foram:

```{r}
kable(
  x = head(arrange(select(paraiba_sumarizado, c(de_Municipio, total_num)), desc(total_num)), 10),
  col.names = c('Município', 'Número de Licitações'),
  align = c('c'))
```

 
### Quem gasta mais?

Aqui, vamos analisar os municípios que mais gastam recursos com merenda escolar.
Para isso consideramos como gasto com merenda escolar a soma de tudo que foi _empenhado_ no período em estudo que diz respeito a merenda escolar. 

```{r}
colors = brewer.pal(7,"YlOrRd")
mapa_paraiba@data$Y <- paraiba_municipios$valor_total_emp
mapa_paraiba@data$X <- paraiba_municipios$valor_total_emp_num
colors = colorFactor('OrRd', mapa_paraiba@data$Y)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa_paraiba@data$Y),
              color = 'black',
              label = mapa_paraiba@data$Nome_Munic,
              popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                            "Valor empenhado para merenda: ", mapa_paraiba@data$X),
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Y,
            title = "Valor total dos empenhos de merenda (em milhares)",
            opacity = 1, na.label = "0"
  )
```

```{r}
kable(
  x = head(arrange(select(paraiba_sumarizado, c(de_Municipio, valor_total_emp_num)), desc(valor_total_emp_num)), 10),
  col.names = c('Município', 'Valor total dos empenhos de merenda'),
  align = c('c'))
```


### 2.3 - Qual a distribuição do valor total de licitações de merenda escolar entre todos os municípios da Paraíba?

### 2.7 - Qual o comportamento da média e da mediana do valor das licitações de merenda ao longo dos anos (2011-2015)?

### 2.8 - Em que período do ano ocorrem mais licitações de merenda?
### 2.9 - Em geral, as licitaçoes mais caras estão concentradas em alguma época do ano?

### 2.13 - Que modalidade de licitação é mais comum na compra de merenda?
### 2.14 - O valor médio da licitação alterou ao longo dos anos com relação às modalidades de licitação?
### 2.15 - A popularidade de alguma modalidade de licitação mudou ao longo dos anos?

### 2.16 - Geralmente, quantas propostas são recebidas para licitações de merenda?
### 2.17 - O valor da licitação está relacionado com o total de propostas recebidas?
### 2.18 - Qual a relação entre o total de licitações de merenda e o número de propostas por modalidade?
