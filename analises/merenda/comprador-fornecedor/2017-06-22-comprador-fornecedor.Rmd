---
title: "Descrição dos compradores e fornecedores de merenda"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: false
comments: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.cap = '',
  fig.align = 'center',
  fig.width = 10)

options(scipen = 999)
```

```{r adicao de bibliotecas}
library(ggthemes)
library(corrplot)
library(ggplot2)
library(plotly)

library(RColorBrewer)
library(scales)

library(tidyr)
library(plyr)
library(dplyr)

library(tm)
library(wordcloud)
library(stringr)

library(maps)   # mapas simples, eixos, escala, cidades
library(ggmap)  # Gmaps, OSM + mapas baseados em ggplot2
library(rgdal)
library(leaflet)
library(htmltools)

library(knitr)
library(methods)

library(rsagrespb)

library(lubridate)
```

```{r}
sagres = src_mysql('SAGRES_MUNICIPAL', group='ministerio-publico', password=NULL)

empenhos_merenda <- get_empenhos_filtrados(dbcon = sagres, cd_funcao = 12, cd_subfuncao = 306, cd_subelemento = 2) %>%
  collect(n = Inf)

licitacoes <- tbl(sagres, 'Licitacao') %>%
  filter(year(dt_Homologacao) >= 2003 & year(dt_Homologacao) <= 2016) %>%
  collect(n = Inf) %>%
  mutate(dt_Homologacao = ymd_hms(dt_Homologacao))

empenhos_merenda_group <- empenhos_merenda %>%
  group_by(cd_UGestora, nu_Licitacao, tp_Licitacao) %>%
  summarise(valor_merenda = sum(vl_Empenho))

licitacoes_merenda <- licitacoes %>% 
  right_join(empenhos_merenda_group, by = c('cd_UGestora', 'nu_Licitacao', 'tp_Licitacao'))

utils = src_mysql('utils', group='ministerio-publico', password=NULL)
municipios = tbl(utils, 'municipio') %>%
  collect()
```

```{r}
## Adicionando código do município a tabela de licitações
licitacoes <- licitacoes %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios %>% select(cd_Municipio, de_Municipio), 'cd_Municipio') %>%
  select(-cd_UnGestora)
```

Alguma vez você já se perguntou como os gestores de seu município empregam o dinheiro que recebem? 
Se sua resposta para a pergunta anterior foi sim, é possível que você tenha sentido dificuldades para reunir informações relevantes, que ajudassem a chegar numa conclusão bem fundamentada, ou que tenha até mesmo coletado tais informações, mas acabou por não saber o que fazer com elas. Problemas como esses são bem comuns ao se lidar com dados relacionados ao orçamento dos municípios e, muitas vezes, afastam o cidadão de seu papel de fiscalizador das ações do estado. Tentando trazer o cidadão de volta a esse papel, foi elaborado esse relatório, onde esperamos facilitar o entendimento sobre os gastos dos municípios da Paraíba, até mesmo se você tenha respondido não à questão anterior :)  

Antes de iniciarmos, alguns pontos importantes precisam ser esclarecidos. Uma etapa muito importante no processo de gastos públicos é a licitação. É por meio dela que a administração pública contrata serviços, realiza obras e compra produtos, por exemplo. Ela é o ponto de inicial de quase todo processo de investimento de receitas públicas, salvo algumas exceções onde podem ser dispensadas ou não são aplicáveis. Para obter mais detalhes sobre tais exceções, é possível acessar as leis [8666/1993](http://www.planalto.gov.br/ccivil_03/leis/L8666cons.htm) e [10520/2002](http://www.planalto.gov.br/ccivil_03/leis/2002/l10520.htm), onde estão definidas as regras para o processo licitatório.  

Os dados utilizados nesse relatório foram obtidos a partir da plataforma (SAGRES)[https://sagres.tce.pb.gov.br/] do (Tribunal de Contas do Estado da Paraíba)[https://portal.tce.pb.gov.br/] e a parcela deles utilizada compreende informações sobre o processo de gastos públicos dos municípios do estado entre os anos de 2003 e 2016. Uma das principais limitações encontradas ao se trabalhar com os dados dessa fonte surge da possibilidade das prefeituras contratarem vários serviços ou adquirirem produtos com finalidades distintas em um único processo licitatório. Os itens que compreendem essas licitações não estão descritos nos dados obtidos, o que dificulta bastante a obtenção de informações como o valor, total ou fornecedor de cada um deles. 

## Panorama
### Qual o número de licitações realizadas em cada ano do período analisado?
Uma boa forma de obtermos uma visão geral de nossos dados, é verificar quantas licitações foram realizadas a cada ano durante o período analisado. Fazendo isso, uma coisa bastante interessante pode ser vista: há três 'saltos' no total de licitações realizadas. O primeiro desses saltos ocorre em 2005, quando há um aumento de 66% no número de licitações realizadas. Em seguida, há um novo salto em 2009, sendo de 33% o aumento no número de licitações. O último salto ocorre em 2013 e o aumento é de 52%. O que esses anos teriam em comum? Os três marcam o início dos mandatos municipais.


```{r}
licitacoes %>%
  plot_ly() %>%
    add_histogram(x = ~as.factor(year(dt_Homologacao))) %>%
    layout(title = "Total de licitações por ano",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Ano')) 
```


### 
Outra coisa interessante de ser analisada é o padrão de licitação dos municípios. Por meio disso, podemos descobrir quais são os municípios que mais e menos realizam licitações de merenda e quantos itens, em média, há nas licitações desses municípios.

```{r}
dez_mais <- licitacoes %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  arrange(desc(total_licitacoes)) %>%
  head(10) %>%
  select(de_Municipio)

licitacoes %>%
  inner_join(dez_mais, by = "de_Municipio") %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  plot_ly() %>%
    add_bars(x = ~de_Municipio, y=~total_licitacoes) %>%
    layout(title = "Municipios que mais licitaram",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Município')) 
```

```{r}
# licitacoes %>%
#   inner_join(dez_mais, by = "de_Municipio") %>%
#   group_by(de_Municipio, year(dt_Homologacao)) %>%
#   summarise(total_por_ano = n()) %>%
#   plotly() %>%
#     add_trace(x=~year(dt_Homologacao), y=~total_por_ano, type = "scatter", mode="lines+markers")
```

```{r}
dez_menos <- licitacoes %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  arrange(desc(total_licitacoes)) %>%
  tail(10) %>%
  select(de_Municipio)

licitacoes %>%
  inner_join(dez_menos, by="de_Municipio") %>%
  group_by(de_Municipio) %>%
  summarise(total_licitacoes = n()) %>%
  plot_ly() %>%
    add_bars(x = ~de_Municipio, y=~total_licitacoes) %>%
    layout(title = "Municipios que menos licitaram",
           yaxis = list(title = 'Número total de licitações', hoverformat= '.0f', fixedrange = TRUE),
           xaxis = list(title = 'Município')) 
```



## 2 - Análise de Licitações
Agora que entendemos melhor os nossos dados, podemos ir mais a fundo! Você sabe __como os municípios da paraíba licitam merenda?__. As seções seguintes nos ajudaráo a responder a essa pergumta.

### 2.1 - Quantas licitações de merenda são feitas por ano?

```{r}
licitacoes_merenda <- licitacoes_merenda %>%
  filter(dt_Ano >= 2011 & dt_Ano <= 2015)

plot_ly(data = licitacoes %>% filter(dt_Ano >= 2011 & dt_Ano <= 2015)) %>%
  add_histogram(x = ~as.factor(dt_Ano), name = "Outras as licitações") %>%
  add_histogram(data = licitacoes_merenda, ~as.factor(dt_Ano), name = "Merenda Escolar") %>%
  layout(title = "Total de licitações de merenda em relação ao total de licitações",
         yaxis = list(title = 'Número de licitações', hoverformat= '.0f'),
         xaxis = list(title = 'Ano'),
         barmode = 'overlay')
```
Temos uma grande quantidade de licitações, envolvendo os mais diversos itens, mas neste trabalho estamos interessados nos dados que dizem respeito a merenda escolar, então a partir daqui nosso foco será sobre este subconjunto de informação. Emtão ficamos com o gráfico abaixo:

```{r}
plot_ly(data = licitacoes_merenda, x = ~as.factor(dt_Ano), type='histogram') %>%
  layout(
    xaxis = list(title = "Ano"),
    yaxis = list(title = "Número total de licitações"),
    title = "Total de licitações de merenda por ano")
```
Podemos perceber que houve um "salto" no número de licitações entre 2012 e 2013, o que indica que os municípios passaram fazer mais licitações envolvendo merenda. Infelizmente, com os dados que temos não somos capazes de justificar essa alteração.
 
### 2.2 Quais são os municípios que mais licitam merenda?
```{r}

municipios_nome <- municipios %>%
  subset(select = c(cd_Municipio, de_Municipio))

licitacoes_merenda <- licitacoes_merenda %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  left_join(municipios_nome, 'cd_Municipio')

mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

# Atualizando nome de municípios que mudaram de nome nos últimos anos
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

# Join entre a tabela de licitações e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = licitacoes_merenda %>% 
  inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n(),
            valor_medio_lic = mean(vl_Licitacao),
            valor_medio_emp = mean(valor_merenda),
            valor_total_lic = sum(vl_Licitacao),
            valor_total_emp = sum(valor_merenda),
            total_num = n())

paraiba_sumarizado = paraiba_sumarizado %>%
  mutate(valor_medio_lic_original = valor_medio_lic) %>%
  mutate(valor_total_lic_original = valor_total_lic)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total,
                                breaks = c(0,3,5,7,10,15,25,50),
                               labels = c("de 1 a 3", "de 3 a 5", "de 5 a 7", "de 7 a 10", "de 10 a 15", "de 15 a 25", "de 25 a 50"),
                                include.lowest = T)

paraiba_sumarizado$valor_medio_lic = cut(paraiba_sumarizado$valor_medio_lic,
                                         breaks = c(0, 50000, 100000, 200000, 300000, 500000, 1000000, 2000000, 21000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 200", "De 200 a 300",  "De 300 a 500",
                                                    "De 500 a 1000", "De 1000 a 2000",  "Acima de 2000"),
                                         include.lowest = T)

paraiba_sumarizado$valor_total_lic = cut(paraiba_sumarizado$valor_total_lic,
                                         breaks = c(0, 50000, 100000, 250000, 500000, 1000000, 5000000, 10000000,
                                                    25000000, 50000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 500", "De 500 a 1000",
                                                    "De 1000 a 2500", "De 1000 a 5000", "De 5000 a 10000", "De 10000 a 25000",
                                                    "De 25000 a 50000"),
                                         include.lowest = T
                                         )

# Criando um data frame com os municípios na ordem do mapa
levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

colors = brewer.pal(6,"YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total

colors = colorFactor('OrRd', mapa_paraiba@data$Y)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa_paraiba@data$Y),
              color = 'black',
              label = mapa_paraiba@data$Nome_Munic,
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Y,
            title = "Licitações por município",
            opacity = 1
  )

```
Os municípios que mais fizeram licitações envolevendo merenda foram:

```{r}
kable(
  x = head(arrange(select(paraiba_sumarizado, c(de_Municipio, total_num)), desc(total_num)), 10),
  col.names = c('Município', 'Número de Licitações'),
  align = c('c'))
```

 
### 2.2 - Quais os municípios que mais gastam com merenda?

```{r}
colors = brewer.pal(9,"YlOrRd")
mapa_paraiba@data$Y <- paraiba_municipios$valor_total_lic
colors = colorFactor('OrRd', mapa_paraiba@data$Y)

leaflet(data = mapa_paraiba) %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(opacity = 0.5,
              weight = 1,
              fillColor = colors(mapa_paraiba@data$Y),
              color = 'black',
              label = mapa_paraiba@data$Nome_Munic,
              fillOpacity = 1) %>%
  addLegend(position = "bottomright", pal = colors, values = mapa_paraiba@data$Y,
            title = "Valor total de licitações",
            opacity = 1
  )
```
### 2.3 - Qual a distribuição do valor total de licitações de merenda escolar entre todos os municípios da Paraíba?
### 2.4 - Qual a distribuição do valor médio de licitações de merenda escolar entre todos os municípios da Paraíba?
### 2.5 - Qual a distribuição da média do valor da licitação por merenda por ano?
### 2.6 - Qual a distribuição da mediana do valor da licitação por merenda por ano?
### 2.7 - Qual o comportamento da média e da mediana do valor das licitações de merenda ao longo dos anos (2011-2015)?
### 2.8 - Em que período do ano ocorrem mais licitações de merenda?
### 2.9 - Em geral, as licitaçoes mais caras estão concentradas em alguma época do ano?
### 2.10 - Como é o padrão para descrição de licitações de merenda?
### 2.11 - Quanto se gasta com cada tipo de alimento?
### 2.12 - Quantos tipos diferentes de alimento cada fornecedor vende?
### 2.13 - Que modalidade de licitação é mais comum na compra de merenda?
### 2.14 - O valor médio da licitação alterou ao longo dos anos com relação às modalidades de licitação?
### 2.15 - A popularidade de alguma modalidade de licitação mudou ao longo dos anos?
### 2.16 - Geralmente, quantas propostas são recebidas para licitações de merenda?
### 2.17 - O valor da licitação está relacionado com o total de propostas recebidas?
### 2.18 - Qual a relação entre o total de licitações de merenda e o número de propostas por modalidade?

