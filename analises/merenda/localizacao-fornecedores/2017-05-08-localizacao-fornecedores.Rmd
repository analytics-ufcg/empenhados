---
title: "Distribuição Geográfica dos Licitantes"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
runtime: shiny
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  screenshot.force = FALSE,
  fig.width = 10)
```

```{r}
library(methods)
library(dplyr)
library(ggfortify)
library(rgdal)
library(maps)
library(ggmap)
library(leaflet)
library(tidyr)
library(stringr)
library(shiny)
source('../lib/load_fornecedores_merenda.R')
```

Nesse relatório estamos interessados em conhecer mais sobre os fornecedores de merenda na Paraíba. Qual a localização da sede de suas empresas? Quantos e quais municípios já foram abastecidos pelos produtos desses fornecedores? Essas são algumas perguntas que buscaremos responder. 

Antes de iniciarmos, precisamos definir que fornecedor é todo aquele que possui empenhos associados que foram classificados como destinados à alimentação escolar do município. Utilizamos uma base de dados na qual conseguimos identificar a localização geográfica através do CEP de 3546 fornecedores. No entanto, esse número não é o total de fornecedores com empenhos de merenda, que é mais de 9000. Decidimos ignorar tais fornecedores que não possuem os dados de localização disponíveis.

```{r}
ganhadores <- load_fornecedores_merenda()
```

```{r}
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

cep_licitantes <- tbl(utils, 'empresa') %>%
  collect(n = Inf)

dados_cep <- read.csv("dados_cep.csv", stringsAsFactors = FALSE, header = TRUE, na.strings = '')
```

```{r}
localizacao_licitantes_municipios <- ganhadores %>%
  left_join(cep_licitantes, by = c('cd_Credor' = 'nu_CPFCNPJ')) %>%
  filter(!is.na(nu_CEP))
```

```{r}
localizacao_licitantes <- ganhadores %>%
  group_by(cd_Credor, no_Credor) %>%
  summarise(ganhou = sum(ganhou),
            valor_total_emp = sum(valor_total_emp),
            valor_mediana_emp = median(valor_mediana_emp),
            valor_total_pag = sum(valor_total_pag, na.rm = TRUE),
            num_municipios = n()) %>%
  left_join(cep_licitantes, by = c('cd_Credor' = 'nu_CPFCNPJ')) %>%
  filter(!is.na(nu_CEP), nu_CEP != "")
```

```{r}
dados_cep.selected <- dados_cep %>%
  select(c(cep, latitude, longitude, estado, cidade)) %>%
  mutate(cep = as.character(cep))

localizacao_licitantes <- localizacao_licitantes %>%
  left_join(dados_cep.selected, by = c("nu_CEP" = "cep"))

# Endereço incorreto retornado pela API de busca
localizacao_licitantes <- localizacao_licitantes %>%
  filter(!(cd_Credor %in% c("07150557000158", "07129849000109", "09149258000129", "10462503000132", "09296872000113", "11968320000156", "00387408000168", "07316478000174", "05031301000287", "35591957000134", "08195834000101", "08031919000154", "07513602000191"))) %>%
  filter(!(!is.na(nu_CEP) & is.na(latitude)))
```

Abaixo você pode conferir a localização dos fornecedores de merenda na Paraíba. Inicialmente você observará grupos de fornecedores que estão juntos em uma mesma área, conforme você vai aumentando o zoom, mais informação de mais áreas se tornam disponíveis. Ao aproximar o zoom no nível das cidades é possível observar a localização do fornecedor individualmente (marcador em azul). Você também pode clicar sobre ele e obter informações mais específicas como nome, CNPJ/CPF, cidade, número de munícpios nos quais já forneceu e o valor total pago a esse fornecedor.

```{r}
leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 4)  %>% 
  addTiles() %>%
  addMarkers(data = localizacao_licitantes,
             label = ~str_to_upper(no_Credor), 
             popup = paste(
               "Nome:", str_to_upper(localizacao_licitantes$no_Credor), "</br>",
               "CNPJ/CPF:", localizacao_licitantes$cd_Credor, "</br>",
               "Cidade:", localizacao_licitantes$cidade, " - ", localizacao_licitantes$estado, "</br>",
               "Número de Municípios:", localizacao_licitantes$num_municipios, "</br>",
               "Valor pago: R$", localizacao_licitantes$valor_total_pag
             ),
             clusterOptions = markerClusterOptions())
```

Como talvez já pudesse ser esperado, a maioria dos licitantes de merenda está localizada em cidades da Paraíba. Dentro do estado, observa-se ainda que as cidades de maior porte concentram a maioria dos licitantes.  

Um número considerável, ainda, está localizado em estados vizinhos como Pernambuco, Rio Grande do Norte e Ceará. Existem também fornecedores em estados mais distantes como em São Paulo, Rio de Janeiro e Paraná. Há também alguns bancos com empenhos relacionados a alimentação escolar, localizados no Distrito Federal, a explicação para isso está geralmente nas taxas pagas ao banco por parte do município.

Descubra quais os fornecedores de merenda que se localizam na sua cidade ou próximo a você e comente no final desse post o que você encontrou e reconheceu.

## Verificando a existência de grandes fornecedores em cidades improváveis
Será que existem fornecedores com altos valores pagos de merenda em cidades pequenas da Paraíba? Os critérios utilizados para as cidades pequenas são aquelas que representam 10% das cidades com menor população da Paraíba. Um fornecedor é considerado com alto pagamentos quanto se ancaixa na lista de fornecedores dos 10% que mais receberam empenhos de merenda.

```{r}
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

municipios <- tbl(utils, 'municipio') %>%
    select(de_Municipio, vl_Populacao) %>%
    collect()

localizacao_licitantes <- localizacao_licitantes %>%
  left_join(municipios, by = c('cidade' = 'de_Municipio'))

licitantes_cimprovaveis <- localizacao_licitantes %>%
  filter(vl_Populacao < quantile(localizacao_licitantes$vl_Populacao, .1, na.rm = TRUE) &
           valor_total_pag > quantile(localizacao_licitantes$valor_total_pag, .9))
```

Foram encontrados 26 fornecedores que atendem aos critérios descritos acima, a maioria deles no sertão do estado. A distribuição geográfica deles pode ser visualizada no mapa abaixo.

```{r}
leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 7)  %>%
  addTiles() %>%
  addMarkers(data = licitantes_cimprovaveis,
             label = ~str_to_upper(no_Credor),
             popup = paste(
               "Nome:", str_to_upper(licitantes_cimprovaveis$no_Credor), "</br>",
               "CNPJ/CPF:", licitantes_cimprovaveis$cd_Credor, "</br>",
               "Cidade:", licitantes_cimprovaveis$cidade, " - ", licitantes_cimprovaveis$estado, "</br>",
               "População:", licitantes_cimprovaveis$vl_Populacao, "</br>",
               "Número de Municípios:", licitantes_cimprovaveis$num_municipios, "</br>",
               "Valor pago: R$", licitantes_cimprovaveis$valor_total_pag
             ),
             clusterOptions = markerClusterOptions())
```

## Onde atuam os diversos fornecedores de merenda?
Como última parte da análise, buscamos verificar o local de atuação dos fornecedores de merenda dos municípios do estado. Essa visualização pode ajudar a identificar fornecedores que atuam em municípios longe de suas matrizes.

```{r}
ui <- fluidPage(
  fluidRow(
    selectInput(inputId = "busca", 
                  label = "Busque um fornecedor", 
                  choices = (localizacao_licitantes_municipios %>%
                              ungroup() %>%
                              distinct(cd_Credor, nu_CEP, .keep_all = TRUE)
                          )[["no_Credor"]]),
      radioButtons("modo_visualizacao", "Verificar", c("Quantidade de empenhos", "Valor pago"), TRUE)
  ),
  
  fluidRow(
    leafletOutput("municipios")
  )
)
  

server <- function(input, output, session){
  
  mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

  # Atualizando nome de municípios que mudaram de nome nos últimos anos
  levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
  levels_mapa[51] = "Tacima"
  levels_mapa[200] = "São Vicente do Seridó"
  levels_mapa[173] = "Joca Claudino"
  levels_mapa[156] = "Quixaba"
  levels(mapa_paraiba@data$Nome_Munic) = levels_mapa
  
  mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
  
  colors <- colorFactor('Blues', mapa_paraiba@data$Nome_Munic)
  
  eventReactive(input$busca, {
    mapa_paraiba@data <- mapa_paraiba@data %>%
      filter(no_Credor == input$busca) %>%
      left_join(localizacao_licitantes_municipios, c("Nome_Munic" = "de_Municipio"))
    
    leaflet(data = mapa_paraiba) %>%
      addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
      addPolygons(opacity = 0.5,
                  weight = 1,
                  color = 'black',
                  fillColor = colors(mapa_paraiba@data$num_empenhos),
                  label = paste(mapa_paraiba@data$Nome_Munic),
                  popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                                "Empenhos: R$ ", mapa_paraiba@data$num_empenhos, "</br>",
                                "Valor pago: R$ ", mapa_paraiba@data$vl_pagamentos),
                  fillOpacity = 1)
  })
  
  eventReactive(input$modo_visualizacao, {
    output$municipios <- renderLeaflet({
    leaflet(data = mapa_paraiba) %>%
      addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
      addPolygons(opacity = 0.5,
                  weight = 1,
                  color = 'black',
                  fillColor = colors(mapa_paraiba@data$num_empenhos),
                  label = paste(mapa_paraiba@data$Nome_Munic),
                  popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                                "Empenhos: R$ ", mapa_paraiba@data$num_empenhos, "</br>",
                                "Valor pago: R$ ", mapa_paraiba@data$vl_pagamentos),
                  fillOpacity = 1)
  })
  })
}

shinyApp(ui, server)
```



