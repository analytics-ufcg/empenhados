---
title: "Distribuição Geográfica dos Licitantes"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  screenshot.force = FALSE,
  fig.width = 10)
```

```{r}
library(methods)
library(dplyr)
library(ggfortify)
library(leaflet)
library(tidyr)
library(stringr)
source('../lib/load_licitantes_merenda.R')
```

Todo fornecedor que se dispõe a participar de uma licitação deve possuir um endereço físico que possa ser consultado pela população. O objetivo desse relatório é apresentar como estão distribuídos geograficamente os licitantes de merenda no Estado da Paraíba. Os licitantes/fornecedores aqui listados não necessariamente ganharam uma licitação mas participaram de pelo menos uma. A partir de uma base de dados que associa CNPJs a CEPs obtemos as localizações aproximadas da maioria dos licitantes analisados em relatórios anteriores. A seguir apresentamos os resultados e a distribuição geográfica dos licitantes. É possível obter mais detalhes sobre eles ao clicar sobr eum marcador.   

```{r}
licitantes <- load_licitantes_merenda()

utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

cep_licitantes <- tbl(utils, 'empresa') %>%
  collect(n = Inf)

dados_cep <- read.csv("dados-cep.csv", stringsAsFactors = FALSE, header = TRUE, na.strings = '')
```

```{r}
licitantes.log <- licitantes %>%
  mutate_each(funs(log(. + 1)), -c(nu_CPFCNPJ, no_Fornecedor))

licitantes.scaled <- licitantes.log %>%
  mutate_each(funs(scale(.) %>% c), -c(nu_CPFCNPJ, no_Fornecedor))
```

```{r}
set.seed(12346) # Garantir que o k-means gere o mesmo resultado
km <- kmeans(select(licitantes.scaled, -c(nu_CPFCNPJ, no_Fornecedor)), centers = 7, nstart = 10)

licitantes <- licitantes %>%
  mutate(cluster = km$cluster %>% as.factor)
```

```{r}
dados_cep.selected <- dados_cep %>%
  select(c(latitude, longitude, estado, cidade))

localizacao_licitantes <- licitantes %>%
  left_join(cep_licitantes, 'nu_CPFCNPJ')

localizacao_licitantes <- localizacao_licitantes %>%
  bind_cols(dados_cep.selected)

# Endereço incorreto retornado pela API de busca
localizacao_licitantes <- localizacao_licitantes %>%
  filter(nu_CPFCNPJ != '07150557000158' &
           nu_CPFCNPJ != '07129849000109') %>%
  filter(!(!is.na(nu_CEP) & is.na(latitude)))
```

```{r}
m <- leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 4)  %>% 
  addTiles() %>%
  addMarkers(data = localizacao_licitantes,
             label = ~str_to_upper(no_Fornecedor), 
             popup = paste(
               "Nome:", str_to_upper(localizacao_licitantes$no_Fornecedor), "</br>",
               "CNPJ:", localizacao_licitantes$nu_CPFCNPJ, "</br>",
               "Local:", localizacao_licitantes$cidade, " - ", localizacao_licitantes$estado, "</br>",
               "Participações:", localizacao_licitantes$participou, "</br>",
               "Valor contratado: R$", localizacao_licitantes$total_ganho
             ))
  
m
```

Como talvez já pudesse ser esperado, a maioria dos licitantes de merenda está localizada em cidades da Paraíba. Dentro do estado, observa-se ainda que as cidades de maior porte concentram a maioria dos licitantes.  

Um número considerável, ainda, está localizado em estados vizinhos. Chamam a atenção, a localização de apenas 3 licitantes que se encontram fora da região Nordeste. Sendo que, destes, apenas um licitante localizado em Diadema-SP apresentou ganhos.  

## Distribuição geográfica dos licitantes de merenda por grupo
Em um dos [relatórios](https://analytics-ufcg.github.io/licitacoes-pb//2017/04/licitantes-merenda.html) disponíveis no site, é possível identificar grupos de licitantes que possuem características parecidas entre si. Tomando como base a análise realizada previamente, é possível verificar como estão distribuídos geograficamente os licitantes de merenda de acordo com seu grupo no mapa abaixo. Cada cor representa um grupo e há um total de 7 grupos.

```{r}
getColor <- function(df) {
  sapply(df$cluster, function(cluster) {
  if(cluster == 1) {
    "darkgreen"
  } else if(cluster == 2) {
    "orange"
  } else if(cluster == 3) {
    "blue"
  } else if(cluster == 4) {
    "purple"
  } else if(cluster == 5) {
    "green"
  } else if(cluster == 6) {
    "red"
  } else if(cluster == 7) {
    "darkred"
  } else {
    "cadetblue"
  } })
}

icons <- awesomeIcons(
  icon = 'circle-o',
  iconColor = 'black',
  library = 'fa',
  markerColor = getColor(licitantes)
)
```

```{r}
mapa_grupos <- leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 4)  %>% 
  addTiles() %>%
  addAwesomeMarkers(data = localizacao_licitantes, icon = icons, 
                    label = paste("Nome:", str_to_upper(localizacao_licitantes$no_Fornecedor), 
                      "Grupo:", licitantes$cluster),
                    popup = paste(
               "Nome:", str_to_upper(localizacao_licitantes$no_Fornecedor), "</br>",
               "CNPJ:", localizacao_licitantes$nu_CPFCNPJ, "</br>",
               "Local:", localizacao_licitantes$cidade, " - ", localizacao_licitantes$estado, "</br>",
               "Participações:", localizacao_licitantes$participou, "</br>",
               "Valor contratado: R$", localizacao_licitantes$total_ganho
             ))
mapa_grupos
```

De acordo com a análise do mapa, não parece haver correlação entre o grupo em que cada licitante é classificado e sua localização geográfica.

## Verificando a existência de grandes fornecedores em cidades improváveis.
Como última parte na análise, foi verificada a existência de grandes fornecedores em cidades com população pequena. Nessa etapa, foram considerados apenas os licitantes que venceram pelo menos uma licitação e que estão sediados no estado da Paraíba.

Foram considerados grandes fornecedores, os 10% que apresentam o maior valor contratado dentre os demais. Para a obtenção das cidades de pequena população, as mesmas foram ordenadas de forma crescente pela população e os primeiros 20% foram selecionados.  

```{r}
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

municipios <- tbl(utils, 'municipio') %>%
    select(-cd_Municipio) %>%
    collect()

localizacao_licitantes <- localizacao_licitantes %>%
  left_join(municipios, by = c('cidade' = 'de_Municipio'))

licitantes_cimprovaveis <- localizacao_licitantes %>%
  filter(vl_Populacao < quantile(localizacao_licitantes$vl_Populacao, .2, na.rm = TRUE) &
           total_ganho > quantile(localizacao_licitantes$total_ganho, .9))
```

Foram encontrados apenas 6 fornecedores que atendem aos critérios descritos acima, a maioria deles no sertão do estado. A distribuição geográfica deles pode ser visualizada no mapa abaixo.  

```{r}
m <- leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 4)  %>% 
  addTiles() %>%
  addMarkers(data = licitantes_cimprovaveis,
             label = ~str_to_upper(no_Fornecedor), 
             popup = paste(
               "Nome:", str_to_upper(licitantes_cimprovaveis$no_Fornecedor), "</br>",
               "CNPJ:", licitantes_cimprovaveis$nu_CPFCNPJ, "</br>",
               "Local:", licitantes_cimprovaveis$cidade, " - ", licitantes_cimprovaveis$estado, "</br>",
               "Participações:", licitantes_cimprovaveis$participou, "</br>",
               "Valor contratado: R$", licitantes_cimprovaveis$total_ganho
             ))
  
m
```



