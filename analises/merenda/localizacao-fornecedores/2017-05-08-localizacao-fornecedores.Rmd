---
title: "Distribuição Geográfica dos Licitantes"
subtitle: "Merenda Escolar"
author: "Laboratório Analytics"
runtime: shiny
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  screenshot.force = FALSE,
  fig.width = 10)
```

```{r}
library(methods)
library(dplyr)
library(ggfortify)
library(rgdal)
library(maps)
library(ggmap)
library(leaflet)
library(tidyr)
library(stringr)
library(shiny)
library(plotly)
source('../lib/load_fornecedores_merenda.R')

options(scipen = 999)
```

Nesse relatório estamos interessados em conhecer mais sobre os fornecedores de merenda na Paraíba. Qual a localização da sede de suas empresas? Quantos e quais municípios já foram abastecidos pelos produtos desses fornecedores? Essas são algumas perguntas que buscaremos responder. 

Antes de iniciarmos, precisamos definir que fornecedor é todo aquele que possui empenhos associados que foram classificados como destinados à alimentação escolar do município. Utilizamos uma base de dados na qual conseguimos identificar a localização geográfica através do CEP de 3546 fornecedores. No entanto, esse número não é o total de fornecedores com empenhos de merenda (mais de 9000). Decidimos ignorar tais fornecedores que não possuem os dados de localização disponíveis.

```{r}
ganhadores <- load_fornecedores_merenda()
```

```{r}
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

cep_licitantes <- tbl(utils, 'empresa') %>%
  collect(n = Inf)

dados_cep <- read.csv("dados_cep.csv", stringsAsFactors = FALSE, header = TRUE, na.strings = '')
```

```{r}
localizacao_licitantes_municipios <- ganhadores %>%
  left_join(cep_licitantes, by = c('cd_Credor' = 'nu_CPFCNPJ')) %>%
  filter(!is.na(nu_CEP)) %>%
  ungroup()
```

```{r}
localizacao_licitantes <- ganhadores %>%
  group_by(cd_Credor, no_Credor) %>%
  summarise(ganhou = sum(ganhou),
            valor_total_emp = sum(valor_total_emp),
            valor_mediana_emp = median(valor_mediana_emp),
            valor_total_pag = sum(valor_total_pag, na.rm = TRUE),
            num_municipios = n()) %>%
  left_join(cep_licitantes, by = c('cd_Credor' = 'nu_CPFCNPJ')) %>%
  filter(!is.na(nu_CEP), nu_CEP != "")
```

```{r}
dados_cep.selected <- dados_cep %>%
  select(c(cep, latitude, longitude, estado, cidade)) %>%
  mutate(cep = as.character(cep))

localizacao_licitantes <- localizacao_licitantes %>%
  left_join(dados_cep.selected, by = c("nu_CEP" = "cep"))

# Endereço incorreto retornado pela API de busca
localizacao_licitantes <- localizacao_licitantes %>%
  filter(!(cd_Credor %in% c("07150557000158", "07129849000109", "09149258000129", "10462503000132", "09296872000113", "11968320000156", "00387408000168", "07316478000174", "05031301000287", "35591957000134", "08195834000101", "08031919000154", "07513602000191"))) %>%
  filter(!(!is.na(nu_CEP) & is.na(latitude)))
```

Abaixo você pode conferir a localização dos fornecedores de merenda na Paraíba. Inicialmente você observará grupos de fornecedores que estão juntos em uma mesma área, conforme você vai aumentando o zoom, mais informação de mais áreas se tornam disponíveis. Ao aproximar o zoom no nível das cidades é possível observar a localização do fornecedor individualmente (marcador em azul). Você também pode clicar sobre ele e obter informações mais específicas como nome, CNPJ/CPF, cidade, número de munícipios nos quais já forneceu e o valor total pago a esse fornecedor.

```{r}
leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 4)  %>% 
  addTiles() %>%
  addMarkers(data = localizacao_licitantes,
             label = ~str_to_upper(no_Credor), 
             popup = paste(
               "Nome:", str_to_upper(localizacao_licitantes$no_Credor), "</br>",
               "CNPJ/CPF:", localizacao_licitantes$cd_Credor, "</br>",
               "Cidade:", localizacao_licitantes$cidade, " - ", localizacao_licitantes$estado, "</br>",
               "Número de Municípios:", localizacao_licitantes$num_municipios, "</br>",
               "Valor pago: R$", localizacao_licitantes$valor_total_pag
             ),
             clusterOptions = markerClusterOptions())
```

Como talvez já pudesse ser esperado, a maioria dos fornecedores de merenda está localizada em cidades da Paraíba. Dentro do estado, observa-se ainda que as cidades de maior porte concentram a maioria dos fornecedores.  

Um número considerável, ainda, está localizado em estados vizinhos como Pernambuco, Rio Grande do Norte e Ceará. Existem também fornecedores em estados mais distantes como em São Paulo, Rio de Janeiro e Paraná. Há também alguns bancos com empenhos relacionados a alimentação escolar, localizados no Distrito Federal, a explicação para isso está geralmente nas taxas pagas ao banco por parte do município.

Descubra quais os fornecedores de merenda que se localizam na sua cidade ou próximo a você e comente no final desse post o que você encontrou e reconheceu.

## Verificando a existência de grandes fornecedores em cidades improváveis
Será que existem fornecedores com altos valores pagos de merenda em cidades pequenas da Paraíba? Os critérios utilizados para as cidades pequenas são aquelas que representam 10% das cidades com menor população da Paraíba. Um fornecedor é considerado com altos pagamentos quando se encaixa na lista de fornecedores dos 10% que mais receberam pagamentos de empenhos de merenda.

```{r}
utils <- src_mysql('utils', group='ministerio-publico', password=NULL)

municipios <- tbl(utils, 'municipio') %>%
    select(de_Municipio, vl_Populacao) %>%
    collect()

localizacao_licitantes <- localizacao_licitantes %>%
  left_join(municipios, by = c('cidade' = 'de_Municipio'))

licitantes_cimprovaveis <- localizacao_licitantes %>%
  filter(vl_Populacao < quantile(localizacao_licitantes$vl_Populacao, .1, na.rm = TRUE) &
           valor_total_pag > quantile(localizacao_licitantes$valor_total_pag, .9))
```

Foram encontrados 26 fornecedores que atendem aos critérios descritos acima, a maioria deles no sertão do estado. A distribuição geográfica deles pode ser visualizada no mapa abaixo.

```{r}
leaflet() %>% setView(lng = -36.623, lat = -7.548, zoom = 7)  %>%
  addTiles() %>%
  addMarkers(data = licitantes_cimprovaveis,
             label = ~str_to_upper(no_Credor),
             popup = paste(
               "Nome:", str_to_upper(licitantes_cimprovaveis$no_Credor), "</br>",
               "CNPJ/CPF:", licitantes_cimprovaveis$cd_Credor, "</br>",
               "Cidade:", licitantes_cimprovaveis$cidade, " - ", licitantes_cimprovaveis$estado, "</br>",
               "População:", licitantes_cimprovaveis$vl_Populacao, "</br>",
               "Número de Municípios:", licitantes_cimprovaveis$num_municipios, "</br>",
               "Valor pago: R$", licitantes_cimprovaveis$valor_total_pag
             ),
             clusterOptions = markerClusterOptions())
```

A mediana da população nesses municípios é de `r median(licitantes_cimprovaveis$vl_Populacao)` habitantes, enquanto que a mediana do que foi pago ao fornecedores é de `r median(licitantes_cimprovaveis$valor_total_pag)` reais. Existem os casos em que os fornecedores fornecem apenas para o município onde se localiza, mas há fornecedores que estão em cidades pequenas e participam dos empenhos de outras cidades.

**Existe uma correlação entre o valor pago aos fornecedores e a população do município de suas empresas?**

Dentre as empresas que se localizam em cidades da Paraíba, iremos verificar abaixo se existe essa correlação.

```{r}
cor2 <- with(localizacao_licitantes, round(cor(valor_total_pag, vl_Populacao, use = "pairwise.complete.obs"), 2))

plot_ly(data = localizacao_licitantes,
        x = ~vl_Populacao,
        y = ~valor_total_pag,
        alpha = 0.5,
        type = 'scatter',
        mode = 'markers',
        text = ~paste('Fornecedor: ', no_Credor, "<br>", 
                      'Cidade: ', cidade, "<br>" ,
                      'Valor: R$', valor_total_pag),
        hoverinfo = 'text') %>%
  layout(title = 'População da cidade do fornecedor por valor total pago',
         xaxis = list(title = 'População da cidade do fornecedor'),
         yaxis = list(title = 'Valor total pago'),
         annotations = list(x = 200000, y = 5000000, showarrow = FALSE, text = paste('r = ', cor2)))
```

Como mostrado na visualização acima, ao considerarmos Campina Grande e João Pessoa, que são as duas linhas de fornecedores mais à direita, temos uma correlação linear fraca entre as duas variáveis (r = `r cor2`). O que aconteceria se considerássemos as demais cidades com exceção de João Pessoa e Campina Grande?

```{r}
cor3 <- with(localizacao_licitantes %>% filter(!(cidade %in% c("João Pessoa", "Campina Grande"))), round(cor(valor_total_pag, vl_Populacao, use = "pairwise.complete.obs"), 2))

plot_ly(data = localizacao_licitantes %>% 
          filter(!(cidade %in% c("João Pessoa", "Campina Grande"))),
        x = ~vl_Populacao,
        y = ~valor_total_pag,
        alpha = 0.5,
        type = 'scatter',
        mode = 'markers',
        text = ~paste('Fornecedor: ', no_Credor, "<br>", 
                      'Cidade: ', cidade, "<br>" ,
                      'Valor: R$', valor_total_pag),
        hoverinfo = 'text') %>%
  layout(title = 'População da cidade do fornecedor por valor total pago',
         xaxis = list(title = 'População da cidade do fornecedor'),
         yaxis = list(title = 'Valor total pago'),
         annotations = list(x = 40000, y = 4000000, showarrow = FALSE, text = paste('r = ', cor3)))
```

A correlação fica ainda menor atingindo `r cor3`. Ou seja, não parece haver uma correlação linear entre a população de um município no qual se localiza uma empresa e o quanto essa empresa recebeu por empenhos de merenda. É possível explorar o gráfico e obter mais informações sobre os fornecedores em cada faixa de população dos municípios observando a presença de outliers em vários casos como, por exemplo, em Bayeux, Cabedelo e Guarabira.

## Onde atuam os diversos fornecedores de merenda?
Como última parte da análise, buscamos verificar o local de atuação dos fornecedores de merenda dos municípios do estado. Essa visualização pode ajudar a identificar fornecedores que atuam em municípios longe de suas matrizes ou que costumam atuam em um grupo de cidades geográficamente próximas.

Para buscar um fornecedor na lista, digite sua razão social ou CNPJ e escolha uma forma de visualização.

* Na primeira opção de visualização, por total de vitórias, é possível observar a quantidade de vitórias do fornecedor selecionado em cada município do estado;

* Na segunda opção, visualização por valor recebido, é possível observar os valores recebidos pelo fornecedor em cada um dos municípios do estado.

Quando disponível, a localização dos fornecedores também é destacada no mapa e um marcador é adicionado a cada uma das sedes da empresa no período analisado.

```{r}
labels <- localizacao_licitantes_municipios %>%
  distinct(cd_Credor, .keep_all = TRUE) %>%
  arrange(no_Credor)

ui <- shinyUI(
  fluidPage(
    wellPanel(
      fluidRow(
          selectInput(inputId = "busca", 
                          label = "Busque um fornecedor", 
                          choices = (paste(labels[["no_Credor"]], " - ",labels[["cd_Credor"]]))
                      ),
          radioButtons(inputId = "modo_visualizacao", 
                         label = "Verificar", 
                         choices = c("Total de vitórias", "Valor recebido"),
                         selected = "Total de vitórias",
                         inline = TRUE
                       )
      )
    ),
    
    fluidRow(
      leafletOutput("municipios")
    )
  )
)
  

server <- function(input, output, session){
  
  mapa_paraiba <- readOGR("../dados/mapa_paraiba_ibge/Municipios.shp")

  # Atualizando nome de municípios que mudaram de nome nos últimos anos
  levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
  levels_mapa[51] = "Tacima"
  levels_mapa[200] = "São Vicente do Seridó"
  levels_mapa[173] = "Joca Claudino"
  levels_mapa[156] = "Quixaba"
  levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

  mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
  
  data_pb <- mapa_paraiba@data
  
  data_paraiba <- reactive({
    data_pb %>%
      left_join(
        (
          localizacao_licitantes_municipios  %>%
            filter(grepl(str_sub(input$busca, -14), cd_Credor)) %>%
            distinct(de_Municipio, .keep_all = TRUE)
        ), 
        by = c("Nome_Munic" = "de_Municipio"))%>%
      mutate(ganhou = ifelse(is.na(ganhou), 0, ganhou)) %>%
      mutate(valor_total_pag = ifelse(is.na(valor_total_pag), 0, valor_total_pag))
  })

  
  output$municipios <- renderLeaflet({
    mapa_paraiba@data <- data_paraiba()
    
    switch(input$modo_visualizacao,
           "Total de vitórias" = (
             leaflet(data = mapa_paraiba) %>%
              addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
              addPolygons(opacity = 0.5,
                  weight = 1,
                  color = 'black',
                  fillColor = colorNumeric("Blues", mapa_paraiba@data$ganhou)(mapa_paraiba@data$ganhou),
                  label = paste(mapa_paraiba@data$Nome_Munic),
                  popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                                "Vitórias: ", mapa_paraiba@data$ganhou, "</br>",
                                "Valor pago: R$ ", mapa_paraiba@data$valor_total_pag),
                  fillOpacity = 1) %>%
               addLegend(position = "bottomright", 
                         pal = colorNumeric("Blues", mapa_paraiba@data$ganhou), 
                         values = mapa_paraiba@data$ganhou,
                         title = "Vitórias",
                         opacity = 1, na.label = "0") %>%
               addMarkers(
                 data = (
                       localizacao_licitantes_municipios %>%
                          filter(grepl(str_sub(input$busca, -14), cd_Credor)) %>%
                          left_join(dados_cep.selected, by = c("nu_CEP" = "cep"))
                 ),
                 label = ~str_to_upper(no_Credor), 
                 popup = ~paste(
                   "Nome:", str_to_upper(no_Credor), "</br>",
                   "CNPJ/CPF:", cd_Credor, "</br>",
                   "Cidade:", cidade, " - ", estado
                 )
              )
           ),
           
           "Valor recebido" = (
             leaflet(data = mapa_paraiba) %>%
              addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
              addPolygons(opacity = 0.5,
                  weight = 1,
                  color = 'black',
                  fillColor = colorNumeric("Oranges", mapa_paraiba@data$valor_total_pag)(mapa_paraiba@data$valor_total_pag),
                  label = paste(mapa_paraiba@data$Nome_Munic),
                  popup = paste("Município: ", str_to_upper(mapa_paraiba@data$Nome_Munic), "</br>",
                                "Vitórias: ", mapa_paraiba@data$ganhou, "</br>",
                                "Valor pago: R$ ", mapa_paraiba@data$valor_total_pag),
                  fillOpacity = 1)%>%
               addLegend(position = "bottomright", 
                         pal = colorNumeric("Oranges", mapa_paraiba@data$valor_total_pag), 
                         values = mapa_paraiba@data$valor_total_pag,
                         title = "Valores recebidos",
                         opacity = 1, na.label = "0") %>%
               addMarkers(
                 data = (
                       localizacao_licitantes_municipios %>%
                          filter(grepl(str_sub(input$busca, -14), cd_Credor)) %>%
                          left_join(dados_cep.selected, by = c("nu_CEP" = "cep"))
                 ),
                 label = ~str_to_upper(no_Credor), 
                 popup = ~paste(
                   "Nome:", str_to_upper(no_Credor), "</br>",
                   "CNPJ/CPF:", cd_Credor, "</br>",
                   "Cidade:", cidade, " - ", estado
                 )
                )
           ))
  })
}

shinyApp(ui, server, options = list(height = 650))
```



