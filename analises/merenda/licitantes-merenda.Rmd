---
title: 'Análise dos licitantes de merenda'
author: 'Laboratório Analytics'
date: '10 de abril de 2017'
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 6,
  fig.height = 6
)

options(scipen = 999)
```

```{r}
library(RColorBrewer)

library(ggfortify)
library(ggplot2)
library(plotly)
library(knitr)

library(cluster)
library(dbscan)
library(tidyr)

source('load-licitantes-lib.R')

theme_set(theme_bw())
```

# Introdução
Ao analisar as licitações de merenda na Paraíba, faz-se necessário entender o comportamento dos licitantes como aqueles que participam da licitação apresentando uma proposta a Administração Pública. Para isso o objetivo inicial desse relatório é traçar o perfil desses licitantes através do agrupamento dos mesmos considerando características semelhantes entre membros de um grupo e distintas entre grupos.

## Descrição da amostra
Na amostra foram analisados 758 licitantes que fizeram pelo menos uma proposta em licitações de merenda no estado da Paraíba entre os anos de 2011 e 2015.

```{r}
licitantes <- load_licitantes()
```

A priori, consideraremos os seguintes critérios para o agrupamento:

* Número de participações (Participou): Número de licitações nas quais o licitante fez proposta.

* Total: Valor em reais da soma de todas as licitações nas quais o licitante fez proposta.

* Mediana: Valor em reais da mediana das licitações nas quais o licitante fez proposta.

* Municípios: Número de municípios distintos onde o licitante fez pelo menos uma proposta.

* Razão entre participações e vitórias (Ganhou): Razão entre o número de participações e o número de vitórias(número de contratos do licitante com a Administração Pública).

* Total ganho: Valor em reais da soma de todos os contratos nos quais o licitante faz parte.

* Aditivos: Razão entre o número de aditivos que o licitante adicionou aos seus contratos e o número de vitórias (contratos) que ele obteve.

Foram aplicadas técnicas de transformação e padronização nos dados a fim de obter os melhores resultados e visualizações possíveis. Além disso, três diferentes métodos de agrupamento foram testados a fim de obter o melhor resultado.

## Escolha do método
### Utilizando o agrupamento hierárquico
O primeiro método analisado foi o algoritmo de agrupamento hierárquico, que procura construir uma hierarquia de grupos analisando a semelhança entre os elementos. Nesse caso, a hierarquia é dita aglomerativa pois começa de baixo para cima (bottom up), ou seja, cada observação começa sendo um grupo e os grupos começam a se juntar a medida que sobem na hierarquia.  

```{r}
licitantes.log <- licitantes %>%
  mutate_each(funs(log(. + 1)), -nu_CPFCNPJ)

licitantes.scaled <- licitantes.log %>%
  mutate_each(funs(scale(.) %>% c), -nu_CPFCNPJ)

dists <- dist(select(licitantes.scaled, -nu_CPFCNPJ), method = 'euclidean')
```

Observamos abaixo o dendograma com a divisão dos grupos de licitantes. A divisão foi feita em 7 grupos visando obter um corte que não apresentasse tanta heterogeneidade entre membros de um mesmo grupo. Ou seja, elementos de um mesmo grupo devem ser parecidos entre si e elementos de grupos distintos devem ser diferentes entre si.

```{r}
hc <- hclust(dists, method = 'ward.D')

plot(hc, hang=0, labels=FALSE)
rect.hclust(hc, k=7)

licitantes.hc <- licitantes.scaled %>%
  mutate(cluster = cutree(hc, k=7) %>% as.factor)

licitantes.hc.long <- licitantes.hc %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)
```

O gráfico abaixo apresenta a visualização da aplicação da técnica Silhouette que tem o objetivo de medir o quão parecidos são os componentes dentro de um grupo. O ideal é que todos os componentes tenham um valor Silhouette elevado, no entanto observa-se que alguns licitantes estão em grupos mas que possuem caratecrísticas diferentes do grupo. Uma das explicações seria que esses licitantes estão muito próximos a outros grupos, ou seja eles não se encaixam muito bem em nenhum dos grupos propostos.

Outro fator relevante que pode ser observado através desta visualização é o número de observações de cada grupo. Percebe-se a existência de dois grupos grandes, que juntos comportam mais da metade das observações. Existem ainda dois grupos intermediários e mais 3 grupos pequenos, com menos de 50 licitantes em cada.

```{r}
colors <- brewer.pal(7, 'Set3')
plot(silhouette(cutree(hc, k=7), dists), col = colors, border = NA, main = 'Silhouette dos grupos utilizando o hclust')
```

### Utilizando o K-means
```{r}
set.seed(12346) # Garantir que o k-means gere o mesmo resultado
km <- kmeans(select(licitantes.scaled, -nu_CPFCNPJ), centers = 7, nstart = 10)

autoplot(km, data = licitantes.scaled, size = 2, main = 'Grupos obtidos utilizando o k-means') +
  labs(colour = 'Grupos')

licitantes.km <- licitantes.scaled %>%
  mutate(cluster = km$cluster %>% as.factor)

licitantes.km.long <- licitantes.km %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)
```

```{r}
plot(silhouette(km$cluster, dists), col = colors, border = NA, main = 'Silhouette dos grupos utilizando o k-means')
```

### Utilizando o DBScan
O DBScan (Ester et al. 1996) é um algoritmo de agrupamento que tem como principal diferença dos algoritmos utilizados anteriormente, o fato de que é possível obter pontos que não façam parte de nenhum grupo, considerados como ruído.
Nesse algoritmo, um ponto inicial é escolhido aleatoriamente e verifica-se se há um determinado número de pontos na vizinhança deste. Caso isso ocorra, há um grupo que contem o ponto inicial e todos os pontos da sua vizinhança.
Esse processo é repetido para todos os pontos do grupo recém encontrado com a finalidade de aumentar o número de elementos desse grupo. Quando não é mais possível encontrar pontos pertencentes a esse grupo, o algoritmo tenta criar novos grupos utilizando pontos que ainda não tenham sido agrupados.
É possível que alguns pontos não tenham o número de pontos mínimo necessário para se formar um grupo em sua vizinhança. Nesse caso, o ponto é considerado como um ponto de ruído e não pertence a nenhum grupo. Em nossa análise abaixo, os ruídos foram representados pelo grupo 1, embora não sejam formalmente um grupo.

```{r}
dbs <- dbscan(dists, eps = 1.1, minPts = 13)
dbs$cluster <- dbs$cluster + 1

licitantes.dbs <- licitantes.scaled %>%
  mutate(cluster = dbs$cluster %>% as.factor)

licitantes.dbs.long <- licitantes.dbs %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)

pr.out <- prcomp(select(licitantes.scaled, -nu_CPFCNPJ), scale = FALSE)
autoplot(pr.out, data = licitantes.dbs, colour = 'cluster', scale = 0, main = 'Clusters obtidos usando o algoritmo DBScan')
```

A utilização desse algoritmo possibilitou a descoberta de 4 grupos de licitantes. Esse número de grupos é um pouco menor que o número que gerou os melhores resultados nos algoritmos anteriores. Uma análise mais detalhada sobre eles é realizada a seguir.

Os grupos gerados pelo algoritmo apresentam grande heterogeneidade internamente, o que pode indicar que a divisão realizada pelo algoritmo para encontrar os grupos não foi tão eficiente quando a realizada pelos algoritmos testados anteriormente.  

### O algoritmo escolhido
A partir da análise dos gráficos da silhueta e da adequação de cada técnica ao domínio analisado,  foi possível concluir que a técnica que obteve os melhores resultados no cenário analisado foi o k-means.

## Análise de agrupamento 
A seguir observamos os 7 grupos e suas características de acordo com as variáveis analisadas.

```{r}
ggplot(licitantes.km.long, aes(x = variable, y = value, colour = variable)) +
  geom_boxplot() +
  geom_point(alpha = 0.2, position = position_jitter(width = .2)) +
  facet_wrap(~ cluster, ncol = 3) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Agrupamento de licitantes de merenda da Paraíba', x = '', y = '') 
```

#### Grupo 1
Em geral, os licitantes desse grupo tem um porcentagem de vitórias abaixo da média. Por conta disso o valor total ganho em contratos também é abaixo da média.

#### Grupo 2
Caracteriza os licitantes que participam de licitações com valor abaixo da média, mas que possuem alta porcentagem de vitórias com relação aos demais participantes e o valor do contrato é um pouco acima da média.

#### Grupo 3
Grupo dos licitantes que possuem contratos com aditivos acima da média, em geral são licitantes que ganham acima da média e assima contratos com valor acima da média.

#### Grupo 4
Ao contrário do grupo 2, os licitantes desse grupo participam de licitações com valores pouco acima da média e também tem uma alta porcentagem de vitórias

#### Grupo 5
Esse grupo é o que apresenta as variáveis com valores mais próximos a média sem nenhuma variação que se sobressaia.

#### Grupo 6
São licitantes que participam de licitações de alto valor mas que raramente ganham e quando ganham o valor de contrato é abaixo da média. Podem ser considerados os grandes perdedores da amostra analisada.

#### Grupo 7
Os integrantes desse grupo são ativos e participam de muitas licitações em diferentes municípios, as licitações possuem um valor total acima da média, mas um valor mediano dentro do esperado.

### Gráfico de coordenadas paralelas
```{r}
p1 <- ggplot(licitantes.km.long, aes(x = variable, y = value, group = nu_CPFCNPJ, colour = cluster)) +
  geom_point(alpha = 0.2) +
  geom_line(alpha = .3) +
  facet_wrap(~ cluster, ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x= '', y = '')

ggplotly(p1)
```

Nota-se que no grupo 3, considerado o grupos dos licitantes que mais aditivam seus contratos existe uma variação alta com relação a variável número de municípios entre os licitantes desse grupo. Em geral no grupo 5, como dito anteriormente, os valores se mantém próximo a média para todos os licitantes do grupo, tornando-se o grupo com características mais lineares. Com exceção do grupo 3, os demais grupos apresentam praticamente a mesma média de aditivos entre todos os seus componentes.  