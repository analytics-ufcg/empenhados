---
title: "Análise das Licitações de Merenda na Paraíba"
author: "Laboratório Analytics"
date: "30 de março de 2017"
output: html_document
---

<div style='text-align:justify'>

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r adicao de bibliotecas}
library(ggthemes)
library(corrplot)
library(ggplot2)

library(RColorBrewer)
library(scales)

library(tidyr)
library(plyr)
library(dplyr)

library(tm)
library(wordcloud)
library(stringr)

library(maps)   # mapas simples, eixos, escala, cidades 
library(ggmap)  # Gmaps, OSM + mapas baseados em ggplot2
library(rgdal)
```

```{r instancia tabelas do bd}
# Instancia conexão com o BD usando as configurações em ~/.my.cnf
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

licitacoes_total = tbl(sagres, 'licitacao') %>%
  filter(dt_Ano >= 2010) %>%
  collect(n = Inf)

utils = src_mysql('utils', group='ministerio-publico', password=NULL)

municipios = tbl(utils, 'municipio') %>%
  collect()

municipios$de_Municipio[199] = 'Sao Vicente do Serido'

query <- sql('
  SELECT *
  FROM licitacao
  WHERE de_Obs REGEXP "merenda" AND 
  dt_Ano >= 2011 AND dt_Ano <= 2015
')

licitacoes_fornecedor <- tbl(sagres, query) %>%
  compute(name = 'lm') %>%
  collect()


query <- sql('
  SELECT c.*
  FROM contratos c
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

contratos <- tbl(sagres, query) %>%
  collect()

query <- sql('
  SELECT p.*
  FROM participantes p
  INNER JOIN lm
  USING (cd_UGestora, nu_Licitacao, tp_Licitacao)
')

participantes <- tbl(sagres, query) %>%
  compute(name = 'pm') %>%
  collect()

query <- sql('
  SELECT DISTINCT f.*
  FROM fornecedores f
  INNER JOIN pm
  USING (cd_UGestora, nu_CPFCNPJ)
')

fornecedores <- tbl(sagres, query) %>%
  collect()
```

```{r}
get.municipio <- function(cd_UGestora) {
  result <- data.frame(
      cd_Municipio = str_sub(cd_UGestora, -3)) %>%
    join(municipios)
  return(result$de_Municipio)
}
```

```{r preparacao de dados}
unidades_gestoras = tbl(sagres, 'codigo_ugestora') %>% 
  select(de_Ugestora, cd_Ugestora) %>%
  distinct() %>%
  collect()

tipos_licitacao = tbl(sagres, 'tipo_modalidade_licitacao') %>% 
  select(de_TipoLicitacao) %>%
  collect() %>%
  mutate(de_TipoLicitacao = as.character(de_TipoLicitacao))

tipos_regime = tbl(sagres, 'regimeexecucao') %>% 
  select(de_regimeExecucao) %>%
  collect() %>%
  mutate(de_regimeExecucao = as.character(de_regimeExecucao))

licitacoes = tbl(sagres, 'licitacao') %>% 
  filter(dt_Ano >= 2011 && dt_Ano <= 2015) %>% 
  collect(n = Inf) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao)) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao, 
                               levels = c(levels(tp_Licitacao), '14'),
                               labels = tipos_licitacao$de_TipoLicitacao)) %>%
  mutate(tp_Objeto = factor(tp_Objeto)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao,
                                    levels = c('1', '2', '3', '4', '5'),
                                    labels = tipos_regime$de_regimeExecucao)) %>%
  select(-dt_Ano) %>%
  separate(dt_Homologacao, c('dt_AnoHomologacao', 'dt_MesHomologacao', 'dt_DiaHomologacao', 'dt_Hora', 'dt_Minuto', 'dt_Segundo')) %>%
  separate(dt_MesAno, c('dt_Mes', 'dt_Ano'), -5) %>%
  mutate(dt_Mes = as.integer(dt_Mes)) %>%
  mutate(dt_Ano = as.integer(dt_Ano)) %>%
  select(-c(dt_Hora, dt_Minuto, dt_Segundo, registroCGE)) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  mutate(dt_AnoHomologacao = as.integer(dt_AnoHomologacao)) %>%
  mutate(dt_MesHomologacao = as.integer(dt_MesHomologacao)) %>%
  mutate(dt_DiaHomologacao = as.integer(dt_DiaHomologacao)) %>%
  left_join(unidades_gestoras, c('cd_UGestora' = 'cd_Ugestora')) %>%
  mutate(de_UGestora = factor(de_Ugestora)) %>%
  select(-de_Ugestora) %>%
  left_join(municipios, 'cd_Municipio')
```

```{r removendo tabelas auxiliares}
rm(tipos_licitacao)
rm(tipos_regime)
rm(unidades_gestoras)
```

```{r filtrando merendas}
licitacoes_merenda = licitacoes %>%
  filter(grepl('alimentacao[[:space:]]escolar|merenda', licitacoes$de_Obs, ignore.case = T))
```

```{r}
# Adicionando o nome dos municípios nos dados de fornecedores
fornecedores$cd_Municipio <- substr(as.character(fornecedores$cd_UGestora), 4, 6)
fornecedores <- merge(fornecedores, municipios, by = 'cd_Municipio')

fornecedores$Nome_Munic <- fornecedores$de_Municipio.y
fornecedores$de_Municipio.y <- NULL

# Adicionando o nome dos municipios nos dados de licitacoes_fornecedor
licitacoes_fornecedor$cd_Municipio <- substr(as.character(licitacoes_fornecedor$cd_UGestora), 4, 6)
licitacoes_fornecedor <- merge(licitacoes_fornecedor, municipios, by = 'cd_Municipio')

licitacoes_fornecedor$Nome_Munic <- licitacoes_fornecedor$de_Muninipio.y
licitacoes_fornecedor$de_Municipio.y <- NULL
```

# Introdução
A licitação é um processo utilizado pela administração pública como meio de contratar obras e serviços, adquirir produtos e realizar locações selecionando a proposta mais vantajosa e de maior qualidade entre diversas propostas oferecidas. Definido pela lei 8666/1993, o processo licitatório deve seguir os princípios de isonomia, transparência e impessoalidade.  
Uma das utilizações dos processos licitatórios diz respeito à compra de alimentação escolar, ou merenda. No passado recente, diversas irregularidades foram encontradas nessa área, que vem se mostrando como uma das favoritas para a realização de desvios e superfaturamentos. {[1](http://paraibaonline.com.br/balanco-da-cgu-revela-desvios-de-r-2-bilhoes-da-merenda-escolar/)}{[2](http://www.paraiba.com.br/2017/02/25/12605-ministerio-da-transparencia-fiscaliza-prefeituras-da-pb-e-constata-superfaturamento-de-merenda-escolar)}  
O objetivo dessa análise é extrair informações acerca da realização de licitações para compra de merenda no estado da Paraíba, observando tendências e discrepâncias que possam surgir. Ao final, espera-se ainda obter um panorama que auxilie os cidadãos a perceber a forma como o dinheiro público está sendo investido, aumentando seus poderes de fiscalização

<br>

# Análise  
## 1 - Panorama
### 1.1 - Qual o número total de licitações feitas por ano entre 2010 e 2016?
Para responder a essa pergunta utilizou-se todos os dados referentes a licitações entre os anos de 2010 até 2016. Esse intervalo foi escolhido pois é o que apresenta a grande maioria do número de licitações. O objetivo aqui é identificar se existe uma tendência anual para o número de licitações em toda a Paraíba ou se existe algum ano que o número de licitações é muito diferente dos demais.

```{r total de licitacoes na paraiba}
ggplot(aes(dt_Ano), data = licitacoes_total) +
  geom_bar(fill = '#CF6360') +
  xlab("Ano") +
  ylab("Número total de licitações") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000)) +
  ggtitle("Total de licitações por ano") +
  theme_minimal()
```

Segundo o gráfico acima percebe-se que no ano de 2010 cerca de `r count(subset(licitacoes_total, licitacoes_total$dt_Ano == 2010))` licitações foram realizadas, esse valor é bem superior se comparado com os anos seguintes. Já no ano de 2016 observamos uma queda do número de licitações, isso se deve ao fato de que os dados observados possuem licitações até maio de 2016, ao contrário dos outros anos em que os dados possuem as licitações referentes a todos os meses.

<br>

### 1.2 - Qual o número de licitações feitas por ano em João Pessoa em relação ao número de licitações feitas na Paraíba?
A partir desse ponto vamos analisar apenas os anos entre 2011 e 2015, desconsiderando 2010 por causa da disparidade no número de licitações em relação ao outros, o que pode ser um indício de que algo esteja errado com esse ano, e também 2016, uma vez que não temos os dados de todos os meses desse ano.

Em seguida, buscamos verificar como a capital e maior cidade da Paraíba aparece nos dados de licitação. Buscou-se verificar se a mesma possui uma parcela significativa no número de licitações com relação a todo o Estado.

```{r}
# Código do Município de João Pessoa é "095"
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Restante da Paraíba"), data = licitacoes) +
  geom_bar(aes(fill = "João Pessoa"), data = subset(licitacoes, cd_Municipio == "095")) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações feitas na Paraíba e em João Pessoa por ano") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2011, 2015, 1)) +
  scale_y_continuous(breaks = seq(0, 20000, 5000))  +
  theme_minimal()
```

Pelo gráfico fica claro que entre 2011 e 2014 o número de licitações feitas em João Pessoa possui um valor semelhante, mas em 2015 esse valor em relação ao total de licitações no estado aumenta muito. Somente por este gráfico não é possível saber a causa dessa diferença entre 2015 e os outros anos.

<br>

## 2 - Análise de Licitações
### 2.1 - Qual o número de licitações que envolvem as palavras merenda e alimentação escolar?
Agora que já entendemos um pouco sobre como o número de licitações se comporta ao longo do ano, e encontramos algumas tendências e anomalias, buscamos responder essa pergunta filtrando apenas as licitações que possuem em sua descrição as seguintes sentenças: "Merenda" e "Alimentação escolar". O filtro foi feito ignorando acentos e caixa alta.

```{r}
ggplot(aes(dt_Ano), data = licitacoes_merenda) +
  geom_bar(fill = I('#009688')) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda por ano") +
  scale_x_continuous(breaks = seq(2011, 2015, 1)) +
  scale_y_continuous(breaks = seq(0, 250, 50))  +
  theme_minimal()
```

Pelo gráfico nota-se que o aumento mais significativo no número de licitações ocorreu entre 2012 e 2013. Observa-se também que não são feitas muitas licitações de merenda por ano, uma vez que o Estado da Paraíba possui 223 municípios e a média de licitações por ano é de `r count(licitacoes_merenda)/5` liciações, ou seja, é inferior ao número total de municípios. 

```{r}
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Outras Licitações"), data = licitacoes) +
  geom_bar(aes(fill = "Merenda Escolar"), data = licitacoes_merenda) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda em relação ao total de licitações") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2011, 2015)) +
  scale_y_continuous(breaks = seq(0, 20000, 5000)) +
  theme_minimal()
```

Se compararmos os dois gráficos (o número total de licitações por ano e o número total de licitações envolvendo merenda por ano) nota-se que licitações envolvendo merenda representam uma pequena parcela do universo de licitações. A partir daqui, vamos buscar analisar de forma mais específica essa pequena parcela e responder mais algumas perguntas.

<br>

### 2.2 - Qual a distribuição do número de licitações relacionadas à merenda nos municípios da Paraíba?

```{r}
utils = src_mysql('utils', group='ministerio-publico', password=NULL)

# Lista dos municípios da paraíba organizados pelo código (Referente aos três últimos dígitos da Unidade Gestora)
municipios = tbl(utils, 'municipio') %>%
  collect()
```

```{r configuracao dos mapas, results='hide'}
# Encontrado em: http://www.aesa.pb.gov.br/geoprocessamento/geoportal/shapes.html
mapa_paraiba <- readOGR("./mapa/Municipios.shp")

# Atualizando nome de municípios que mudaram de nome nos últimos anos
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa 

# Join entre a tabela de licitações e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = licitacoes_merenda %>% inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

# Sumarização dos dados por município
paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n(),
            valor_medio_lic = mean(vl_Licitacao),
            valor_total_lic = sum(vl_Licitacao))

# Imputação de dados (municípios que não tiveram licitações de merenda) e mais Sao Vicente do Serido que nao foi inserido no join
#data_temp = data.frame(de_Municipio = c('Mato Grosso', 'Nova Floresta', 'Mamanguape'),
#                       total = c(0, 0, 0), valor_medio_lic = c(0, 0, 0), valor_total_lic = c(0,0,0))
#paraiba_sumarizado = rbind(paraiba_sumarizado, data_temp)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total, 
                                breaks = c(0,3,5,7,10,15,25), 
                               labels = c("de 1 a 3", "de 3 a 5", "de 5 a 7", "de 7 a 10", "de 10 a 15", "de 15 a 25"),
                                include.lowest = T)

paraiba_sumarizado$valor_medio_lic = cut(paraiba_sumarizado$valor_medio_lic,
                                         breaks = c(0, 50000, 100000, 200000, 300000, 500000, 1000000, 2000000, 21000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 200", "De 200 a 300",  "De 300 a 500",
                                                    "De 500 a 1000", "De 1000 a 2000",  "Acima de 2000"),
                                         include.lowest = T)

paraiba_sumarizado$valor_total_lic = cut(paraiba_sumarizado$valor_total_lic,
                                         breaks = c(0, 50000, 100000, 250000, 500000, 1000000, 5000000, 10000000, 
                                                    25000000, 50000000),
                                         labels = c("De 0 a 50", "De 50 a 100", "De 100 a 500", "De 500 a 1000", 
                                                    "De 1000 a 2500", "De 1000 a 5000", "De 5000 a 10000", "De 10000 a 25000", 
                                                    "De 25000 a 50000"),
                                         include.lowest = T
                                         )

```

Para responder a essa pergunta iremos utilizar o mapa de municípios da paraíba para obter a distribuição geográfica dos municípios da Paraíba e o número total de licitações relacionadas a merenda realizadas em todos os anos investigados(2011-2015). O mapa com os municípios foi retirado do site da AESA{[3](http://www.aesa.pb.gov.br/geoprocessamento/geoportal/shapes.html)}.

```{r}
# Criando um data frame com os municípios na ordem do mapa
levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

colors = brewer.pal(6,"YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total
spplot(mapa_paraiba, 'Y',  col.regions= colors, main = "Número de licitações de merenda por município")
```

<!-- DÚVIDA 1: QUE DOIS MUNICÍPIOS? -->
Observou-se que poucos municípios, realizaram um número de licitações superior a 15 licitações. A capital João Pessoa apresentou um número baixo de licitações relacionadas a merenda se comparada a esses dois municípios, apenas `r nrow(subset(licitacoes_merenda, cd_Municipio == '095'))` licitações. Ao olhar o mapa vemos que alguns possuem um total de licitações próximo, e inclusive são vizinhos. Só por esse mapa não é possível concluir se o tamanho, população e outras características podem influenciar na forma com que os municípios lidam com as licitações de merenda, nem se municípios com características parecidas lidam também de forma parecida com a merenda escolar.

<br>

### 2.3 - Qual a média do valor da licitação por merenda?
Até aqui trabalhamos com o número total de licitações, a seguir vamos buscar entender como o valor da licitação se comporta.  
Inicialmente, determinamos a média e a mediana do valor (em reais) de licitações envolvendo merenda, como mostrado a seguir.
```{r}
mean(licitacoes_merenda$vl_Licitacao)
```

<br>

### 2.4 - Qual a mediana do valor da licitação por merenda?
```{r}
median(licitacoes_merenda$vl_Licitacao)
```

Nota-se que a diferença entre a média e a mediana é de `r  format(mean(licitacoes_merenda$vl_Licitacao) - median(licitacoes_merenda$vl_Licitacao), scientific=FALSE)` reais, isso pode indicar que a média não é uma boa medida para representar os dados de licitações quando estamos trabalhando com merenda. A causa disso é que alguns valores de licitação muito altos estão influenciando a média, causando então essa diferença.

<br>

### 2.5 - Qual o comportamento da média e da mediana do valor das licitações de merenda ao longo dos anos (2011-2015)?
No gráfico a seguir mostramos como o valor da média (preto) e da mediana (azul) se comporta entre os anos de 2010 e 2016.

```{r}
ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000), data = licitacoes_merenda) +
  geom_point(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = median, color = 'blue') +
  geom_point(stat = 'summary', fun.y = median, color = 'blue') +
  scale_x_continuous(breaks = seq(2011, 2015, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor da licitação (mil reais)", title = "Valor médio e mediano das licitações de merenda por ano")  +
  theme_minimal()
```

Podemos ver que a média sempre está acima da mediana. No ano de 2014 algumas licitações de alto valor foram realizadas, o que afetou a média. Outra coisa que é possível perceber a partir desse gráfico é que, em geral, o valor das licitações que envolvem merenda aumentou com o tempo.

<br>

### 2.6 - Em que período do ano ocorrem mais licitações de merenda?
Seguindo com a análise feita nas perguntas anteriores, buscou-se verificar se há algum período do ano que concentra mais licitações de merenda.  
Aqui, foram analisados apenas os dados no período compreendido entre os anos 2011 e 2015 e observou-se que o intervalo entre os meses de fevereiro e abril concentra a maioria das licitações de merenda e que o número de licitações desse tipo decai conforme nos aproximamos dos meses finais do ano.  
Segundo o gráfico abaixo, podemos ainda observar que tal concentração se dá exatamente nos primeiros meses da volta às aulas da escolas, onde possivelmente são firmados contratos anuais de distribuição de alimentação escolar. 

```{r}
ggplot(aes(x = dt_Mes), 
       data = filter(licitacoes_merenda, dt_Ano > 2010 & dt_Ano < 2016 & dt_Mes != 0)) +
  geom_histogram(binwidth = 1, fill = I('#CF6360')) +
  scale_x_continuous(breaks = seq(1,12,1)) +
  labs(title = 'Total de licitações por mês entre os anos 2011 e 2015',
       x = 'Mês', y = 'Total') +
  theme_minimal()
```

<br>

### 2.7 - Em geral, as licitaçoes mais caras estão concentradas em alguma época do ano?
Analisando novamente os dados do período entre 2011 e 2015, foi percebido que as licitações mais caras estão concentradas nos primeiros seis meses do ano, possuindo distribuição semelhante à do total de licitações realizadas. Interligando o resultado dessa pergunta com o obtido na pergunta anterior, é possível dizer que nos primeiros seis meses do ano são realizados mais processos licitatórios, que geralmente vem a ser os mais caros também.  

```{r}
mediana_total = median(licitacoes_merenda$vl_Licitacao)/1000

ggplot(aes(x = dt_Mes, y = vl_Licitacao/1000), 
       data = filter(licitacoes_merenda, dt_Ano > 2010 & dt_Ano < 2016 & dt_Mes != 0)) +
  geom_line(stat = 'summary', fun.y = 'median') +
  geom_point(stat = 'summary', fun.y = 'median') +
  geom_hline(yintercept = mediana_total, 
             color = 'red', linetype = 'dashed') +
  scale_x_continuous(breaks = 1:12) +
  geom_text(aes(1, mediana_total, label = 'Mediana anual', vjust = -1, hjust = -0.1), size = 4) +
  labs(title = 'Valor mediano de licitações por mês entre os anos 2011 e 2015',
       x = 'Mês', y = 'Valor mediano em reais (x1000)')  +
  theme_minimal()
```

<br>

### 2.8 - Qual a distribuição do valor total de licitações de merenda escolar entre todos os municípios da Paraíba? 

```{r}
mapa_paraiba@data$Y <- paraiba_municipios$valor_total_lic
colors = brewer.pal(9,"YlOrRd")
spplot(mapa_paraiba, 'Y',  col.regions= colors, main = "Valor total(em milhares de reais) de licitações de merenda por município")
```

<br>

### 2.9 - Qual a distribuição do valor médio de licitações de merenda escolar entre todos os municípios da Paraíba? 
Para responder a essa pergunta consideramos todas as licitações que envolvem merenda na Paraíba e os respectivos valores das licitações e determinamos a média desse valor por município. Em seguida, utilizamos o mapa abaixo para observar os resultados.

```{r}
mapa_paraiba@data$Y <- paraiba_municipios$valor_medio_lic
colors = brewer.pal(8,"YlOrRd")
spplot(mapa_paraiba, 'Y',  col.regions= colors, main = "Valor médio(em milhares de reais) de licitações de merenda por município")
```

Apenas duas cidades tiveram a média do valor da licitação acima dos 2 milhões, João Pessoa e São José do Sabugi, esta última possui uma população estimada em 4.135 pessoas segundo o IBGE, o que torna esse valor médio tão alto estranho e pássivel de averiguação.
<br>

### 2.10 - Como é o padrão para descrição de licitações de merenda?

Um primeiro passo para analisar o comportamento das licitações de merenda pode ser subdividí-las em categorias menores. Para isso, podemos fazer uma word cloud com as descrições das licitações, de modo que seja possível observar quais os termos mais recorrentes que sejam úteis para nosso propósito.

```{r}

termos.irrelevantes <- c(
  'merenda', 'escolar', 'aquisição', 'aquisicao', 'destinados', 'destinado',
  'secretarias', 'secretaria', 'alimenticios', 'alimentícios', 'generos', 'gêneros',
  'empresa', 'ensino', 'rede', 'municipal', 'municipio', 'município', 'escolas',
  'programa', 'fornecimento', 'alunos', 'deste', 'demais', 'municipais', 'atender'
)

descricao <- VectorSource(licitacoes_fornecedor$de_Obs) %>% Corpus %>%
  tm_map(removeNumbers) %>%
  tm_map(tolower) %>%
  tm_map(stripWhitespace) %>%
  tm_map(removeWords, stopwords('portuguese')) %>%
  tm_map(removeWords, termos.irrelevantes)

dtm <- DocumentTermMatrix(descricao)
freq <- colSums(as.matrix(dtm))   

wf <- data.frame(word=names(freq), freq=freq)  
wordcloud(names(freq), freq, random.order = F)
```

É notável que muitas dos termos que mais aparecem não tem real relevância para nosso propósito, mesmo vários desses já tendo sido filtrados. Entretanto, alguns tipos de alimentos são recorrentes nas descrições e são candidatos a classificadores. Estes são: carnes, frutas, bolos, iogurte, hortaliças, cereais, legumes, bolachas, leite, queijo, ovos, polpa e pães.

<br>

### 2.11 - Quanto se gasta com cada tipo de alimento?

Agrupando as licitações por ocorrência dos termos encontrados anteriormente, podemos comparar o quanto é gasto, em sua totalidade e por ano, com cada tipo de alimento. Isso pode ser um indicativo de certo mercado pode ser mais lucrativo que outros e, por consequência, apresentar uma maior concorrência.

```{r}
alimentos.base <- licitacoes_fornecedor %>%
  select(dt_Ano, cd_UGestora, nu_Licitacao, tp_Licitacao, de_Obs, vl_Licitacao) %>%
  mutate(
    Bolachas = grepl('bolacha', de_Obs, ignore.case=T),
    Bolos = grepl('bolo', de_Obs, ignore.case=T),
    Carnes = grepl('carne', de_Obs, ignore.case=T),
    Cereais = grepl('cerea', de_Obs, ignore.case=T),
    Frutas = grepl('frut', de_Obs, ignore.case=T),
    Hortalicas = grepl('hort', de_Obs, ignore.case=T),
    Iogurte = grepl('iogurte', de_Obs, ignore.case=T),
    Legumes = grepl('legume', de_Obs, ignore.case=T),
    Leite = grepl('leite', de_Obs, ignore.case=T),
    Ovos = grepl('ovo', de_Obs, ignore.case=T),
    Pães = grepl('pão|pães|pao|paes', de_Obs, ignore.case=T),
    Polpa = grepl('polpa|poupa', de_Obs, ignore.case=T),
    Queijo = grepl('queijo', de_Obs, ignore.case=T))

alimentos <- alimentos.base %>%
  gather(alimento, presente, Bolachas:Queijo) %>%
  filter(presente) %>%
  select(
    cd_UGestora,
    nu_Licitacao,
    tp_Licitacao,
    ano=dt_Ano,
    alimento,
    total=vl_Licitacao)

alimentos.resumo <- alimentos %>%
  group_by(ano, alimento) %>%
  summarise(total = sum(total))

alimentos.resumo %>%
  ggplot(aes(x=alimento, y=total, fill=alimento)) +
  geom_bar(stat = 'identity') +
  scale_y_continuous(label=comma) +
  guides(fill=FALSE) +
  labs(
    title = 'Gastos em licitações',
    x = 'Tipo de alimento',
    y = 'Total gasto (reais)',
    fill = 'Alimento') +
  theme(
    axis.text.x=element_text(angle=45, hjust=1))

alimentos.resumo %>%
  ggplot(aes(x=ano, y=total, group=alimento, color=alimento)) +
  geom_path(na.rm=T) +
  scale_y_continuous(label=comma) +
  labs(
    title = 'Gastos em licitações por ano',
    x = 'Ano',
    y = 'Total gasto (reais)',
    color = 'Alimento')
```

É interessante perceber que a quantidade gasta em licitações de carne, hortaliças, frutas e pães para merenda é nitidamente maior do que a gasta com outros tipos de alimentos, principalmente no ano de 2010. Um dos motivos para isso pode ser que não há uma preocupação tão grande em explicitar a compra dos tipos menos recorrente.

Outra hipótese é que carne tem um preço elevado e, muitas das vezes que aparece em uma licitação, também aparecem hortifrutigranjeiros e pães, o que faz com que haja uma distorção de seus preços aparentes.

<br>

### 2.12 - Que modalidade de licitação é mais comum na compra de merenda?
A seguir, buscamos entender se há alguma modalidade de licitação mais comum ou padrão a ser utilizado na compra de alimentação escolar. Aqui, foi possível observarque a maior parte das licitações de merenda faz parte das modalidades convite ou pregão presencial. Outras modalidades como concorrência, tomada de preços e chamada pública também são amplamente utilizadas. Um número expressivo de licitações, ainda, é considerado dispensável.  

```{r}
niveis = levels(licitacoes_merenda$tp_Licitacao)
niveis[niveis == 'Pregão (Eletrônico e Presencial)'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Pregão Eletrônico'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Pregão Presencial'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Dispensa por outros motivos'] = 'Dispensa'
niveis[niveis == 'Dispensa por Valor'] = 'Dispensa'
levels(licitacoes_merenda$tp_Licitacao) = niveis

ggplot(aes(x = tp_Licitacao), data = licitacoes_merenda) +
  geom_bar(aes(fill = tp_Licitacao)) +
  scale_x_discrete(labels = c()) +
  labs(title = 'Quais licitações são mais comuns na compra de merenda?', 
       x = 'Modalidade de licitação', y = 'Total', fill = 'Modalide de licitação')  +
  theme_minimal()

```

<br>

### 2.13 - O valor médio da licitação alterou ao longo dos anos com relação às modalidades de licitação?
Outra variável interessante de se analisar nos dados é a modalidade de licitação. Será que o valor médio (em reais) de licitação varia de acordo com sua modalidade ou esse valor também sofre influência do ano em que a licitação foi realizada? Essas são algumas questões que o gráfico a seguir pode responder.

```{r}
ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000, color = tp_Licitacao), data = licitacoes_merenda) +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous(breaks = seq(2011, 2015, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor médio das licitações (em milhares)", title = "Valor médio das licitações por modalidade de licitação ao longo dos anos", color = "Modalidade de licitação")  +
  theme_minimal()
```

Observou-se que algumas modalidades de licitações não possuem valores médios em alguns anos, isso ocorre porque não houve licitações daquele tipo naquele ano. Algumas modalidades se destacam por seu valor médio parecido e acima dos demais, são elas: Pregão (Eletrônico e Presencial), Adesão a Registro de Preço e Tomada de preços. Algumas modalidades possuem valores limites. As licitações por Convite, por exemplo, não podem apresentar valor superior a R$ 80.000 e isso fica claro no gráfico já que a média de licitações dessa modalidade fica em torno desse valor. Além disso, em geral, o valor médio das licitações aumentou com os anos em praticamente todas as modalidades.

A partir dessa resposta faz-se necessário saber se existem licitações de merenda da modalidade de Convite que ultrapassam o valor limite de R$ 80.000 previsto pela Lei 8666/1993. Descobrimos que `r nrow(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & vl_Licitacao > 80000))` licitação possuem valor acima do limite. Essa inconsistência pode ser melhor investigada em análises futuras.

<br>

### 2.14 - A popularidade de alguma modalidade de licitação mudou ao longo dos anos?
Dando prosseguimento à análise, foi verificado quais modalidades de licitação foram mais utilizadas para a obtenção de merenda entre os anos 2011 e 2015. Podemos observar um padrão diferente na distribuição das modalidades de licitação. O resultado pode ser visto no gráfico abaixo. 

```{r}
ggplot(aes(x = dt_Ano), 
       data = (licitacoes_merenda %>%
                 group_by(dt_Ano, tp_Licitacao) %>%
                 summarize(total = n()) %>%
                 ungroup() 
               )) +
  geom_line(aes(y = total, color = tp_Licitacao)) +
  labs(title = 'Popularidade das modalidades de licitação entre os anos 2011 e 2015',
       x = 'Ano', y = 'Total de licitações', color = 'Tipo de licitação')  +
  theme_minimal()
```

A modalidade de licitação mais utilizada para a obtenção de merenda no período observado foi o pregão, seja ele eletrônico ou presencial, e sua utilização ainda está em ascenção.  
Se por um lado a utilização do pregão apresentou popularidade ascendente no período, por outro, a popularidade das licitações da modalidade convite apresentaram uma queda considerável, chegando quase a 0 nos anos 2014 e 2015.  
Ainda há outros pontos importantes a serem ressaltados nesse tópico. É possível observar, por exemplo, que há uma grande diferença entre o total de licitações dispensadas em 2013 e o de seus anos vizinhos e que a modalidade chamada pública começou a ser utilizada apenas no ano referido anteriormente.    

<br>

### 2.15 - Geralmente, quantas propostas são recebidas para licitações de merenda?
Aqui, busca-se compreender como está distribuído o total de propostas para as licitações de merenda. A partir dessa análise é possível perceber se há muitos interessados nesse tipo de licitação e se algum valor mais comum ou discrepante.
Conforme descrito na figura abaixo, é possível observar que grande parte das licitações de merenda (`r round(nrow(filter(licitacoes_merenda, nu_Propostas < 5))/nrow(licitacoes_merenda) * 100, 2)`%) recebeu menos de 5 propostas.

```{r}
ggplot(aes(x = nu_Propostas), data = licitacoes_merenda) +
  geom_histogram(fill = I('#e2a76f'), binwidth = 1) +
  labs(title = 'Total de propostas para licitações de merenda',
       x = 'Número de propostas', y = 'Total') +
  scale_x_continuous(breaks = seq(0, 50, 5)) +
  scale_y_continuous(breaks = seq(0,1500,250)) +
  theme_minimal()
```

É possível ainda, restringir a abrangência do gráfico à área de maior concentração e perceber que a maioria das licitações de merenda (`r round(nrow(filter(licitacoes_merenda, nu_Propostas == 3))/nrow(licitacoes_merenda) * 100, 2)`%) recebeu apenas 3 propostas.

```{r}
ggplot(aes(x = nu_Propostas), data = licitacoes_merenda) +
  geom_histogram(fill = I('#b2628b'), binwidth = 1) +
  labs(title = 'Total de propostas para licitações de merenda',
       x = 'Número de propostas', y = 'Total') +
  scale_x_continuous(breaks = 0:6, limits = c(0,6)) +
  scale_y_continuous(breaks = seq(0,1500,250))  +
  theme_minimal()
```

Por outro lado, há 2 licitações cujo número de participantes passa dos 25, desviando-se mais de 10 vezes do número médio de participantes das demais. Uma dessas licitações foi realizada em João Pessoa em 2015, enquanto a outra, foi realizada em Monteiro no ano de 2014. 
Os detalhes desses dois processos podem ser observados na tabela abaixo.

| Cidade | Ano | Propostas | Valor(R$) |
|:------:|:---:|:---------:|:---------:|
|João Pessoa|2015|31|25.078.839,00|
|Monteiro|2014|50|250.911,00|

<br>

### 2.16 - O valor da licitação está relacionado com o total de propostas recebidas?
Para tentar responder essa pergunta, foi criado um gráfico de dispersão do valor das licitações pelo total de propostas. Além disso, o coeficiente de correlação linear entre as variáveis foi calculado.  

```{r}
cor1 = with(licitacoes_merenda, 
            round(cor(vl_Licitacao, nu_Propostas), 2))

ggplot(aes(x = vl_Licitacao/1e+06, y = nu_Propostas), data = licitacoes_merenda) +
  geom_jitter(alpha = 0.2) +
  labs(title = 'Número de propostas por valor total de licitação',
       x = 'Valor de licitação (em milhões de reais)', y = 'Número de propostas') +
  scale_x_continuous() +
  geom_label(aes(7.5, 15, label = paste('r = ', as.character(cor1)))) +
  theme_minimal()
```

Observando a figura acima observamos que aparentemente não há relação linear entre as duas variáveis. Isso pode ser comprovado pelo valor do coeficiente de correlação linear entre elas, que é de 0.23.  

É possível, ainda, aproximar o gráfico da área que contém a maior concentração de pontos e recalcular a correlação entre as variáveis.  

```{r}
cor2 = with(filter(licitacoes_merenda, 
                   vl_Licitacao <= quantile(licitacoes_merenda$vl_Licitacao, .975) & 
                     nu_Propostas <= quantile(licitacoes_merenda$nu_Propostas, .975)), 
            round(cor(vl_Licitacao, nu_Propostas), 2))

ggplot(aes(x = vl_Licitacao/1e+06, y = nu_Propostas), 
       data = filter(licitacoes_merenda, vl_Licitacao <= 3e+06)) +
  geom_jitter(alpha = 0.2) +
  scale_x_continuous(limits = c(0, quantile(licitacoes_merenda$vl_Licitacao, .975)/1e+06)) + 
  scale_y_continuous(limits = c(0, quantile(licitacoes_merenda$nu_Propostas, .975))) +
  labs(title = 'Número de propostas por valor total de licitação',
       x = 'Valor de licitação (em milhões de reais)', y = 'Número de propostas') +
  geom_label(aes(0.45, 6.5, label = paste('r = ', as.character(cor2))))  +
  theme_minimal()

```

Agora observamos que há ainda menos indícios de uma correlação linear entre as duas variáveis. Isso pode ser comprovado, mais uma vez, pelo valor do coeficiente de correlação linear entre elas, que diminuiu e passou a ser de -0.1.  

<br>

### 2.17 - Qual a relação entre o total de licitações de merenda e o número de propostas por modalidade?
Para responder a essa pergunta iremos considerar os anos de 2011 até 2016. A figura abaixo mostra a frequência de licitações de acordo com o número de propostas. Limitamos o número de propostas para no máximo 6 já que esse intervalo(1:6) contém 95% dos dados de merenda. O 95-percentil é `r quantile(licitacoes_merenda$nu_Propostas, probs = c(.95))`.

```{r}
ggplot(aes(nu_Propostas), data = subset(licitacoes_merenda, dt_Ano > 2010)) +
  geom_bar(aes(fill = tp_Licitacao), position = 'dodge') +
  scale_x_continuous(limits = c(0, 6.5), breaks = seq(0, 6, 1)) +
  scale_y_continuous(breaks = seq(0, 400, 50)) +
  labs(x = 'Número de propostas', y = 'Número de licitações', fill = 'Modalidade', title = 'Total de licitações por número de propostas por modalidade (a partir de 2011)')  +
  theme_minimal()
```

Ao considerarmos as licitações de merenda feitas a partir de 2011 percebemos que a frequência de licitações da modalidade Convite aumenta quando o número de propostas é igual a 3. A modalidade de Pregão(Eletrônico e presencial) em grande parte das licitações possui apenas 1 proposta.

A modalidade Convite tem a maioria das licitações com 3 propostas, isso ocorre devido ao número mínimo de participantes de uma licitação dessa modalidade que é 3, estabelecido pela Lei Nº 8666/1993.

A interpretação do gráfico nos levou a outra pergunta: existem licitações de merenda da modalidade convite com número de propostas inferior a 3, número mínimo exigido por Lei?
Encontramos `r count(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & nu_Propostas < 3))` licitações de merenda que são da modalidade Convite e possuem menos de 3 propostas, o que não é permitido por Lei, embora hajam algumas exceções.

<br>

## 3 - Analisando Fornecedores
Um ponto do processo licitatório em que também pode ocorrer um número considerável de irregularidades diz respeito à contratação dos fornecedores de alimentação escolar. Com base nisso, foi avaliada a forma como os fornecedores de merenda estão distribuídos.  

### 3.1 - Quantos são os fornecedores de merenda de cada município?
Através da análise dos dados dos fornecedores e sua participação nos contratos de merenda de cada município no período de 2011 a 2015, foi possível traçar um panorama da distribuição e diversidade de fornecedores no estado da Paraíba. A seguir, é possível visualizar qual o total de fornecedores de merenda em cada um dos municípios do estado.

```{r}
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)

levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"

levels(mapa_paraiba@data$Nome_Munic) = levels_mapa

merenda_pb <- left_join(fornecedores, municipios, 'cd_Municipio')

# Join entre a tabela de fornecedores e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = merenda_pb %>% inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

# Sumarização dos dados por município
paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n())

quartis_pb <- quantile(paraiba_sumarizado$total)

# Imputação de dados (municípios que não tiveram licitações de merenda) e mais Sao Vicente do Serido que nao foi inserido no join
data_temp = data.frame(de_Municipio = 
                c('Mato Grosso', 'Nova Floresta', 'Mamanguape', 'Sao Vicente do Serido', 'Mogeiro', 'Alagoa Grande'),
                total = c(0, 0, 0, 9, 0, 0))

paraiba_sumarizado = rbind(paraiba_sumarizado, data_temp)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total, 
                                breaks = c(0,5,10,20,30,83), 
                                include.lowest = F)

# Criando um data frame com os municípios na ordem do mapa
levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)
paraiba_municipios$levels_mapa <- as.character(paraiba_municipios$levels_mapa)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

colors = brewer.pal(5,"YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total
spplot(mapa_paraiba, 'Y',  col.regions = colors, main = "Número de fornecedores de merenda por município")
```

Observa-se que o número de fornecedores é, em geral, baixo, uma vez que 75% das cidades tem no máximo `r unname(quartis_pb)[4]` fornecedores e 48 das cidades não apresentaram nenhum fornecedor (demarcadar em branco no mapa).
A cidade de Monteiro apresentou valor extremo se comparada as demais, visto que esta cidade teve 83 fornecedores. A segunda cidade com mais fornecedores foi João Pessoa com um total de 35 fornecedores, cerca de 60% a menos que Monteiro.
<br>

### 3.2 - Quantos fornecedores, em média, competem nas licitações?
```{r}
mean(licitacoes_fornecedor$nu_Propostas)
lic_sem_concorrentes <- subset(licitacoes_fornecedor, nu_Propostas <= 1)
```

Percebe-se que em geral, as licitações contam com um número pequeno de competidores, indicando que existe baixa concorrência nas licitações de merenda; Notou-se ainda que `r length(lic_sem_concorrentes$cd_Municipio)` (`r round(length(lic_sem_concorrentes$cd_Municipio)/length(licitacoes_fornecedor$cd_Municipio)*100, 2)`%) licitações receberam nenhuma ou apenas uma proposta, ou seja, não tiveram concorrência.

<br>

### 3.3 - Existem fornecedores que dominam a distribuição de merenda?
Para responder essa questão foi calculado o número de contratos celebrados por cada fornecedor de merenda no período de 2011 a 2015, com o intuito de identificar uma possível existência de fornecedores que vençam muito mais licitações que os demais.

```{r}
fornecedores_groups <- group_by(contratos, nu_CPFCNPJ)
data_fornecedores_groups <- summarise(fornecedores_groups, n = n())

media <- mean(data_fornecedores_groups$n)
ggplot(aes(x = nu_CPFCNPJ), data = contratos) + 
  geom_histogram(stat = 'count', color = '#5CA171') + 
  labs(title = 'Número de contratos celebrados por fornecedor', x = 'Fornecedores', y = 'Número de contratos') +
  geom_hline(yintercept = media, linetype = 'dashed', color = 'blue') +
  geom_text(aes(0, media, label = 'Média', vjust = -0.5, hjust = -0.1), size = 4) +
  scale_y_continuous(breaks = seq(0, 80, 5)) +
  theme(
      axis.text.x=element_blank(),
      axis.ticks.x=element_blank())
```

Observa-se uma média de 2.88 contratos celebrados por fornecedor, com uma grande concentração de valores abaixo de 5, o que justifica a média baixa. Apesar disso, um pequeno grupo de 88 fornecedores - menos de 10% do total - conseguiu fechar mais de 5 contratos durante o período estudado.

<br>

### 3.4 - Quantos tipos diferentes de alimento cada fornecedor vende?
Uma coisa a se observar é que a quantidade de tipos de alimentos que um mesmo fornecedor vende é, em geral, baixa. Não somente isso, como a grande maioria não se enquadra na venda de nenhum tipo específico, provavelmente participando apenas de licitações genéricas.  

```{r}
variedade <- alimentos %>%
  merge(participantes) %>%
  distinct(nu_CPFCNPJ, alimento) %>%
  group_by(nu_CPFCNPJ) %>%
  summarise(variedade = n()) %>%
  merge(fornecedores, all=T) %>%
  select(nu_CPFCNPJ, variedade) %>%
  distinct()

variedade[is.na(variedade)] <- 0

variedade %>%
  ggplot(aes(x=variedade)) +
  geom_bar() +
  labs(
    title = 'Tipos de alimentos vendidos por fornecedor',
    x = 'Tipos vendidos',
    y = 'Fornecedores')
```

<br>

### 3.5 - Os contratos de licitações são bem distribuidos entre os fornecedores?
Os gráficos abaixo mostram que a maior parte dos fornecedores participaram do processo licitatório apenas uma vez. Note que a reta desenhada mostra os fornecedores que ganharam todas as vezes que participaram, o que significa que os pontos acima dessa reta são inconsistências nos dados. Também é importante destacar que o fornecedor com mais participações, mas nenhuma vitória, é um fornecedor genérico, entitulado "Folha de Pagamento (Fornecedor Padrão)". Ele participou 2272 vezes e como distorceria a visualização não foi inserido no gráfico.  

```{r}
participacoes <- participantes %>%
  group_by(nu_CPFCNPJ) %>%
  summarise(participou = n())

vitorias <- contratos %>%
  group_by(nu_CPFCNPJ) %>%
  summarise(
    ganhou = n(),
    valor = sum(vl_TotalContrato))

lucros <- fornecedores %>%
  distinct(nu_CPFCNPJ) %>%
  merge(participacoes, all=T) %>%
  merge(vitorias, all=T) %>%
  filter(nu_CPFCNPJ != '00000000000000')

lucros[is.na(lucros)] <- 0

lucros <- lucros %>%
  mutate(perdeu = participou-ganhou)

lucros %>%
  filter(participou < 30) %>%
  group_by(participou, ganhou) %>%
  summarise(freq = n()) %>% 
  ggplot(aes(x=participou, y=ganhou, size=freq)) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Participações em licitações versus vitórias por fornecedor',
      x = 'Participações',
      y = 'Vitórias',
      size = 'Ocorrências')

lucros %>%
  group_by(participou, ganhou) %>%
  summarise(freq = n()) %>% 
  ggplot(aes(x=participou, y=ganhou, size=freq)) +
    geom_abline(slope=1, intercept=0, color='grey') +
    geom_point() +
    scale_x_continuous(breaks=pretty_breaks(10)) +
    scale_y_continuous(breaks=pretty_breaks(10)) +
    labs(
      title = 'Participações em licitações versus vitórias por fornecedor',
      x = 'Participações',
      y = 'Vitórias',
      size = 'Ocorrências')
```

Outra coisa relevante a se observar é que o dinheiro recebido por meio de contratos de licitação se concentra em uma pequena parcela dos fornecedores, como pode ser visto no gráfico abaixo. Um dos motivos disso é que a maioria dos fornecedores só participou de uma ou duas licitações, mas isso não descarta a possibilidade de favoritismo ou contratos únicos de alto valor.

```{r}
lucros %>%
  arrange(-valor) %>%
  mutate(ordem=nrow(lucros) %>% seq) %>%
  head(400) %>%
  ggplot(aes(x=ordem, y=valor)) +
    geom_bar(width=1, stat='identity') +
    scale_y_continuous(
      breaks=pretty_breaks(5),
      label=comma) +
    labs(
      title = 'Distribuição de licitações por fornecedor',
      x = 'Fornecedor',
      y = 'Total ganho (reais)') +
    theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

<!-- ### 8 - Quanto cada município já gastou com licitações? -->

<!-- ```{r} -->
<!-- gastos <- contratos %>% -->
<!--   group_by(de_Municipio = get.municipio(cd_UGestora), dt_Ano) %>% -->
<!--   summarise(total = sum(vl_TotalContrato), freq = n()) -->

<!-- gastos_cidades <- gastos %>% group_by(de_Municipio) %>% summarise(total = sum(total)) -->

<!-- anti <- anti_join(municipios, gastos_cidades, by = 'de_Municipio') -->

<!-- data_temp = data.frame(de_Municipio = c( -->
<!--   'Sossêgo', 'Soledade', 'São José dos Cordeiros', 'Santana dos Garrotes', 'Salgadinho', 'Riacho de Santo Antônio', 'Riachão do Bacamarte', 'Nova Floresta', 'Mogeiro', 'Mato Grosso', 'Mamanguape', 'Juripiranga', 'João Pessoa', 'Ibiara', 'Gurjão', 'Cuité', 'Amparo', 'Alagoa Grande'), total = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)) -->

<!-- paraiba_sumarizado = rbind(gastos_cidades, data_temp) -->

<!-- paraiba_sumarizado$total = cut(paraiba_sumarizado$total,  -->
<!--                                 breaks = c(0,100000,1000000,10000000,100000000), -->
<!--                                 include.lowest = T) -->

<!-- levels_mapa = mapa_paraiba@data$Nome_Munic -->
<!-- paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID) -->
<!-- paraiba_municipios$levels_mapa <- as.character(paraiba_municipios$levels_mapa) -->

<!-- # Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização -->
<!-- paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio')) -->


<!-- colors = brewer.pal(5,"YlOrRd") -->

<!-- # A variável Y recebe os valores em ordem que devem apontar para cada municipio -->
<!-- mapa_paraiba@data$Y <- paraiba_municipios$total -->
<!-- spplot(mapa_paraiba, 'Y',  col.regions = colors, main = "Total gasto em merenda por município") -->
<!-- ``` -->

<br>

### 3.6 - O tamanho da população da cidade influencia na quantidade e no valor das licitações?
A fim de verificar a influência que o tamanho de um município tem em sua quantidade de fornecedores, de licitações, no seu gasto total e mediano em licitações, assim como no número mediano de propostas por licitação, é importante primeiro ver como é a distribuição dessa variáveis. Nessa análise, as cidades de Campina Grande e João Pessoa foram ocultadas, pois suas grandes populações dificultariam a comparação com os demais municípios.

```{r}
metricas <- participantes %>%
  group_by(
    de_Municipio = get.municipio(cd_UGestora),
    nu_Licitacao, tp_Licitacao, cd_UGestora) %>%
  summarise(nu_Participantes = n()) %>%
  group_by(de_Municipio) %>%
  summarise(nu_Propostas = median(nu_Participantes))

metricas <- participantes %>%
  group_by(de_Municipio = get.municipio(cd_UGestora)) %>%
  summarise(nu_Fornecedores = n()) %>%
  merge(metricas, all=T)

metricas <- licitacoes_fornecedor %>%
  group_by(de_Municipio = get.municipio(cd_UGestora)) %>%
  summarise(
    vl_Total = sum(vl_Licitacao),
    vl_Medio = median(vl_Licitacao),
    nu_Licitacoes = n()) %>%
  merge(metricas, all=T)

metricas <- municipios %>%
  merge(metricas, all=T) %>%
  filter(!de_Municipio %in% c('Campina Grande', 'João Pessoa')) %>%
  select(-cd_Municipio, -de_Municipio) %>%
  rename(
    `Fornecedores` = nu_Fornecedores,
    `Licitações` = nu_Licitacoes,
    `Mediana de propostas` = nu_Propostas,
    `Gasto total` = vl_Total,
    `Gasto mediano` = vl_Medio,
    `População` = vl_Populacao)

metricas %>%
  gather() %>%
  ggplot(aes(x = value)) +
    facet_wrap(~ key, scale='free') +
    geom_histogram() +
    labs (
      title = 'Distribuição de métricas por município',
      x = 'Valor',
      y = 'Ocorrências') +
    theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

Como mostram os histogramas acima, há uma aglomeração de valores à direita em todas as variáveis, o que dificulta a análise. É possível cotornar essa situação aplicando uma transformação logarítmica em cada uma delas, fazendo com que os valores passem a se concentrar no centro da distribuição.  

```{r}
metricas <- log(metricas)

metricas %>%
  gather() %>%
  ggplot(aes(x = value)) +
    facet_wrap(~ key, scale='free') +
    geom_histogram() +
    labs (
      title = 'Distribuição de métricas por município (log)',
      x = 'Valor',
      y = 'Ocorrências') +
    theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

Por fim, ao observar a curva de regressão abaixo e desconsiderando as cidades de maior porte, não parece haver uma relação forte entre o tamanho da população e nenhuma das variáveis, a não ser o gasto total com licitações. Isso é ainda mais perceptível utilizando uma matriz de correlação. Por meio dessa matriz, é possível ainda encontrar outras correlações como as existentes entre o número de licitações, de fornecedores e o gasto total.  

```{r}
metricas %>%
  gather(metrica, valor, -População) %>%
  ggplot(aes(x=População, y=valor)) +
    geom_point(na.rm=T) +
    geom_smooth(method='loess', na.rm=T) +
    facet_wrap(~metrica, scales='free') +
    labs (
      title = 'Métricas de licitação por município',
      y = 'Valor') +
    theme(
      axis.text.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank())

metricas %>%
  cor(use = 'pairwise.complete.obs') %>%
  corrplot(method = 'number', type = 'lower')
```
</div>

<br><br>
