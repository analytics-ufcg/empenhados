---
title: 'Classificação dos licitantes de merenda'
author: 'Laboratório Analytics'
subtitle: "Merenda Escolar"
layout: post
published: true
comments: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  screenshot.force = FALSE,
  fig.align = 'center',
  fig.width = 6,
  fig.height = 6
)

options(scipen = 999)
```

```{r}
library(RColorBrewer)

library(ggfortify)
library(ggplot2)
library(plotly)
library(knitr)

library(cluster)
library(dbscan)
library(tidyr)

library(methods)
source('../lib/load_licitantes_merenda.R')

theme_set(theme_bw())
```

```{r}
wssplot <- function(data, nc=15, seed=12346){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, type="b", xlab="Número de grupos",
                     ylab="Soma dos quadrados dos grupos")}
```

```{r}
dados <- load_licitantes_merenda()

licitantes <- dados$licitantes
ganhadores <- dados$vitorias
```

Considerando a forma como a Administração Pública gasta o dinheiro, o objetivo desse relatório é identificar dentre as empresas/pessoas físicas, que fornecem merenda ou que participaram de licitações que envolviam merenda, quais grupos de empresas tem comportamento parecido considerando algumas variáveis. Para isso utilizaremos uma técnica de agrupamento conhecida como k-means. 

O que você precisa saber para ler esse relatório é de que ao lançar uma licitação, dependendo de sua modalidade, as empresas podem apresentar propostas que serão avaliadas pela Administração Pública, conforme critérios estabelecidos no Edital da licitação. Então, as empresas vencedoras irão participar do processo de execução orçamentária do município. Nesse processo, o dinheiro destinado a empresa será empenhado, e a medida que a empresa vai executando corretamente o fornecimento do que foi acordado esse dinheiro é liquidado e pago. Mais sobre esse processo pode ser lido [aqui](https://analytics-ufcg.github.io/licitacoes-pb//2017/05/execucaoorcamentaria.html). 

## Licitantes
Nesse relatório estamos interessados em agrupar sob duas perspectivas. Na primeira delas, o conjunto de empresas/pessoas físicas que participaram de uma licitação que envolvia pelo menos *um item* de merenda. O critério estabelecido para determinar se existe um item de merenda é se pelo menos um empenho, que está associado a essa licitação, é destinado a Alimentação Escolar. 

### Descrição das variáveis
Foram analisados `r nrow(licitantes)` licitantes que participaram de uma licitação que gerou pelo menos um item de merenda. É importante dizer que não há garantia que o licitante tenha participado exclusivamente do item da licitação destinado a merenda, no entanto a sua participação é contada a partir do momento em que o mesmo fez alguma proposta a uma licitação que envolvia item de tal natureza. 

Os critérios considerados para a realização do agrupamento foram:

* Número de participações (participou): Número de licitações nas quais o licitante fez proposta.

* Municípios: Número de municípios distintos onde o licitante fez pelo menos uma proposta.

* Proporção de vitórias (Ganhou): Razão entre o número de participações em licitações e o número de vitórias (número de licitações relacionadas aos empenhos do licitante com a Administração Pública).

* Valor total empenhado: Soma do valor em reais de todos os empenhos relacionados ao licitante.

* Valor mediano empenhado: Mediana do valor em reais dos empenhos relacionados ao licitante .

* Valor total pago: Soma do valor em reais efetivamente pago ao licitante mediante transferência bancária.

Foram aplicadas técnicas de transformação e padronização nos dados a fim de obter os melhores resultados e visualizações possíveis.

```{r}
licitantes.log <- licitantes %>%
  mutate_each(funs(log(. + 1)), -c(nu_CPFCNPJ, no_Fornecedor))
licitantes.scaled <- licitantes.log %>%
  mutate_each(funs(scale(.) %>% c), -c(nu_CPFCNPJ, no_Fornecedor))

ganhadores.log <- ganhadores %>%
  mutate_each(funs(log(. + 1)), -c(cd_Credor, no_Credor))
ganhadores.scaled <- ganhadores.log %>%
  mutate_each(funs(scale(.) %>% c), -c(cd_Credor, no_Credor))
```

## Licitantes

Para nos auxliar na escolha do número de grupos nos quais classificaremos os licitantes de merenda usaremos uma visualização que nos mostra a soma do quadrado das distâncias dentro dos grupos em função do número de grupos. O desejado é a menor distância possível, pois indica que temos grupos bastante coesos, com um número de grupos que sejamos capazer de diferenciar e interpretar.
```{r}
wssplot(licitantes.scaled %>%
  select(-nu_CPFCNPJ, -no_Fornecedor), 
  nc = 20)
```
A visualização indica que com __6 grupos__ obtemos um melhor agrupamento já que com mais grupos que isto não temos grandes impactos na qualidade dos grupos. Em função disso optamos por classificar licitantes de merenda nesses grupos.

A distribuição dos licitantes em cada grupo pode ser vista no gráfico de dispersão abaixo que é dado em função das variáveis _PC1 e PC2_ que são aproximações para as variáveis usadas no agrupamento.
```{r}
set.seed(12346) # Garantir que o k-means gere o mesmo resultado
km_lic <- kmeans(select(licitantes.scaled, -c(nu_CPFCNPJ, no_Fornecedor)), centers = 6, nstart = 20)
?kmeans
autoplot(km_lic, data = licitantes.scaled, size = 2, main = 'Grupos obtidos utilizando o k-means') +
  scale_color_brewer(palette='Set2') + 
  labs(colour = 'Grupos')
```
Basicamente seus valores exatos para cada ponto não nos interessam, mas a visão geral dos licitantantes e seus grupos sim.

```{r}
licitantes.km <- licitantes.scaled %>%
  mutate(cluster = km_lic$cluster %>% as.factor)

licitantes.km.long <- licitantes.km %>%
  gather('variable', 'value', -c(nu_CPFCNPJ, no_Fornecedor), -cluster, factor_key=T)
```
A seguir observamos os 6 grupos gerados, cada um com um boxplot para cada vaiável usada no agrupamento.
```{r}
ggplot(licitantes.km.long, aes(x = variable, y = value, colour = variable)) +
  geom_boxplot() +
  geom_hline(alpha = 0.3, yintercept = 0) + 
  geom_point(alpha = 0.2, position = position_jitter(width = .2)) +
  facet_wrap(~ cluster, ncol = 3) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Agrupamento dos licitantes de merenda da Paraíba', x = '', y = '') +
  scale_color_brewer(palette='Dark2')
```
Com isso podemos observar o comportamento de cada grupo e estuda-los em função das suas particularidades, como segue:

#### Grupo 1 - Saudáveis
Neste grupo estão os licitantes que tem comportamento regular, suas taxas estão todas na média. Indicando que os fornecedores deste grupo são mais cautelos ao participar de uma licitação.
#### Grupo 2 - Gourmet
Que faz parte desse grupo participa muito em muitos municípios dando a ideia de que estão sempre experimentando novas formas de participar. Estes quando ganham, ganham bem pois tem o valor enpenhado, pago e a mediana do que foi emepenhado considarávelmente acima da média.
#### Grupo 3 - Nutricionistas
Esse pessoal sabe muito bem onde e o que comer. Participam pouco e em poucos municípíos mas mesmo assim ganham mais e melhor que os demais.
#### Grupo 4 - Bom-de_garfo
Quem está aqui é porque tem todas as taxas altas. Entra em várias licitações em muitos municípios e lucram bem com isso.
#### Grupo 5 - Magro-de-ruim
Come, come, come mas não engordam. Mesmo participando mais que a maioria, em geral não conseguem ganhar as licitações.
#### Grupo 6 - Estudantes de Nutrição
Esses estão aprendendo com os nutricionistas ainda. Participam pouco e em poucos municipios diferentes mas ganham bem com isso, um pouco pior que os verdadeiros nutricionistas mas ainda sim tem seus luctros.


## Ganhadores
```{r}
wssplot(ganhadores.scaled %>%
  select(-cd_Credor), 
  nc = 20)
```

```{r}
set.seed(12346) # Garantir que o k-means gere o mesmo resultado
km_gan <- kmeans(select(ganhadores.scaled, -cd_Credor), centers = 6, nstart = 20)

autoplot(km_gan, data = ganhadores.scaled, size = 2, main = 'Grupos obtidos utilizando o k-means') +
  scale_color_brewer(palette='Set2') + 
  labs(colour = 'Grupos')
```

```{r}
dists <- dist(select(ganhadores.scaled, -cd_Credor), method = 'euclidean')

colors <- brewer.pal(6, 'Set2')
plot(silhouette(km_gan$cluster, dists), col = colors, border = NA, main = 'Silhueta dos grupos usando o K-means')

```

```{r}
ganhadores.km <- ganhadores.scaled %>%
  mutate(cluster = km_gan$cluster %>% as.factor)

ganhadores.km.long <- ganhadores.km %>%
  gather('variable', 'value', -cd_Credor, -cluster, factor_key=T)
```

```{r}
ggplot(ganhadores.km.long, aes(x = variable, y = value, colour = variable)) +
  geom_boxplot() +
  geom_hline(alpha = 0.3, yintercept = 0) + 
  geom_point(alpha = 0.2, position = position_jitter(width = .2)) +
  facet_wrap(~ cluster, ncol = 3) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Agrupamento de ganhadores de licitações de merenda da Paraíba', x = '', y = '') +
  scale_color_brewer(palette='Dark2') 
```


