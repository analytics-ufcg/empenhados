---
title: 'Análise dos Licitantes de Merenda'
author: 'Laboratório Analytics'
date: '10 de abril de 2017'
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 6,
  fig.height = 6
)

options(scipen = 999)
```

```{r}
library(RColorBrewer)

library(ggfortify)
library(ggplot2)
library(plotly)
library(knitr)

library(cluster)
library(dbscan)
library(tidyr)

source('load-licitantes-lib.R')

theme_set(theme_bw())
```

# Introdução
Ao analisar as licitações de merenda ocorridas na Paraíba entre os anos de 2011 e 2015, verificou-se a presença de similaridades no comportamento das pessoas jurídicas que apresentaram ao menos uma proposta para as licitações do período analisado, referidas daqui em diante como **licitantes**. Com o objetivo de analisar mais detalhadamente essas similaridades, surgiu a iniciativa de dividir os licitantes em grupos utilizando técnicas de agrupamento e em seguida, traçar o perfil de cada um desses grupos.  

## Descrição da amostra
Foram analisados 758 licitantes que fizeram pelo menos uma proposta em licitações de merenda no estado da Paraíba entre os anos de 2011 e 2015.

```{r}
licitantes <- load_licitantes()
```

```{r}
licitantes.log <- licitantes %>%
  mutate_each(funs(log(. + 1)), -nu_CPFCNPJ)

licitantes.scaled <- licitantes.log %>%
  mutate_each(funs(scale(.) %>% c), -nu_CPFCNPJ)

dists <- dist(select(licitantes.scaled, -nu_CPFCNPJ), method = 'euclidean')

colors <- brewer.pal(7, 'Set2')
```

Os critérios considerados para a realização do agrupamento foram:

* Número de participações (participou): Número de licitações nas quais o licitante fez proposta.

* Total: Soma do valor em reais de todas as licitações nas quais o licitante fez proposta.

* Mediana: Mediana do valor em reais das licitações nas quais o licitante fez proposta.

* Municípios: Número de municípios distintos onde o licitante fez pelo menos uma proposta.

* Proporção de vitórias (Ganhou): Razão entre o número de participações em licitações e o número de vitórias (número de contratos do licitante com a Administração Pública).

* Total ganho: Soma do valor em reais de todos os contratos nos quais o licitante faz parte.

* Proporção de aditivos: Razão entre o número de aditivos que o licitante solicitou em seus contratos e o número de contratos que ele obteve.

Foram aplicadas técnicas de transformação e padronização nos dados a fim de obter os melhores resultados e visualizações possíveis. Além disso, três diferentes métodos de agrupamento foram testados a fim de obter o melhor resultado.

## Escolha do método
Os três métodos de agrupamento testados foram agrupamento hierárquico, k-means e o agrupamento baseado em densidade, DBCluster.  

### Utilizando o agrupamento hierárquico
O primeiro método analisado foi o agrupamento hierárquico, que procura construir os grupos analisando a semelhança entre os elementos e  grupos. Nesse método, a hierarquia é dita aglomerativa pois cada observação começa sendo um grupo e a cada iteração os grupos com maior similaridade se unem para formar um grupo maior até que se chegue ao número de grupos solicitado na análise.  

A divisão foi feita em 7 grupos visando obter um corte que não apresentasse tanta heterogeneidade entre membros de um mesmo grupo. Ou seja, elementos de um mesmo grupo devem ser parecidos entre si e diferentes dos elementos de outros grupos. Abaixo, é possível observar a árvore (**dendograma**) com a divisão final dos grupos de licitantes. 

```{r}
hc <- hclust(dists, method = 'ward.D')

plot(hc, hang=0, labels=FALSE)
rect.hclust(hc, k=7)

licitantes.hc <- licitantes.scaled %>%
  mutate(cluster = cutree(hc, k=7) %>% as.factor)

licitantes.hc.long <- licitantes.hc %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)
```

```{r}
pr.out <- prcomp(select(licitantes.scaled, -nu_CPFCNPJ), scale = FALSE)
autoplot(pr.out, data = licitantes.hc, colour = 'cluster', scale = 0, main = 'Grupos obtidos usando agrupamento hierárquico') +
  scale_color_brewer(palette='Set2') 
```

Abaixo, está disponível o **gráfico de silhueta** desse agrupamento. Esse gráfico tem o objetivo de descrever quão parecidos são os componentes dentro de um grupo. O ideal é que todos os grupos tenham um valor de silhueta elevado, no entanto observa-se que alguns licitantes estão em grupos mas caraterísticas diferentes do grupo. Uma das explicações para isso, seria o fato que esses licitantes não se encaixam muito bem em nenhum dos grupos propostos.  

Outro fator importante que pode ser observado através desta visualização é o número de observações de cada grupo. Percebe-se a existência de dois grupos grandes, que juntos comportam mais da metade das observações. Existem ainda dois grupos intermediários e mais 3 grupos pequenos, com menos de 50 licitantes em cada.

```{r}
plot(silhouette(cutree(hc, k=7), dists), col = colors, border = NA, main = 'Silhueta dos grupos usando agrupamento hierárquico')
```

### Utilizando o K-means
O k-means é um dos algoritmos mais usados para agrupamento. De forma similar ao agrupamento hierárquico, para usá-lo é necessário definir a quantidade de grupos que devem ser formados e os critérios para que elementos sejam agrupados. A partir do dendrogama gerado na análise anterior, verificou-se o número de grupos que geraria o melhor resultado para essa técnica também era 7.  

```{r}
set.seed(12346) # Garantir que o k-means gere o mesmo resultado
km <- kmeans(select(licitantes.scaled, -nu_CPFCNPJ), centers = 7, nstart = 10)

autoplot(km, data = licitantes.scaled, size = 2, main = 'Grupos obtidos utilizando o k-means') +
  scale_color_brewer(palette='Set2') + 
  labs(colour = 'Grupos')

licitantes.km <- licitantes.scaled %>%
  mutate(cluster = km$cluster %>% as.factor)

licitantes.km.long <- licitantes.km %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)
```

Ao comparar a largura média da silhueta gerada pela técnica anterior com a gerada pelo k-means, é perceptível uma melhora significativa de 0.35 para 0.42. Isso pode ser considerado um indício de que os grupos estão melhores definidos usando o k-means.  

```{r}
plot(silhouette(km$cluster, dists), col = colors, border = NA, main = 'Silhueta dos grupos usando o K-means')
```

### Utilizando o DBScan
Nessa técnica, um ponto inicial é escolhido aleatoriamente e verifica-se se há um determinado número de pontos na vizinhança deste. Caso isso ocorra, é criado um grupo que contém o ponto inicial e todos os pontos da sua vizinhança.

Esse procedimento é repetido para todos os pontos do grupo recém encontrado com a finalidade de aumentar o número de elementos desse grupo. Quando não é mais possível encontrar pontos pertencentes a esse grupo, o método tenta criar novos grupos utilizando pontos que ainda não tenham sido agrupados.

A principal diferença dessa técnica paras as técnicas usadas anteriomente, é o fato de ser possível que alguns pontos não tenham o número mínimo de pontos necessário para a formação de um grupo em sua vizinhança. Nesse caso, o ponto é considerado como um ponto de ruído e não pertence a nenhum grupo. Em nossa análise, os ruídos foram representados no grupo 1, embora não sejam formalmente um grupo.

```{r}
dbs <- dbscan(dists, eps = 1.1, minPts = 13)
dbs$cluster <- dbs$cluster + 1

licitantes.dbs <- licitantes.scaled %>%
  mutate(cluster = dbs$cluster %>% as.factor)

licitantes.dbs.long <- licitantes.dbs %>%
  gather('variable', 'value', -nu_CPFCNPJ, -cluster, factor_key=T)

pr.out <- prcomp(select(licitantes.scaled, -nu_CPFCNPJ), scale = FALSE)
autoplot(pr.out, data = licitantes.dbs, colour = 'cluster', scale = 0, main = 'Grupos obtidos usando o DBScan') +
  scale_color_brewer(palette='Set2') 
```

A utilização dessa técnica possibilitou a descoberta de 4 grupos de licitantes. Esse número de grupos é um pouco menor que o número que gerou os melhores resultados nos algoritmos anteriores. Esses grupos, ainda, apresentam grande heterogeneidade internamente, o que pode indicar que a divisão realizada não foi tão eficiente quando a realizada pelos métodos testados anteriormente.  

### A técnica escolhida
A partir da análise dos gráficos da silhueta e da adequação de cada método ao cenário analisado, foi possível concluir que a técnica que obteve os melhores resultados foi o agrupamento utilizando **k-means**.  

## Análise do agrupamento gerado pelo K-Means
A seguir observamos os 7 grupos gerados com a utilização da técnica k-means e uma breve descrição das características de cada um deles de acordo com as variáveis analisadas.  

```{r fig.width = 10, fig.height = 10}
ggplot(licitantes.km.long, aes(x = variable, y = value, colour = variable)) +
  geom_boxplot() +
  geom_hline(alpha = 0.3, yintercept = 0) + 
  geom_point(alpha = 0.2, position = position_jitter(width = .2)) +
  facet_wrap(~ cluster, ncol = 3) +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Agrupamento de licitantes de merenda da Paraíba', x = '', y = '') +
  scale_color_brewer(palette='Dark2') 
```

#### Grupo 1 - Insaciáveis
Os licitantes desse grupo costumam pedir mais prazo ou mais dinheiro durante o cumprimento dos contratos com uam frequência bem maior do que licitantes de outros grupos. Esses licitantes ganham muitas licitações e assinam contratos com valor acima da média.  

#### Grupo 2 - Gourmet
Os integrantes desse grupo participam de muitas licitações em vários municípios, gerando a impressão que estão sempre experimentando novas formas de participação. Em consequência disso, o valor total das licitações é acima da média. Ao contrário do que se poderia esperar, porém, o valor mediano das licitações em que participam mantém-se dentro do esperado.  

#### Grupo 3 - Saudáveis
Esse grupo apresenta as variáveis com valores mais próximos a média, sem nenhuma variação que se sobressaia. Indicando empresas que talvez sejam mais cautelosas ao escolher participar ou não de uma licitação.  

#### Grupo 4 - Gulosos
São licitantes que participam de licitações de alto valor mas que raramente ganham e quando ganham o valor de contrato é abaixo da média. Podem ser considerados os grandes perdedores da amostra analisada.

#### Grupo 5 - Famintos
Em geral, os licitantes desse grupo tem um porcentagem de vitórias abaixo da média. Por conta disso o valor total ganho em contratos também é abaixo da média. Nesse grupo, o total e a mediana do valor das licitações que os membros participaram é bem diverso, indicando não haver uma preferência dos membros desse grupo por participar em licitações de uma faixa de preço determinada.  

#### Grupo 6 - Fitness
Os licitantes desse grupo participam de licitações com valores pouco acima da média e tem uma alta porcentagem de vitórias.

#### Grupo 7 - Come-quieto
Caracteriza os licitantes que participam de poucas licitações, que geralmente tem valor abaixo da média, mas que possuem alta porcentagem de vitórias com relação aos demais participantes. Além disso, o valor dos contratos assinados por esses licitantes é um pouco acima da média.  

### Conclusão
A seguir, é possível observar a relação entre as variáveis analisadas em cada um dos grupos gerados.  

```{r}
p1 <- ggplot(licitantes.km.long, aes(x = variable, y = value, group = nu_CPFCNPJ, colour = cluster)) +
  geom_point(alpha = 0.2) +
  geom_line(alpha = .3) +
  facet_wrap(~ cluster, ncol = 2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x= '', y = '') +
  scale_color_brewer(palette='Set2') 

ggplotly(p1)
```

Nota-se que no grupo 1, dos licitantes que mais aditivam seus contratos existe uma variação alta com relação a variável número de municípios entre os licitantes desse grupo. Em geral no grupo 3, como dito anteriormente, os valores se mantém próximo a média para todos os licitantes do grupo, tornando-se o grupo com características mais lineares. Com exceção do grupo 2, os demais grupos apresentam praticamente a mesma média de aditivos entre todos os seus componentes.  