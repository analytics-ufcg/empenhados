---
title: "Análise das Licitações de Merenda na Paraíba"
author: "Gileade Silva, Júlio César Silva"
date: "6 de março de 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# Instancia conexão com o BD usando as configurações em ~/.my.cnf
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

licitacoes = tbl(sagres, 'licitacao') %>%
  filter(dt_Ano >= 2010) %>%
  collect(n = Inf)

utils = src_mysql('utils', group='ministerio-publico', password=NULL)

municipios = tbl(utils, 'municipio') %>%
  collect()

municipios$de_Municipio[199] = 'Sao Vicente do Serido'
```



```{r limpeza de dados}
unidades_gestoras = tbl(sagres, 'codigo_ugestora') %>% 
  select(de_Ugestora, cd_Ugestora) %>%
  distinct() %>%
  collect()

tipos_licitacao = tbl(sagres, 'tipo_modalidade_licitacao') %>% 
  select(de_TipoLicitacao) %>%
  collect() %>%
  mutate(de_TipoLicitacao = as.character(de_TipoLicitacao))

tipos_regime = tbl(sagres, 'regimeexecucao') %>% 
  select(de_regimeExecucao) %>%
  collect() %>%
  mutate(de_regimeExecucao = as.character(de_regimeExecucao))
  
# Verificar diferenças entre arquivos aqui
licitacoes = tbl(sagres, 'licitacao') %>% 
  filter(dt_Ano >= 2010) %>% 
  collect(n = Inf) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao)) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao, 
                               levels = c(levels(tp_Licitacao), '14'),
                               labels = tipos_licitacao$de_TipoLicitacao)) %>%
  mutate(tp_Objeto = factor(tp_Objeto)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao,
                                    levels = c('1', '2', '3', '4', '5'),
                                    labels = tipos_regime$de_regimeExecucao)) %>%
  select(-dt_Ano) %>%
  separate(dt_Homologacao, c('dt_AnoHomologacao', 'dt_MesHomologacao', 'dt_DiaHomologacao', 'dt_Hora', 'dt_Minuto', 'dt_Segundo')) %>%
  separate(dt_MesAno, c('dt_Mes', 'dt_Ano'), -5) %>%
  mutate(dt_Mes = as.integer(dt_Mes)) %>%
  mutate(dt_Ano = as.integer(dt_Ano)) %>%
  select(-c(dt_Hora, dt_Minuto, dt_Segundo, registroCGE)) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  mutate(dt_AnoHomologacao = as.integer(dt_AnoHomologacao)) %>%
  mutate(dt_MesHomologacao = as.integer(dt_MesHomologacao)) %>%
  mutate(dt_DiaHomologacao = as.integer(dt_DiaHomologacao)) %>%
  left_join(unidades_gestoras, c('cd_UGestora' = 'cd_Ugestora')) %>%
  mutate(de_UGestora = factor(de_Ugestora)) %>%
  select(-de_Ugestora) %>%
  left_join(municipios, 'cd_Municipio')

#OS dados onde de_UGestora = NA aparentam ser uma anomalia nos dados, devemos removê-los?
```

```{r removendo tabelas}
rm(tipos_licitacao)
rm(tipos_regime)
rm(unidades_gestoras)
```

```{r filtrando merendas}
licitacoes_merenda = licitacoes %>%
  filter(grepl('alimentacao[[:space:]]escolar|merenda', licitacoes$de_Obs, ignore.case = T))
```

# Introdução
A licitação é um processo utilizado pela administração pública como meio de contratar obras e serviços, adquirir produtos e realizar locações selecionando a proposta mais vantajosa e de maior qualidade entre diversas propostas oferecidas. Definido pela lei 8666/1993, o processo licitatório deve seguir os princípios de isonomia, transparência e impessoalidade.  
Uma das utilizações dos processos licitatórios diz respeito à compra de alimentação escolar, ou merenda. No passado recente, diversas irregularidades foram encontradas nessa área, que vem se mostrando como uma das favoritas para a realização de desvios e superfaturamentos. {[1](http://paraibaonline.com.br/balanco-da-cgu-revela-desvios-de-r-2-bilhoes-da-merenda-escolar/)}{[2](http://www.paraiba.com.br/2017/02/25/12605-ministerio-da-transparencia-fiscaliza-prefeituras-da-pb-e-constata-superfaturamento-de-merenda-escolar)}  
O objetivo dessa análise é descrever como se dá a realização de licitações para compra de merenda no estado da Paraíba, observando tendências e discrepâncias que possam surgir.  

# Análises
## 4 - Em que período do ano ocorrem mais licitações de merenda?
Seguindo com a análise feita nas perguntas anteriores, buscou-se verificar se há algum período do ano que concentra mais licitações de merenda.  
Foram analisados os dados no período compreendido entre os anos 2011 e 2015 e observou-se que o intervalo entre os meses de fevereiro e abril concentra a maioria das licitações de merenda e que o número de licitações desse tipo decai conforme nos aproximamos dos meses finais do ano.  
Segundo o gráfico abaixo, podemos ainda observar que tal concentração se dá exatamente nos primeiros meses da volta às aulas da escolas, onde possivelmente são firmados contratos anuais de distribuição de alimentação escolar. 

```{r fig.cap='Figura lorem'}
ggplot(aes(x = dt_Mes), 
       data = filter(licitacoes_merenda, dt_Ano > 2010 & dt_Ano < 2016 & dt_Mes != 0)) +
  geom_histogram(binwidth = 1, fill = I('#CF6360')) +
  scale_x_continuous(breaks = seq(1,12,1)) +
  labs(title = 'Total de licitações por mês entre os anos 2011 e 2015',
       x = 'Mês', y = 'Total')
```

## 7 - Geralmente, quantas propostas são recebidas para licitações de merenda?
Conforme descrito na figura lorem, é possível observar que grande parte das licitações de merenda (`r round(nrow(filter(licitacoes_merenda, nu_Propostas < 5))/nrow(licitacoes_merenda) * 100, 2)`%) recebeu menos de 5 propostas.

```{r fig.cap='Figura lorem'}
ggplot(aes(x = nu_Propostas), data = licitacoes_merenda) +
  geom_histogram(fill = I('#e2a76f'), binwidth = 1) +
  labs(title = 'Total de propostas para licitações de merenda',
       x = 'Número de propostas', y = 'Total') +
  scale_x_continuous(breaks = seq(0, 50, 5)) +
  scale_y_continuous(breaks = seq(0,1500,250))
```

É possível ainda, restringir a abrangência do gráfico à área de maior concentração e perceber que a maioria das licitações de merenda (`r round(nrow(filter(licitacoes_merenda, nu_Propostas == 3))/nrow(licitacoes_merenda) * 100, 2)`)% recebeu apenas 3 propostas.

```{r fig.cap ='Figura lorem'}
ggplot(aes(x = nu_Propostas), data = licitacoes_merenda) +
  geom_histogram(fill = I('#b2628b'), binwidth = 1) +
  labs(title = 'Total de propostas para licitações de merenda',
       x = 'Número de propostas', y = 'Total') +
  scale_x_continuous(breaks = 0:6, limits = c(0,6)) +
  scale_y_continuous(breaks = seq(0,1500,250))
```

Por outro lado, há 2 licitações cujo número de participantes passa dos 25, desviando-se mais de 10 vezes do número médio de participantes das demais. Uma dessas licitações foi realizada em João Pessoa em 2015, enquanto a outra, foi realizada em Monteiro no ano de 2014. 
Os detalhes desses dois processos podem ser observados na tabela abaixo.

| Cidade | Ano | Propostas | Valor(R$) |
|:------:|:---:|:---------:|:---------:|
|João Pessoa|2015|31|25.078.839,00|
|Monteiro|2014|50|250.911,00|


## 8 - Que tipo de licitação é mais comum na compra de merenda?
A seguir, buscamos entender se há algum tipo de licitação mais comum ou padrão a ser utilizado na compra de alimentação escolar. Aqui, foi possível observar a maior parte das licitações de merenda fazem parte das modalidades convite e pregão presencial. Outros tipos como concorrência, tomada de preços e chamada pública também são amplamente utilizados. Um número expressivo de licitações, ainda, é considerado dispensável.  

```{r fig.cap='Figura lorem'}
ggplot(aes(x = tp_Licitacao), data = licitacoes_merenda) +
  geom_bar(aes(fill = tp_Licitacao)) +
  scale_x_discrete(labels = c()) +
  labs(title = 'Quais licitações são mais comuns na compra de merenda?', 
       x = 'Tipo de licitação', y = 'Total', fill = 'Tipo de licitação')

#Por que tantas licitações dispensáveis? Analisar melhor
```


## 10 - A popularidade de algum tipo de licitação mudou ao longo dos anos?

```{r}
## Deve Juntar os dois tipos de pregão?
## Por que a chamada pública e pregão eletronico só começam em 2013?
ggplot(aes(x = dt_Ano), 
       data = (licitacoes_merenda %>%
                 filter(dt_Ano > 2010 & dt_Ano < 2016 & dt_Mes != 0) %>%
                 group_by(dt_Ano, tp_Licitacao) %>%
                 summarize(total = n()) %>%
                 ungroup()
               )) +
  geom_line(aes(y = total, color = tp_Licitacao)) +
  labs(title = 'Popularidade dos tipos de licitação entre os anos 2011 e 2015',
       x = 'Ano', y = 'Total de licitações', color = 'Tipo de licitação')
```

## 11 - As licitaçoes mais caras estao concentradas em alguma época do ano?
```{r}
media_total = mean(licitacoes_merenda$vl_Licitacao)/1000

ggplot(aes(x = dt_Mes, y = vl_Licitacao/1000), 
       data = filter(licitacoes_merenda, dt_Ano > 2010 & dt_Ano < 2016 & dt_Mes != 0)) +
  geom_line(stat = 'summary', fun.y = 'mean') +
  geom_point(stat = 'summary', fun.y = 'mean') +
  geom_hline(yintercept = media_total, 
             color = 'red', linetype = 'dashed') +
  scale_x_continuous(breaks = 1:12) +
  geom_text(aes(1, media_total, label = 'Média anual', vjust = -1, hjust = -0.1), size = 4) +
  labs(title = 'Valor médio de licitações por mês entre os anos 2011 e 2015',
       x = 'Mês', y = 'Valor médio em reais (x1000)')
```

## 12 - Há correlação linear entre o valor da licitação e o total de propostas recebidas?
```{r}
ggplot(aes(x = vl_Licitacao/1e+06, y = nu_Propostas), data = licitacoes_merenda) +
  geom_jitter(alpha = 0.2) +
  labs(title = 'Número de propostas por valor total de licitação',
       x = 'Valor de licitação (em milhões de reais)', y = 'Número de propostas') +
  scale_x_continuous()

with(licitacoes_merenda, cor(vl_Licitacao, nu_Propostas))

ggplot(aes(x = vl_Licitacao/1e+06, y = nu_Propostas), 
       data = filter(licitacoes_merenda, vl_Licitacao <= 3e+06)) +
  geom_jitter(alpha = 0.2) +
  scale_x_continuous(breaks = 0:3, labels = 0:3, limits = c(0,3)) + 
  labs(title = 'Número de propostas por valor total de licitação',
       x = 'Valor de licitação (em milhões de reais)', y = 'Número de propostas') 

with(filter(licitacoes_merenda, vl_Licitacao <= 3e+06), 
     cor(vl_Licitacao, nu_Propostas))
```












