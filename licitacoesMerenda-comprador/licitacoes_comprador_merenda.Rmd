---
title: "licitacoes_comprador_merenda"
author: "Gileade, Júlio"
date: "6 de março de 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.width = 10)
```

```{r}
library('dplyr')
library('tidyr')
library('ggplot2')


# Instancia conexão com o BD usando as configurações em ~/.my.cnf
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

licitacoes = tbl(sagres, 'licitacao') %>%
  filter(dt_Ano >= 2010) %>%
  collect(n = Inf)
```



```{r limpeza de dados}
unidades_gestoras = tbl(sagres, 'codigo_ugestora') %>% 
  select(de_Ugestora, cd_Ugestora) %>%
  distinct() %>%
  collect()

tipos_licitacao = tbl(sagres, 'tipo_modalidade_licitacao') %>% 
  select(de_TipoLicitacao) %>%
  collect() %>%
  mutate(de_TipoLicitacao = as.character(de_TipoLicitacao))

tipos_regime = tbl(sagres, 'regimeexecucao') %>% 
  select(de_regimeExecucao) %>%
  collect() %>%
  mutate(de_regimeExecucao = as.character(de_regimeExecucao))
  
licitacoes = tbl(sagres, 'licitacao') %>% 
  filter(dt_Ano >= 2010) %>% 
  collect(n = Inf) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao)) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao, 
                               levels = c(levels(tp_Licitacao), '14'),
                               labels = tipos_licitacao$de_TipoLicitacao)) %>%
  mutate(tp_Objeto = factor(tp_Objeto)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao,
                                    levels = c('1', '2', '3', '4', '5'),
                                    labels = tipos_regime$de_regimeExecucao)) %>%
  separate(dt_Homologacao, c('dt_AnoHomologacao', 'dt_MesHomologacao', 'dt_DiaHomologacao', 'dt_Hora', 'dt_Minuto', 'dt_Segundo')) %>%
  select(-c(dt_Hora, dt_Minuto, dt_Segundo, registroCGE)) %>%
  # verificando relacoes entre colunas com datas
  # select(dt_Ano, nu_Licitacao, dt_AnoHomologacao, dt_MesHomologacao, dt_MesAno) %>%
  # separate(nu_Licitacao, c('cd_licitacao','cd_ano_Licitacao'), -5) %>%
  # separate(dt_MesAno, c('dt_Mes_', 'dt_Ano_'), -5)
  # ate aqui
  select(-dt_MesAno) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  mutate(dt_AnoHomologacao = as.integer(dt_AnoHomologacao)) %>%
  mutate(dt_MesHomologacao = as.integer(dt_MesHomologacao)) %>%
  mutate(dt_DiaHomologacao = as.integer(dt_DiaHomologacao)) %>%
  left_join(unidades_gestoras, c('cd_UGestora' = 'cd_Ugestora')) %>%
  mutate(de_UGestora = factor(de_Ugestora)) %>%
  select(-de_Ugestora)

```

```{r removendo tabelas}
rm(tipos_licitacao)
rm(tipos_regime)
rm(unidades_gestoras)
```

## 1 - Qual o número total de licitações feitas por ano entre 2010 e 2016?
Para responder a essa pergunta utilizou-se todos os dados referentes a licitações entre os anos de 2010 até 2016. Esse intervalo foi escolhido pois é o que apresenta a grande maioria do número de licitações. O objetivo seria identificar se existe uma tendência anual para o número de licitações em toda a Paraíba ou se existe algum ano que o número de licitações é muito diferente dos demais.

```{r total de licitacoes na paraiba}
ggplot(aes(dt_Ano), data = licitacoes) +
  geom_bar(fill = '#CF6360') +
  xlab("Ano") +
  ylab("Número total de licitações") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000)) +
  ggtitle("Total de licitações por ano")
```

Segundo o gráfico acima percebe-se que no ano de 2010 cerca de `r count(subset(licitacoes, licitacoes$dt_Ano == 2010))` licitações foram realizadas, esse valor é bem superior se comparado com os anos seguintes. No ano de 2016 é observado uma queda do número de licitações, isso se deve ao fato de que os dados observados possuem licitações até maio de 2016, ao contrário dos outros anos em que os dados possuem todos os meses.

## 2 - Qual o número de licitações feitas por ano em João Pessoa em relação ao número de licitações feitas na Paraíba?
Em seguida, buscamos verificar como a capital e maior cidade da Paraíba aparece nos dados de licitação. Buscou-se verificar se a mesma possui uma parcela significativa no número de licitações com relação a todo o Estado.

```{r}
# Código do Município de João Pessoa é "095"
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Restante da Paraíba"), data = licitacoes) +
  geom_bar(aes(fill = "João Pessoa"), data = subset(licitacoes, cd_Municipio == "095")) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações feitas na Paraíba e em João Pessoa por ano") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000))
```

Pelo gráfico fica claro que entre 2011 e 2014 o número de licitações feitas em João Pessoa possui um valor semelhante, mas em 2015 esse valor em relação ao total de licitações no estado aumenta muito. Inicialmente, somente por este gráfico não é possível saber a causa dessa diferença entre 2015 e os outros anos.

## 3 - Qual o número de licitações que envolvem as palavras merenda e alimentação escolar?
Agora que já entendemos um pouco sobre como o número de licitações se comportam ao longo do ano, e algumas tendências e anomalias, buscamos responder essa pergunta filtrando apenas as licitações que possuem em sua descrição as seguintes sentenças: "Merenda" e "Alimentação escolar". O filtro foi feito ignorando acentos e caixa alta.

```{r filtrando licitacoes que envolvem merenda escolar}
licitacoes_merenda = licitacoes %>%
  filter(grepl('alimentacao[[:space:]]escolar|merenda', licitacoes$de_Obs, ignore.case = T))
```

```{r}
ggplot(aes(dt_Ano), data = licitacoes_merenda) +
  geom_bar(fill = I('#009688')) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda por ano") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 1500, 250))
```

Pelo gráfico nota-se que novamente em 2010 cerca de `r count(subset(licitacoes_merenda, licitacoes_merenda$dt_Ano == 2010))` licitações envolvendo merenda foram feitas, número esse bem grande se comparado a outros anos entre 2011 e 2015 (`r count(subset(licitacoes_merenda, licitacoes_merenda$dt_Ano != 2010 & licitacoes_merenda$dt_Ano != 2016))` licitações). O ano de 2016 possui um baixo número de licitações envolvendo merenda já que os dados estão atualizados até maio de 2016.

```{r}
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Outras Licitações"), data = licitacoes) +
  geom_bar(aes(fill = "Merenda Escolar"), data = licitacoes_merenda) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda em relação ao total de licitações") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2010, 2016)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000))
```

Se compararmos os dois gráficos(o número total de licitações por ano e o número total de licitações envolvendo merenda por ano) nota-se que licitações envolvendo merenda representam uma pequena parcela do universo de licitações. A partir daqui, vamos buscar analisar de forma mais específica essa pequena parcela e responder mais algumas perguntas.

## Analisando o valor da licitação
Até aqui trabalhamos com o número total de licitações, a seguir vamos buscar entender como o valor da licitação se comporta.
Inicialmente, determinamos a média e a mediana do valor(em Reais) de licitações envolvendo merenda, como mostrado a seguir.

## 5 - Qual a média do valor da licitação por merenda?
```{r}
mean(licitacoes_merenda$vl_Licitacao)
```

## 6 - Qual a mediana do valor da licitação por merenda?
```{r}
median(licitacoes_merenda$vl_Licitacao)
```

Nota-se que a diferença entre a média e a mediana é de `r  format(mean(licitacoes_merenda$vl_Licitacao) - median(licitacoes_merenda$vl_Licitacao), scientific=FALSE)` reais, isso pode indicar que a média não é uma boa medida para representar os dados de licitações quando estamos trabalhando com merenda. A causa disso é que alguns valores de licitação muito altos estão influenciando a média causando essa diferença.

## 7 - Qual o comportamento da média e da mediana do valor das licitações de merenda ao longo dos anos(2010-2016)?
No gráfico a seguir mostramos como o valor da média(preto) e da mediana(azul) se comporta entre os anos de 2010 e 2016.

```{r}
ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000), data = licitacoes_merenda) +
  geom_point(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = median, color = 'blue') +
  geom_point(stat = 'summary', fun.y = median, color = 'blue') +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor da licitação (mil reais)", title = "Valor médio e mediano das licitações de merenda por ano")
```

Observamos que a média sempre está acima da mediana, no ano de 2010 elas estavam bem próximas, mas nos anos seguintes a tendência foi a diferença aumentar, principalmente em 2014. Nesse ano algumas licitações de alto valor foram realizadas, o que afetou a média. Outra coisa que é possível perceber a partir desse gráfico é que, em geral, o valor das licitações que envolvem merenda aumentaram com o tempo.

## 10 - O valor médio da licitação alterou ao longo dos anos com relação aos tipos de licitação?
Outra variável interessante de se analisar nos dados é o tipo de licitação. Será que o valor médio(em reais) de licitação varia com o seu tipo ou ainda se esse valor também sofre influência do ano em que a licitação foi realizada. Essas são algumas questões que o gráfico a seguir pode responder.

```{r}
niveis = levels(licitacoes_merenda$tp_Licitacao)
niveis[niveis == 'Pregão (Eletrônico e Presencial)'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Pregão Eletrônico'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Pregão Presencial'] = 'Pregão (Eletrônico e Presencial)'
niveis[niveis == 'Dispensa por outros motivos'] = 'Dispensa'
niveis[niveis == 'Dispensa por Valor'] = 'Dispensa'
levels(licitacoes_merenda$tp_Licitacao) = niveis


ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000, color = tp_Licitacao), data = licitacoes_merenda) +
  geom_point(stat = "summary", fun.y = "mean") +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor médio das licitações (mil reais)", title = "Valor médio das licitações por tipo de licitação ao longo dos anos", color = "Modalidade de licitação")
```

Observou-se que algumas modalidades de licitações não possuem valores médios em alguns anos, isso ocorre porque não houve licitações daquele tipo naquele ano. Alguns tipos de licitações se destacam por seu valor médio parecido e acima dos demais, são elas: Pregão (Eletrônico e Presencial), Adesão a Registro de Preço e Tomada de preços. Algumas modalidades possuem valores limites, por exemplo, Licitações por Convite não podem ter valor superior a 80 mil reais, isso fica claro no gráfico já que a média de licitações dessa modalidade fica em torno desse valor. Além disso, em geral, o valor médio das licitações aumentaram com os anos em praticamente todos os tipos de licitação.

A partir dessa resposta faz-se necessário saber se existem licitações de merenda da modalidade de Convite que ultrapassam o valor limite de 80.000 mil reais previsto pela Lei 8666. Descobrimos que `r nrow(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & vl_Licitacao > 80000))` licitações possuem valor acima do limite. Essa inconsistência pode ser melhor investigada em análises futuras.

## Qual o total de licitações de merenda com relação número de participantes por modalidade?
Para responder a essa pergunta iremos considerar, inicialmente, os anos de 2010 até 2016. A figura abaixo mostra a frequência de licitações de acordo com o número de propostas. Limitamos o número de propostas para no máximo 6 já que esse intervalo(1:6) contém 96% dos dados de merenda. O 96º percentil é `r quantile(licitacoes_merenda$nu_Propostas, probs = c(.956))`.

```{r}
ggplot(aes(nu_Propostas), data = licitacoes_merenda) +
  geom_bar(aes(fill = tp_Licitacao), position = 'dodge') +
  scale_x_continuous(limits = c(0, 6.5), breaks = seq(0, 6, 1)) +
  scale_y_continuous(breaks = seq(0, 1200, 100)) +
  labs(x = 'Número de propostas', y = 'Número de licitações', fill = 'Modalidade', title = 'Total de licitações por número de propostas por modalidade')
```

Observou-se que a modalidade que mais possui licitações é Convite, e a maioria das licitações dessa modalidade possuem 3 propostas, isso ocorre devido ao número mínimo de participantes de uma licitação dessa modalidade que é 3, estabelecido pela Lei Nº 8666.

A interpretação do gráfico nos levou a outra pergunta: existem licitações de merenda da modalidade convite com número de propostas inferior ao número mínimo(3) exigido por Lei?
Encontramos `r count(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & nu_Propostas < 3))` licitações de merenda que são da modalidade Convite e possuem menos de 3 propostas, o que não é permitido por Lei.

No ano de 2010, `r sprintf("%.1f %%", count(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & dt_Ano == 2010)) / count(subset(licitacoes_merenda, dt_Ano == 2010))*100)` das licitações de merenda são da modalidade convite, totalizando `r nrow(subset(licitacoes_merenda, tp_Licitacao == 'Convite' & dt_Ano == 2010))` licitações. Se retirarmos esse ano da nossa análise podemos melhor identificar que outras modalidades, com relação ao número de propostas, são mais frequentes.

```{r}
ggplot(aes(nu_Propostas), data = subset(licitacoes_merenda, dt_Ano > 2010)) +
  geom_bar(aes(fill = tp_Licitacao), position = 'dodge') +
  scale_x_continuous(limits = c(0, 6.5), breaks = seq(0, 6, 1)) +
  scale_y_continuous(breaks = seq(0, 400, 50)) +
  labs(x = 'Número de propostas', y = 'Número de licitações', fill = 'Modalidade', title = 'Total de licitações por número de propostas por modalidade (a partir de 2011)')
```

Ao considerarmos as licitações de merenda feitas a partir de 2011 percebemos que a frequência de licitações da modalidade Convite diminui bastante, mas permanece sendo mais frequente quando o número de propostas é igual a 3. A modalidade de Pregão(Eletrônico e presencial) em grande parte das licitações possui apenas 1 proposta. Pelos dados não é possível concluir a razão pela qual o número de licitações de convite é tão superior em 2010 em relação a outros anos.


```{r}
library(maps) #mapas simples, eixos, escala, cidades 
library(ggmap) #Gmaps, OSM + mapas baseados em ggplot2
library(rgdal)
library(RColorBrewer)
```

```{r}
utils = src_mysql('utils', group='ministerio-publico', password=NULL)

# Lista dos municípios da paraíba organizados pelo código (Referente aos três últimos dígitos da Unidade Gestora)
municipios = tbl(utils, 'municipio') %>%
  collect()
```

```{r, results='hide'}
# Encontrado em: http://www.aesa.pb.gov.br/geoprocessamento/geoportal/shapes.html
mapa_paraiba <- readOGR("./Municipios/Municipios.shp")

# Atualizando nome de municípios que mudaram de nome nos últimos anos
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa 
```

```{r}
# Join das tabelas de licitação com o nome do município
merenda_paraiba = licitacoes_merenda %>%
  left_join(municipios, 'cd_Municipio')

# Join entre a tabela de licitações e a lista de municípios do mapa
mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = merenda_paraiba %>% inner_join(mapa_paraiba@data, c('de_Municipio' = 'Nome_Munic'))

# Sumarização dos dados por município
paraiba_sumarizado = paraiba %>%
  group_by(de_Municipio) %>%
  summarize(total = n())

# Imputação de dados (municípios que não tiveram licitações de merenda) e mais Sao Vicente do Serido que nao foi inserido no join
data_temp = data.frame(de_Municipio = c('Mato Grosso', 'Nova Floresta', 'Mamanguape', 'Sao Vicente do Serido'),
                       total = c(0, 0, 0, 9))
paraiba_sumarizado = rbind(paraiba_sumarizado, data_temp)

# Dividindo em faixas
paraiba_sumarizado$total = cut(paraiba_sumarizado$total, 
                                breaks = c(0,5,10,15,20,25,30,40,70), 
                                include.lowest = T)
```

## Qual a distribuição do número de licitações que envolvem merenda nos municípios da Paraíba?
Para responder a essa pergunta iremos utilizar o mapa de municípios da paraíba par obter a distribuição geográfica dos municípios da Paraíba e o número total de licitações relacionadas a merenda realizadas em todos os anos investigados(2010-2016). O mapa com os municípios foi retirado do site da AESA{[3](http://www.aesa.pb.gov.br/geoprocessamento/geoportal/shapes.html)}.

```{r}
# Criando um data frame com os municípios na ordem do mapa
levels_mapa = mapa_paraiba@data$Nome_Munic
paraiba_municipios = data.frame(levels_mapa, mapa_paraiba@data$OBJECTID)

# Associando cada municipio do mapa ao municipio correspondente no dataframe de sumarização
paraiba_municipios = paraiba_municipios %>% left_join(paraiba_sumarizado, c('levels_mapa' = 'de_Municipio'))

colors = brewer.pal(8,"YlOrRd")

# A variável Y recebe os valores em ordem que devem apontar para cada municipio
mapa_paraiba@data$Y <- paraiba_municipios$total
spplot(mapa_paraiba, 'Y',  col.regions= colors, main = "Número de licitações de merenda por município")
```

Observou-se que alguns municípios, como Santa Rita e Monteiro realizaram um maior número de licitações no período do que os demais municípios. A capital João Pessoa apresentou um número baixo de licitações relacionadas a merenda se comparada a esses dois municípios citados a pouco, apenas `r nrow(subset(licitacoes_merenda, cd_Municipio == '095'))` licitações. Ao olhar o mapa vemos que alguns municípios possuem um total de licitações próximo, e inclusive são municípios vizinhos. Só por esse mapa não é possível concluir se o tamanho, população e outras características podem influenciar na forma com que os municípios lidam com as licitações de merenda, nem se municípios com características parecidas lidam também de forma parecida com a merenda escolar. Mais tarde nessa análise trataremos mais sobre como as características dos municípios, como a população, influenciam nas variáveis de merenda no conjunto de dados.




























