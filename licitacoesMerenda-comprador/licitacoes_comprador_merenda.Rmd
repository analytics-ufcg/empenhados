---
title: "licitacoes_comprador_merenda"
author: "Gileade, Júlio"
date: "6 de março de 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE)
```

```{r}
library('dplyr')
library('tidyr')
library('ggplot2')


# Instancia conexão com o BD usando as configurações em ~/.my.cnf
sagres = src_mysql('sagres', group='ministerio-publico', password=NULL)

licitacoes = tbl(sagres, 'licitacao') %>%
  filter(dt_Ano >= 2010) %>%
  collect(n = Inf)
```



```{r limpeza de dados}
unidades_gestoras = tbl(sagres, 'codigo_ugestora') %>% 
  select(de_Ugestora, cd_Ugestora) %>%
  distinct() %>%
  collect()

tipos_licitacao = tbl(sagres, 'tipo_modalidade_licitacao') %>% 
  select(de_TipoLicitacao) %>%
  collect() %>%
  mutate(de_TipoLicitacao = as.character(de_TipoLicitacao))

tipos_regime = tbl(sagres, 'regimeexecucao') %>% 
  select(de_regimeExecucao) %>%
  collect() %>%
  mutate(de_regimeExecucao = as.character(de_regimeExecucao))
  
licitacoes = tbl(sagres, 'licitacao') %>% 
  filter(dt_Ano >= 2010) %>% 
  collect(n = Inf) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao)) %>%
  mutate(tp_Licitacao = factor(tp_Licitacao, 
                               levels = c(levels(tp_Licitacao), '14'),
                               labels = tipos_licitacao$de_TipoLicitacao)) %>%
  mutate(tp_Objeto = factor(tp_Objeto)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao)) %>%
  mutate(tp_regimeExecucao = factor(tp_regimeExecucao,
                                    levels = c('1', '2', '3', '4', '5'),
                                    labels = tipos_regime$de_regimeExecucao)) %>%
  separate(dt_Homologacao, c('dt_AnoHomologacao', 'dt_MesHomologacao', 'dt_DiaHomologacao', 'dt_Hora', 'dt_Minuto', 'dt_Segundo')) %>%
  select(-c(dt_Hora, dt_Minuto, dt_Segundo, registroCGE)) %>%
  # verificando relacoes entre colunas com datas
  # select(dt_Ano, nu_Licitacao, dt_AnoHomologacao, dt_MesHomologacao, dt_MesAno) %>%
  # separate(nu_Licitacao, c('cd_licitacao','cd_ano_Licitacao'), -5) %>%
  # separate(dt_MesAno, c('dt_Mes_', 'dt_Ano_'), -5)
  # ate aqui
  select(-dt_MesAno) %>%
  mutate(cd_UGestora_copy = cd_UGestora) %>%
  separate(cd_UGestora_copy, c('cd_UnGestora', 'cd_Municipio'), -4) %>%
  mutate(dt_AnoHomologacao = as.integer(dt_AnoHomologacao)) %>%
  mutate(dt_MesHomologacao = as.integer(dt_MesHomologacao)) %>%
  mutate(dt_DiaHomologacao = as.integer(dt_DiaHomologacao)) %>%
  left_join(unidades_gestoras, c('cd_UGestora' = 'cd_Ugestora')) %>%
  mutate(de_UGestora = factor(de_Ugestora)) %>%
  select(-de_Ugestora)

```

```{r removendo tabelas}
rm(tipos_licitacao)
rm(tipos_regime)
rm(unidades_gestoras)
```

## Qual o número total de licitações feitas por ano entre 2010 e 2016?
```{r total de licitacoes na paraiba}
ggplot(aes(dt_Ano), data = licitacoes) +
  geom_bar(fill = '#CF6360') +
  xlab("Ano") +
  ylab("Número total de licitações") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000)) +
  ggtitle("Total de licitações por ano")
```

Percebe-se que grande parte do número de licitações do conjunto de dados aconteceu em 2010. O ano de 2016 possui um número de licitações bem inferior ao dos anos anteriores pois os dados foram coletados apenas até maio de 2016.

## Qual o número de licitações feitas por ano em João Pessoa em relação ao número de licitações feitas na Paraíba?
```{r}
# Código do Município de João Pessoa é "095"
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Restante da Paraíba"), data = licitacoes) +
  geom_bar(aes(fill = "João Pessoa"), data = subset(licitacoes, cd_Municipio == "095")) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações feitas na Paraíba e em João Pessoa por ano") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000))
```

No ano de 2015, a maioria das licitações foram feitas em João Pessoa. Apesar de ser a maior cidade da Paraíba, é "entranho" ter uma diferença tão grande em relação aos demais anos.


## Qual o número de licitações que envolvem as palavras merenda e alimentação escolar?
```{r filtrando licitacoes que envolvem merenda escolar}
licitacoes_merenda = licitacoes %>%
  filter(grepl('alimentacao[[:space:]]escolar|merenda', licitacoes$de_Obs, ignore.case = T))
```

```{r}
ggplot(aes(dt_Ano), data = licitacoes_merenda) +
  geom_bar(fill = I('#009688')) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda por ano")
  scale_x_continuous(breaks = seq(2010, 2016, 1))
```

Filtrando apenas as licitações que possuem em sua descrição as palavras "merenda" ou "alimentação escolar", observa-se que novamente em 2010 existe uma grande diferença do número de licitações em relação a outros anos.

```{r}
ggplot(NULL, aes(dt_Ano)) + 
  geom_bar(aes(fill = "Outras Licitações"), data = licitacoes) +
  geom_bar(aes(fill = "Merenda Escolar"), data = licitacoes_merenda) +
  xlab("Ano") +
  ylab("Número total de licitações") +
  ggtitle("Total de licitações de merenda em relação ao total de licitações") +
  labs(fill = "") +
  scale_x_continuous(breaks = seq(2010, 2016)) +
  scale_y_continuous(breaks = seq(0, 60000, 10000))
```

## Qual a média do valor das licitações de merendas?
```{r}
mean(licitacoes_merenda$vl_Licitacao)
```
## Qual a mediana do valor das licitações de merendas?
```{r}
median(licitacoes_merenda$vl_Licitacao)
```
A diferença entre a média e a mediana é grande, ou seja, alguns valores extremos podem estar influenciando a média, fazendo com que a mesma não seja uma medida muito precisa para representar os dados.

## Qual o comportamento da média e da mediana do valor das licitações de merenda ao longo dos anos(2010-2016)?
```{r}
ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000), data = licitacoes_merenda) +
  geom_point(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = mean) +
  geom_line(stat = 'summary', fun.y = median, color = 'blue') +
  geom_point(stat = 'summary', fun.y = median, color = 'blue') +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor da licitação (mil reais)", title = "Valor médio e mediano das licitações de merenda por ano")
```

É percebido que a média sempre está acima da mediana o que pode indicar que alguns valores extremos estão influenciando a média fazendo com que ela não seja uma medida precisa dos dados. É também notado que tanto a média quando a mediana crescem ao longo dos anos, ou seja, em geral o valor da licitação relacionada a merenda vem aumentando. Em 2014, há a maior diferença entre a média e a mediana provavelmente neste ano algumas licitações com merendas tiveram um alto valor com relação as demais.

## O valor médio da licitação alterou ao longo dos anos com relação aos tipos de licitação?
```{r}
ggplot(aes(x = dt_Ano, y = vl_Licitacao/1000, color = tp_Licitacao), data = licitacoes_merenda) +
  geom_point(stat = "summary", fun.y = "mean") +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous(breaks = seq(2010, 2016, 1)) +
  scale_y_continuous(breaks = seq(0, 500, 100)) +
  labs(x = "Ano", y = "Valor médio das licitações (mil reais)", title = "Valor médio das licitações por tipo de licitação ao longo dos anos", color = "Tipo de licitação")
```

Observa-se que alguns tipos de licitação não possuem valores médios em alguns anos, isso ocorre porque não houve licitações daquele tipo naquele ano. Alguns tipos de licitações se destacam por seu valor médio parecido e acima dos demais, são elas: Pregão Presencial, Adesão a Registro de Preço e Chamada Pública.


```{r}
library(maps) #mapas simples, eixos, escala, cidades 
library(ggmap) #Gmaps, OSM + mapas baseados em ggplot2
library(rgdal)
```

```{r}
utils = src_mysql('utils', group='ministerio-publico', password=NULL)

municipios = tbl(utils, 'municipio') %>%
  collect()
```


```{r}
mapa_paraiba <- readOGR("./Municipios/Municipios.shp")
```

```{r}
levels_mapa = levels(mapa_paraiba@data$Nome_Munic)
levels_mapa[51] = "Tacima"
levels_mapa[200] = "Sao Vicente do Serido"
levels_mapa[173] = "Joca Claudino"
levels(mapa_paraiba@data$Nome_Munic) = levels_mapa 

municipios$de_Municipio[199] = 'Sao Vicente do Serido'
```

```{r}
# Só há 220 códigos (cidades) presentes nos dados que temos
merenda_paraiba = licitacoes_merenda %>%
  left_join(municipios, 'cd_Municipio')


mapa_paraiba@data$Nome_Munic = as.character(mapa_paraiba@data$Nome_Munic)
paraiba = mapa_paraiba@data %>% inner_join(merenda_paraiba, c('Nome_Munic' = 'de_Municipio'))

#paraiba$Nome_Munic = factor(paraiba$Nome_Munic)

paraiba_sumarizado = paraiba %>%
  group_by(Nome_Munic) %>%
  summarize(total = n())

# Imputação de dados
data_temp = data.frame(Nome_Munic = c('Mato Grosso', 'Nova Floresta', 'Mamanguape'),
                       total = c(0, 0, 0))
paraiba_sumarizado = rbind(paraiba_sumarizado, data_temp)

# 
paraiba_sumarizado$total = cut(paraiba_sumarizado$total, 
                               breaks = c(0,5,10,15,20,25,30,40,50,70), 
                               include.lowest = T)

mapa_paraiba@data$Index = row.names(mapa_paraiba@data)

mapa_paraiba@data = mapa_paraiba@data[order(as.numeric(mapa_paraiba@data$Index)),]

mapa_paraiba@data= mapa_paraiba@data %>% 
  left_join(paraiba_sumarizado, 'Nome_Munic')
```

```{r}

mapa_paraiba@data$Y <- mapa_paraiba@data$total
mapa_paraiba@data$X <- mapa_paraiba@data$Nome_Munic
spplot(mapa_paraiba, 'Y')
```


























